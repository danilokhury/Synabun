<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Neural Memory Interface</title>
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
<style>
  /* ═══════════════════════════════════════════
     RESET & BASE
     ═══════════════════════════════════════════ */
  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    /* ── Text ── */
    --t-faint: rgba(255,255,255,0.2);
    --t-muted: rgba(255,255,255,0.3);
    --t-secondary: rgba(255,255,255,0.5);
    --t-primary: rgba(255,255,255,0.7);
    --t-bright: rgba(255,255,255,0.9);
    /* ── Surfaces ── */
    --s-transparent: transparent;
    --s-subtle: rgba(255,255,255,0.04);
    --s-light: rgba(255,255,255,0.06);
    --s-medium: rgba(255,255,255,0.10);
    --s-hover: rgba(255,255,255,0.08);
    --s-active: rgba(255,255,255,0.14);
    --s-panel: rgba(28,28,30,0.85);
    /* ── Borders ── */
    --b-subtle: rgba(255,255,255,0.06);
    --b-light: rgba(255,255,255,0.10);
    --b-hover: rgba(255,255,255,0.16);
    --b-visible: rgba(255,255,255,0.22);
    /* ── Accents ── */
    --accent-blue: #4FC3F7;
    --accent-blue-bg: rgba(79,195,247,0.10);
    --accent-blue-border: rgba(79,195,247,0.25);
    --accent-gold: rgba(255,215,0,0.85);
    --accent-gold-bg: rgba(255,215,0,0.10);
    --accent-gold-border: rgba(255,215,0,0.22);
    --accent-red: #FF5252;
    --accent-red-bg: rgba(255,82,82,0.15);
    --accent-red-hover: rgba(255,82,82,0.30);
    --accent-orange: #FFB74D;
    --accent-orange-bg: rgba(255,183,77,0.10);
    /* ── Radii ── */
    --r-pill: 20px;
    --r-button: 10px;
    --r-card: 8px;
    --r-circle: 50%;
    --r-small: 6px;
    /* ── Font sizes ── */
    --fs-xs: 12px;
    --fs-sm: 13px;
    --fs-md: 14px;
    --fs-base: 15px;
    --fs-lg: 16px;
    /* ── Transitions ── */
    --ease: 0.2s ease;
    /* ── UI Scale ── */
    --ui-scale: 1;
  }

  body {
    background: #050505;
    color: #e0e0e0;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    overflow: hidden;
    height: 100vh;
    width: 100vw;
  }

  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }

  /* ═══════════════════════════════════════════
     GLASSMORPHISM BASE
     ═══════════════════════════════════════════ */
  .glass {
    background: rgba(28, 28, 30, 0.72);
    backdrop-filter: blur(40px) saturate(1.4);
    -webkit-backdrop-filter: blur(40px) saturate(1.4);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 14px;
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.4), inset 0 0.5px 0 rgba(255, 255, 255, 0.05);
  }

  /* UI scale — applied to all glass overlay panels */
  #category-sidebar,
  #detail-panel,
  #stats-bar,
  .settings-panel {
    transform: scale(var(--ui-scale, 1));
    transform-origin: top left;
  }
  /* Detail panel anchors from the right */
  #detail-panel { transform-origin: top right; }

  /* Resizable panels now use JavaScript-based viewport clamping */
  .resizable {
    overflow-y: auto;
    box-sizing: border-box;
  }

  /* ═══════════════════════════════════════════
     GRAPH CONTAINER
     ═══════════════════════════════════════════ */
  #graph-container {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1;
  }

  /* ═══════════════════════════════════════════
     TOP MENU BAR (full-width unified)
     ═══════════════════════════════════════════ */
  #title-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 100;
    padding: 10px 18px;
    display: flex;
    align-items: center;
    gap: 12px;
    background: rgba(18, 18, 20, 0.65);
    backdrop-filter: blur(40px) saturate(1.4);
    -webkit-backdrop-filter: blur(40px) saturate(1.4);
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    border-radius: 0;
    box-shadow: 0 1px 12px rgba(0, 0, 0, 0.3);
  }

  #title-bar .bar-left {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }

  #title-bar .bar-center {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 8px;
    min-width: 0;
  }

  #title-bar .bar-right {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }

  /* Thin separator between sections */
  #title-bar .bar-sep {
    width: 1px;
    height: 20px;
    background: rgba(255, 255, 255, 0.06);
    flex-shrink: 0;
  }

  .pin-btn {
    background: var(--s-subtle);
    border: 1px solid var(--b-subtle);
    color: var(--t-muted);
    cursor: pointer;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--r-circle);
    transition: all 0.2s;
    padding: 0;
    position: absolute;
    top: 10px;
    right: 10px;
    z-index: 11;
    opacity: 0;
  }
  .pin-btn svg {
    width: 14px;
    height: 14px;
    stroke: rgba(255,255,255,0.35);
    fill: none;
    stroke-width: 2;
    transition: all 0.2s;
    transform: rotate(45deg);
  }
  .resizable:hover .pin-btn { opacity: 1; }
  .pin-btn:hover {
    background: var(--s-hover);
    color: var(--t-primary);
    border-color: var(--b-light);
  }
  .pin-btn:hover svg { stroke: rgba(255,255,255,0.6); }
  .pin-btn.pinned {
    opacity: 1;
    background: var(--s-medium);
    border-color: var(--b-hover);
  }
  .pin-btn.pinned svg {
    stroke: rgba(255,255,255,0.7);
    fill: rgba(255,255,255,0.15);
    transform: rotate(0deg);
  }

  .detail-header .pin-btn {
    position: relative !important;
    top: auto !important;
    right: auto !important;
    opacity: 1 !important;
    width: 26px;
    height: 26px;
  }

  #title-bar h1 {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.65);
  }

  /* ── Pill buttons (links, type, reset) ── */
  .bar-pill {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.06);
    color: var(--t-muted);
    font-size: 12px;
    font-weight: 500;
    font-family: inherit;
    letter-spacing: 0.04em;
    padding: 5px 12px;
    border-radius: var(--r-pill);
    cursor: pointer;
    transition: all var(--ease);
    white-space: nowrap;
  }
  .bar-pill:hover {
    background: rgba(255, 255, 255, 0.06);
    color: var(--t-primary);
    border-color: rgba(255, 255, 255, 0.1);
  }
  .bar-pill:active {
    background: var(--s-active);
    transform: scale(0.96);
  }
  .bar-pill.active {
    background: rgba(255, 255, 255, 0.08);
    color: var(--t-primary);
    border-color: rgba(255, 255, 255, 0.1);
  }

  /* ── Icon-only buttons in top bar ── */
  .bar-icon {
    background: transparent;
    border: 1px solid transparent;
    color: var(--t-muted);
    width: 28px;
    height: 28px;
    border-radius: var(--r-circle);
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    flex-shrink: 0;
    position: relative;
  }
  .bar-icon:hover {
    background: rgba(255, 255, 255, 0.06);
    color: var(--t-primary);
  }
  .bar-icon svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
  }
  .bar-icon .count-badge {
    position: absolute;
    top: -3px;
    right: -3px;
    font-size: 8px;
    min-width: 12px;
    height: 12px;
    padding: 0 3px;
    line-height: 12px;
  }

  /* ═══════════════════════════════════════════
     HELP BUTTON + MODAL
     (help, settings, trash now use .bar-icon class)
     ═══════════════════════════════════════════ */
  #help-btn {
    font-size: 12px;
    font-weight: 600;
  }

  #help-overlay {
    position: fixed;
    inset: 0;
    z-index: 500;
    background: rgba(0, 0, 0, 0.35);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: none;
    align-items: center;
    justify-content: center;
    animation: helpFadeIn 0.15s ease-out;
  }
  #help-overlay.open { display: flex; }

  @keyframes helpFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  #help-modal {
    width: 480px;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
    padding: 28px 30px;
    animation: helpSlideIn 0.2s ease-out;
  }

  @keyframes helpSlideIn {
    from { opacity: 0; transform: translateY(10px) scale(0.98); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  #help-modal h2 {
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.55);
    margin-bottom: 20px;
  }

  .help-section {
    margin-bottom: 20px;
  }

  .help-section-title {
    font-size: 12px;
    font-weight: 600;
    letter-spacing: 0.18em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.3);
    margin-bottom: 10px;
    padding-bottom: 6px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  }

  .help-row {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    padding: 5px 0;
  }

  .help-keys {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  .help-key {
    font-family: 'JetBrains Mono', 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
    font-size: 12px;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.7);
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 5px;
    padding: 2px 8px;
    white-space: nowrap;
  }

  .help-desc {
    font-size: 13px;
    color: rgba(255, 255, 255, 0.45);
    text-align: right;
    flex: 1;
    margin-left: 16px;
  }

  #help-close {
    position: absolute;
    top: 14px;
    right: 14px;
    background: rgba(255, 255, 255, 0.06);
    border: none;
    color: rgba(255, 255, 255, 0.3);
    cursor: pointer;
    font-size: 18px;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s;
  }
  #help-close:hover {
    color: rgba(255, 255, 255, 0.7);
    background: rgba(255, 255, 255, 0.1);
  }

  /* ═══════════════════════════════════════════
     BOOKMARKS
     ═══════════════════════════════════════════ */
  /* ── Toolbar buttons (shared) ── */
  .toolbar-btn {
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.06);
    color: var(--t-muted);
    font-size: 12px;
    font-weight: 500;
    font-family: inherit;
    letter-spacing: 0.02em;
    padding: 5px 12px;
    border-radius: var(--r-pill);
    cursor: pointer;
    transition: all var(--ease);
    white-space: nowrap;
    flex-shrink: 0;
    display: flex;
    align-items: center;
    gap: 5px;
    position: relative;
  }
  .toolbar-btn:hover {
    background: rgba(255, 255, 255, 0.06);
    color: var(--t-primary);
    border-color: rgba(255, 255, 255, 0.1);
  }
  .toolbar-btn:active { transform: scale(0.97); }
  .toolbar-btn.active {
    background: rgba(255, 255, 255, 0.08);
    color: var(--t-primary);
    border-color: rgba(255, 255, 255, 0.1);
  }
  .toolbar-btn svg {
    width: 12px; height: 12px;
    fill: none;
    stroke: currentColor;
    stroke-width: 1.8;
  }
  /* ── Collections tab (settings modal) ── */
  .conn-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
    margin-bottom: 12px;
  }
  .conn-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    border-radius: var(--r-card);
    background: var(--s-subtle);
    border: 1px solid var(--b-subtle);
    transition: all var(--ease);
    cursor: pointer;
  }
  .conn-item:hover {
    background: var(--s-hover);
    border-color: var(--b-hover);
  }
  .conn-item.active {
    background: var(--s-medium);
    border-color: rgba(255,255,255,0.2);
  }
  .conn-item-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--r-circle);
    background: var(--t-muted);
    flex-shrink: 0;
    transition: all var(--ease);
  }
  .conn-item.active .conn-item-dot {
    background: var(--t-bright);
  }
  .conn-item-info {
    flex: 1;
    min-width: 0;
  }
  .conn-item-name {
    font-size: var(--fs-sm);
    font-weight: 500;
    color: var(--t-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .conn-item.active .conn-item-name { color: var(--t-bright); }
  .conn-item-meta {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-family: 'JetBrains Mono', monospace;
  }
  .conn-item.active .conn-item-meta { color: var(--t-secondary); }
  .conn-item-count {
    font-size: var(--fs-xs);
    color: var(--t-secondary);
    background: var(--s-medium);
    padding: 2px 8px;
    border-radius: var(--r-pill);
    flex-shrink: 0;
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
  }
  .conn-item.active .conn-item-count {
    background: rgba(255,255,255,0.12);
    color: var(--t-bright);
  }
  .conn-item-delete {
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--t-muted);
    cursor: pointer;
    border-radius: var(--r-circle);
    opacity: 0;
    transition: all var(--ease);
    flex-shrink: 0;
    padding: 0;
  }
  .conn-item:hover .conn-item-delete { opacity: 0.6; }
  .conn-item-delete:hover { opacity: 1 !important; color: var(--accent-red); background: rgba(255,82,82,0.1); }
  .conn-item-delete svg { width: 12px; height: 12px; fill: none; stroke: currentColor; stroke-width: 2; }
  .conn-item-action {
    width: 22px; height: 22px;
    display: flex; align-items: center; justify-content: center;
    background: none; border: none; color: var(--t-muted);
    cursor: pointer; border-radius: var(--r-circle);
    opacity: 0.5; transition: all var(--ease);
    flex-shrink: 0; padding: 0;
  }
  .conn-item:hover .conn-item-action { opacity: 0.8; }
  .conn-item-action:hover { opacity: 1 !important; color: var(--accent-blue); background: rgba(79,195,247,0.1); }
  .conn-item-action svg { width: 12px; height: 12px; fill: none; stroke: currentColor; stroke-width: 2; }
  .conn-item-action.restoring,
  .conn-item-action.backing-up { opacity: 0.8 !important; pointer-events: none; }
  .conn-item-action.restoring svg,
  .conn-item-action.backing-up svg {
    animation: dep-spin 0.7s linear infinite;
  }
  .conn-item.unreachable {
    opacity: 0.5;
    border-style: dashed;
  }
  .conn-item.unreachable .conn-item-dot {
    background: var(--accent-red, #ef5350);
    opacity: 0.6;
  }
  .conn-item.unreachable .conn-item-name::after {
    content: ' (offline)';
    font-size: var(--fs-xs);
    color: var(--t-muted);
    font-weight: 400;
  }
  .conn-item-start {
    width: 22px; height: 22px;
    display: flex; align-items: center; justify-content: center;
    background: none; border: none; color: var(--accent-green, #66bb6a);
    cursor: pointer; border-radius: var(--r-circle);
    opacity: 0.7; transition: all var(--ease);
    flex-shrink: 0; padding: 0;
  }
  .conn-item-start:hover {
    opacity: 1;
    background: rgba(102,187,106,0.12);
  }
  .conn-item-start svg {
    width: 12px; height: 12px; fill: none; stroke: currentColor; stroke-width: 2;
  }
  .conn-item-start:disabled {
    pointer-events: none; opacity: 0.5;
  }
  .conn-add-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    width: 100%;
    padding: 8px;
    border-radius: var(--r-card);
    background: var(--s-subtle);
    border: 1px dashed var(--b-subtle);
    color: var(--t-muted);
    font-size: var(--fs-sm);
    font-family: inherit;
    cursor: pointer;
    transition: all var(--ease);
  }
  .conn-add-btn:hover {
    background: var(--s-hover);
    border-color: var(--b-hover);
    color: var(--t-primary);
  }
  .conn-add-btn svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; }
  .conn-empty {
    text-align: center;
    padding: 20px;
    color: var(--t-muted);
    font-size: var(--fs-sm);
  }

  /* ── Bridge connection item variant ── */

  /* ── Add Collection Wizard ── */
  .conn-wizard-overlay {
    position: fixed; inset: 0; z-index: 10001;
    background: rgba(0,0,0,0.65);
    backdrop-filter: blur(20px) saturate(0.8);
    -webkit-backdrop-filter: blur(20px) saturate(0.8);
    display: flex; align-items: center; justify-content: center;
    animation: tagModalFadeIn 0.15s ease-out;
  }
  .conn-wizard-panel {
    width: 520px; max-height: 85vh;
    background: rgba(18,18,22,0.88);
    backdrop-filter: blur(40px) saturate(1.4);
    -webkit-backdrop-filter: blur(40px) saturate(1.4);
    border: 1px solid rgba(255,255,255,0.07);
    border-radius: 16px;
    box-shadow: 0 2px 32px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.04);
    display: flex; flex-direction: column; overflow: hidden;
    animation: tagModalScaleIn 0.18s ease-out;
  }
  .conn-wizard-viewport {
    position: relative; overflow: hidden;
    transition: height 0.38s cubic-bezier(0.4,0,0.2,1);
  }
  .conn-wizard-step {
    position: absolute; top: 0; left: 0; right: 0;
    padding: 28px 32px;
    display: flex; flex-direction: column;
    transition: transform 0.38s cubic-bezier(0.4,0,0.2,1), opacity 0.28s ease;
    overflow-y: auto;
  }
  .conn-wizard-step.active { transform: translateX(0); opacity: 1; z-index: 2; }
  .conn-wizard-step.left   { transform: translateX(-100%); opacity: 0; z-index: 1; }
  .conn-wizard-step.right  { transform: translateX(100%); opacity: 0; z-index: 1; }
  .conn-wizard-step h3 {
    font-size: 16px; font-weight: 600; color: var(--t-bright);
    margin-bottom: 5px; letter-spacing: -0.2px;
  }
  .conn-wizard-step .wiz-subtitle {
    font-size: 12px; color: var(--t-secondary);
    margin-bottom: 22px; line-height: 1.5;
  }
  .wiz-mode-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 4px; }
  .wiz-mode-card {
    padding: 16px; border: 1px solid var(--b-light);
    border-radius: var(--r-card); background: var(--s-subtle);
    cursor: pointer; transition: all 0.22s ease; text-align: center;
  }
  .wiz-mode-card:hover { background: var(--s-hover); border-color: var(--b-hover); transform: translateY(-1px); }
  .wiz-mode-card.selected {
    border-color: var(--accent-blue-border); background: var(--accent-blue-bg);
    box-shadow: 0 0 0 1px var(--accent-blue-border);
  }
  .wiz-mode-card .wmc-icon {
    width: 28px; height: 28px; margin: 0 auto 8px; stroke: var(--t-muted);
    fill: none; stroke-width: 1.5; transition: stroke 0.2s;
  }
  .wiz-mode-card.selected .wmc-icon { stroke: var(--accent-blue); }
  .wiz-mode-card .wmc-title { font-size: 13px; font-weight: 600; color: var(--t-bright); }
  .wiz-mode-card .wmc-desc { font-size: 11px; color: var(--t-muted); margin-top: 3px; line-height: 1.4; }
  .wiz-field { margin-bottom: 14px; }
  .wiz-field label {
    display: block; font-size: 11px; font-weight: 600;
    color: var(--t-secondary); margin-bottom: 6px;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .wiz-field input[type="text"],
  .wiz-field input[type="number"],
  .wiz-field input[type="password"] {
    width: 100%; box-sizing: border-box;
    font-size: var(--fs-sm); font-family: 'JetBrains Mono', monospace;
    padding: 8px 10px; border-radius: var(--r-small);
    background: var(--s-subtle); color: var(--t-bright);
    border: 1px solid var(--b-light); outline: none;
    transition: border-color var(--ease);
  }
  .wiz-field input:focus { border-color: var(--accent-blue-border); }
  .wiz-field .wiz-hint { font-size: 11px; color: var(--t-muted); margin-top: 4px; line-height: 1.4; }
  .wiz-field .wiz-error { font-size: 11px; color: var(--accent-red); margin-top: 4px; display: none; }
  .wiz-field .wiz-error.visible { display: block; }
  .wiz-row { display: flex; gap: 8px; }
  .wiz-row .wiz-field { flex: 1; }
  .wiz-input-row { display: flex; gap: 6px; }
  .wiz-input-row input { flex: 1; }
  .wiz-generate-btn {
    padding: 8px 12px; border-radius: var(--r-small);
    border: 1px solid var(--b-light); background: var(--s-light);
    color: var(--t-primary); font-size: 11px; font-family: inherit;
    cursor: pointer; white-space: nowrap; transition: all var(--ease); flex-shrink: 0;
  }
  .wiz-generate-btn:hover { background: var(--s-medium); color: var(--t-bright); border-color: var(--b-hover); }
  .wiz-terminal {
    background: rgba(0,0,0,0.3); border: 1px solid var(--b-subtle);
    border-radius: var(--r-small); padding: 10px 12px;
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    color: var(--t-secondary); max-height: 120px;
    overflow-y: auto; white-space: pre-wrap; word-break: break-all;
    line-height: 1.5; margin: 10px 0;
  }
  .wiz-status {
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; color: var(--t-primary); margin-bottom: 8px;
  }
  .wiz-status-dot {
    width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
  }
  .wiz-status-dot.green { background: #6dd58c; box-shadow: 0 0 6px rgba(109,213,140,0.4); }
  .wiz-status-dot.red { background: var(--accent-red); }
  .wiz-status-dot.spin {
    border: 2px solid rgba(79,195,247,0.25);
    border-top-color: var(--accent-blue);
    animation: dep-spin 0.7s linear infinite;
    width: 9px; height: 9px; background: none;
  }
  .wiz-action-btn {
    padding: 10px 20px; border-radius: var(--r-small);
    border: 1px solid var(--accent-blue-border);
    background: var(--accent-blue-bg); color: var(--accent-blue);
    font-size: 12px; font-weight: 600; font-family: inherit;
    cursor: pointer; transition: all var(--ease); width: 100%;
  }
  .wiz-action-btn:hover { background: rgba(79,195,247,0.16); border-color: rgba(79,195,247,0.35); }
  .wiz-action-btn:disabled { opacity: 0.4; pointer-events: none; }
  .wiz-summary-card {
    border: 1px solid var(--b-light); border-radius: var(--r-card);
    background: var(--s-subtle); padding: 16px 18px; margin-bottom: 16px;
  }
  .wiz-summary-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 6px 0; font-size: 12px;
  }
  .wiz-summary-row + .wiz-summary-row { border-top: 1px solid var(--b-subtle); }
  .wiz-summary-row .wsr-label { color: var(--t-muted); }
  .wiz-summary-row .wsr-value { color: var(--t-bright); font-family: 'JetBrains Mono', monospace; font-size: 11px; }
  .conn-wizard-nav {
    padding: 12px 20px; display: flex; align-items: center;
    justify-content: space-between;
    border-top: 1px solid rgba(255,255,255,0.05);
    background: rgba(0,0,0,0.2); flex-shrink: 0;
  }
  .wiz-dots { display: flex; gap: 3px; }
  .wiz-dot {
    width: 14px; height: 3px; border-radius: 1px;
    background: rgba(255,255,255,0.08); transition: all 0.3s ease;
  }
  .wiz-dot.active { background: var(--accent-blue); box-shadow: 0 0 6px rgba(79,195,247,0.4); }
  .wiz-dot.done { background: rgba(79,195,247,0.25); }
  .wiz-nav-btn {
    padding: 6px 14px; border-radius: var(--r-small);
    border: 1px solid var(--b-subtle); background: var(--s-subtle);
    color: var(--t-muted); font-size: 11px; font-family: inherit;
    cursor: pointer; transition: all var(--ease); letter-spacing: 0.04em;
  }
  .wiz-nav-btn:hover { color: var(--t-bright); background: var(--s-hover); border-color: var(--b-hover); }
  .wiz-nav-btn:disabled { opacity: 0; pointer-events: none; }
  .wiz-nav-btn.primary {
    background: var(--accent-blue-bg); border-color: var(--accent-blue-border);
    color: var(--accent-blue);
  }
  .wiz-nav-btn.primary:hover { background: rgba(79,195,247,0.16); border-color: rgba(79,195,247,0.35); }
  .wiz-nav-btn.primary:disabled { opacity: 0.4; pointer-events: none; }

  /* ── Claude Code integration ── */
  .cc-integration-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: var(--r-small);
    background: transparent;
    border: 1px solid transparent;
    transition: all var(--ease);
  }
  .cc-integration-item + .cc-integration-item { margin-top: 6px; }
  .cc-integration-item:hover { background: var(--s-subtle); }
  .cc-integration-item.enabled {
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.12);
  }
  .cc-integration-info { flex: 1; min-width: 0; }
  .cc-integration-label {
    font-size: var(--fs-sm);
    font-weight: 500;
    color: var(--t-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cc-integration-item.enabled .cc-integration-label { color: var(--t-bright); }
  .cc-integration-path {
    font-size: 11px;
    color: var(--t-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cc-toggle {
    position: relative;
    width: 36px;
    height: 20px;
    background: rgba(255,255,255,0.06);
    border: 1px solid var(--b-subtle);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.25s ease;
    flex-shrink: 0;
    padding: 0;
  }
  .cc-toggle::after {
    content: '';
    position: absolute;
    top: 2px;
    left: 2px;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--t-muted);
    transition: all 0.25s ease;
  }
  .cc-toggle.on {
    background: rgba(255,255,255,0.14);
    border-color: rgba(255,255,255,0.22);
  }
  .cc-toggle.on::after {
    left: 18px;
    background: rgba(255,255,255,0.85);
    box-shadow: 0 0 4px rgba(255,255,255,0.15);
  }
  .cc-skill-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: var(--r-small);
    background: transparent;
    border: 1px solid transparent;
    transition: all var(--ease);
  }
  .cc-skill-row + .cc-skill-row { margin-top: 6px; }
  .cc-skill-row:hover { background: var(--s-subtle); }
  .cc-skill-row.installed {
    background: rgba(255,255,255,0.06);
    border-color: rgba(255,255,255,0.12);
  }
  .cc-skill-info { flex: 1; min-width: 0; display: flex; align-items: baseline; gap: 8px; }
  .cc-skill-name {
    font-size: var(--fs-sm);
    font-weight: 500;
    color: var(--t-secondary);
    white-space: nowrap;
  }
  .cc-skill-row.installed .cc-skill-name { color: var(--t-bright); }
  .cc-skill-desc {
    font-size: 11px;
    color: var(--t-muted);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cc-toast {
    position: fixed;
    bottom: 24px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--s-dark);
    border: 1px solid var(--s-medium);
    color: var(--text);
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 13px;
    z-index: 100000;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }
  .cc-toast.show { opacity: 1; }
  .cc-remove-btn {
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    color: var(--t-muted);
    cursor: pointer;
    border-radius: var(--r-circle);
    opacity: 0;
    transition: all var(--ease);
    flex-shrink: 0;
    padding: 0;
  }
  .cc-integration-item:hover .cc-remove-btn { opacity: 0.6; }
  .cc-remove-btn:hover { opacity: 1 !important; color: var(--accent-red); background: rgba(255,82,82,0.1); }
  .cc-remove-btn svg { width: 12px; height: 12px; fill: none; stroke: currentColor; stroke-width: 2; }
  .cc-section-label {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    font-weight: 700;
    color: var(--t-faint);
    margin-top: 20px;
    margin-bottom: 8px;
    padding-bottom: 5px;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .cc-section-label:first-child { margin-top: 0; }
  .cc-hint {
    font-size: 11px;
    color: var(--t-faint);
    margin-top: 4px;
    line-height: 1.45;
  }

  /* Collapsible connection panels */
  .cc-panel {
    border: 1px solid var(--b-light);
    border-radius: var(--r-card);
    background: rgba(255,255,255,0.02);
    overflow: hidden;
    transition: border-color 0.2s, background 0.2s;
  }
  .cc-panel + .cc-panel { margin-top: 6px; }
  .cc-panel.enabled {
    border-color: rgba(255,255,255,0.14);
    background: rgba(255,255,255,0.03);
  }
  .cc-panel-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 10px 12px;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s;
  }
  .cc-panel-header:hover { background: rgba(255,255,255,0.03); }
  .cc-panel-chevron {
    width: 12px;
    height: 12px;
    flex-shrink: 0;
    fill: none;
    stroke: var(--t-muted);
    stroke-width: 2;
    stroke-linecap: round;
    stroke-linejoin: round;
    transition: transform 0.2s;
  }
  .cc-panel.open .cc-panel-chevron { transform: rotate(90deg); }
  .cc-panel-title {
    flex: 1;
    min-width: 0;
    font-size: var(--fs-sm);
    font-weight: 600;
    color: var(--t-primary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .cc-panel.enabled .cc-panel-title { color: var(--t-bright); }
  .cc-panel-status {
    font-size: 11px;
    padding: 2px 8px;
    border-radius: var(--r-pill);
    font-weight: 600;
    letter-spacing: 0.3px;
    flex-shrink: 0;
  }
  .cc-panel-status.active {
    background: rgba(255,255,255,0.08);
    color: var(--t-bright);
  }
  .cc-panel-status.inactive {
    background: rgba(255,255,255,0.04);
    color: var(--t-muted);
  }
  .cc-panel-body {
    display: none;
    padding: 4px 14px 16px;
  }
  .cc-panel.open .cc-panel-body { display: block; }
  .cc-panel-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 0;
  }
  .cc-panel-row + .cc-panel-row {
    border-top: 1px solid rgba(255,255,255,0.03);
  }
  .cc-panel-row-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    color: var(--t-muted);
    font-weight: 600;
  }
  .cc-panel-row-value {
    font-size: var(--fs-xs);
    color: var(--t-secondary);
    font-family: 'JetBrains Mono', monospace;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 60%;
    text-align: right;
  }
  .cc-panel-actions {
    display: flex;
    align-items: center;
    gap: 6px;
    padding-top: 8px;
    margin-top: 4px;
    border-top: 1px solid var(--b-subtle);
  }
  .cc-panel-actions button {
    flex: 1;
    padding: 5px 0;
    font-size: var(--fs-xs);
    font-weight: 500;
    font-family: inherit;
    border-radius: var(--r-small);
    cursor: pointer;
    transition: background 0.15s, border-color 0.15s;
  }
  .cc-panel-actions .cc-enable-btn {
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: var(--t-primary);
  }
  .cc-panel-actions .cc-enable-btn:hover {
    background: rgba(255,255,255,0.1);
  }
  .cc-panel-actions .cc-enable-btn.on {
    background: rgba(255,255,255,0.10);
    border-color: rgba(255,255,255,0.20);
    color: var(--t-bright);
  }
  .cc-panel-actions .cc-disable-btn {
    background: rgba(255,82,82,0.08);
    border: 1px solid rgba(255,82,82,0.2);
    color: var(--accent-red);
  }
  .cc-panel-actions .cc-disable-btn:hover {
    background: rgba(255,82,82,0.15);
  }
  .cc-panel-actions .cc-remove-panel-btn {
    background: none;
    border: 1px solid var(--b-subtle);
    color: var(--t-muted);
  }
  .cc-panel-actions .cc-remove-panel-btn:hover {
    color: var(--accent-red);
    border-color: rgba(255,82,82,0.3);
    background: rgba(255,82,82,0.08);
  }

  .toolbar-btn svg {
    width: 14px; height: 14px;
    fill: none;
    stroke: currentColor;
    stroke-width: 1.8;
    stroke-linejoin: round;
    flex-shrink: 0;
  }

  /* ── Count badges (shared) ── */
  .count-badge {
    font-size: var(--fs-xs);
    font-weight: 600;
    padding: 1px 6px;
    border-radius: var(--r-pill);
    min-width: 16px;
    text-align: center;
    line-height: 1.5;
  }
  .count-badge:empty { display: none; }
  .count-badge--gold {
    background: var(--accent-gold-bg);
    color: var(--accent-gold);
  }
  .count-badge--blue {
    background: var(--accent-blue-bg);
    color: var(--accent-blue);
  }
  .count-badge--muted {
    background: var(--s-light);
    color: var(--t-secondary);
  }
  .count-badge--red {
    background: var(--accent-red-bg);
    color: var(--accent-red);
  }

  /* ── Dropdown panels (shared) ── */
  .dropdown-panel {
    position: absolute;
    top: 100%;
    right: 0;
    margin-top: 16px;
    z-index: 101;
    width: 340px;
    padding: 12px;
    display: none;
    animation: dropdownFadeIn 0.15s ease-out;
  }
  .dropdown-panel.open { display: block; }
  @keyframes dropdownFadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .dropdown-empty {
    text-align: center;
    color: var(--t-faint);
    font-size: var(--fs-md);
    padding: 20px 10px;
    line-height: 1.7;
  }

  /* ── Dropdown list items (shared) ── */
  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: var(--r-card);
    cursor: pointer;
    transition: background 0.15s;
  }
  .dropdown-item:hover { background: var(--s-hover); }
  .dropdown-item-dot {
    width: 8px; height: 8px;
    border-radius: var(--r-circle);
    flex-shrink: 0;
  }
  .dropdown-item-text {
    flex: 1;
    min-width: 0;
  }
  .dropdown-item-title {
    font-size: var(--fs-md);
    font-weight: 500;
    color: var(--t-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .dropdown-item:hover .dropdown-item-title { color: var(--t-primary); }
  .dropdown-item-sub {
    font-size: var(--fs-xs);
    color: var(--t-faint);
    text-transform: uppercase;
    letter-spacing: 0.4px;
    margin-top: 1px;
  }

  /* ── Trash window (floating panel like settings) ── */
  .trash-window {
    position: fixed;
    z-index: 300;
    width: 560px;
    max-width: 92vw;
    min-width: 360px;
    min-height: 340px;
    max-height: 80vh;
    animation: tagModalScaleIn 0.15s ease-out;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.10);
  }
  .trash-window.dragging { transition: none; }
  .trash-window-header {
    display: flex !important;
    align-items: center !important;
    justify-content: flex-start !important;
    padding: 12px 14px !important;
    margin: 0 !important;
    border-bottom: 1px solid var(--b-subtle);
    gap: 10px;
    flex-shrink: 0;
    min-height: 44px;
    box-sizing: border-box;
  }
  .trash-window-header h3 {
    flex: 1;
    font-size: 13px;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    font-weight: 500;
    color: rgba(255,255,255,0.45);
    margin: 0;
    pointer-events: none;
    line-height: 1;
  }
  .trash-window-header h3 .tw-h-count {
    font-size: 10px;
    letter-spacing: 0.05em;
    color: var(--t-muted);
    margin-left: 6px;
    font-weight: 400;
  }
  .trash-window-header .pin-btn {
    position: relative !important;
    top: auto !important;
    right: auto !important;
    opacity: 1 !important;
    flex-shrink: 0;
  }
  .trash-window-close {
    width: 26px; height: 26px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: none;
    color: var(--t-muted); cursor: pointer;
    border-radius: var(--r-circle);
    font-size: 18px; line-height: 1;
    transition: all var(--ease);
    padding: 0; flex-shrink: 0;
  }
  .trash-window-close:hover { color: var(--t-bright); background: var(--s-hover); }
  .trash-window.locked .trash-window-header { cursor: default; }
  .trash-window-body {
    display: flex;
    flex: 1;
    overflow: hidden;
    min-height: 0;
  }
  .trash-list-pane {
    width: 220px;
    flex-shrink: 0;
    border-right: 1px solid var(--b-subtle);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .trash-list-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 10px;
    border-bottom: 1px solid var(--b-subtle);
    flex-shrink: 0;
  }
  .trash-list-header span {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    font-weight: 500;
  }
  .trash-purge-btn {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: var(--r-small);
    border: 1px solid rgba(180,70,70,0.25);
    background: rgba(140,50,50,0.18);
    color: rgba(220,130,130,0.85);
    cursor: pointer;
    font-family: inherit;
    font-weight: 500;
    transition: all var(--ease);
  }
  .trash-purge-btn:hover { background: rgba(140,50,50,0.30); color: rgba(230,150,150,0.95); }
  .trash-list-scroll {
    flex: 1;
    overflow-y: auto;
  }
  .trash-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 10px;
    border-bottom: 1px solid var(--b-subtle);
    cursor: pointer;
    transition: background var(--ease);
  }
  .trash-item:hover { background: var(--s-hover); }
  .trash-item:last-child { border-bottom: none; }
  .trash-item.active { background: var(--s-active); }
  .trash-item-content {
    flex: 1;
    min-width: 0;
  }
  .trash-item-preview {
    font-size: var(--fs-xs);
    color: var(--t-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    line-height: 1.35;
  }
  .trash-item-meta {
    font-size: 10px;
    color: var(--t-muted);
    margin-top: 1px;
  }
  .trash-detail-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    min-width: 0;
  }
  .trash-detail-header {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 14px;
    border-bottom: 1px solid var(--b-subtle);
    flex-shrink: 0;
  }
  .trash-detail-cat {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    font-weight: 500;
    flex: 1;
  }
  .trash-detail-actions { display: flex; gap: 4px; }
  .trash-detail-actions button {
    font-size: var(--fs-xs);
    font-family: inherit;
    font-weight: 500;
    padding: 4px 10px;
    border-radius: var(--r-small);
    cursor: pointer;
    transition: all var(--ease);
    border: 1px solid var(--b-subtle);
    background: var(--s-subtle);
    color: var(--t-secondary);
  }
  .trash-detail-actions .trash-restore-btn:hover {
    background: rgba(70,140,170,0.15);
    border-color: rgba(70,140,170,0.30);
    color: rgba(160,200,220,0.90);
  }
  .trash-detail-actions .trash-delete-btn:hover {
    background: rgba(140,50,50,0.18);
    border-color: rgba(180,70,70,0.25);
    color: rgba(220,130,130,0.85);
  }
  .trash-detail-body {
    flex: 1;
    overflow-y: auto;
    padding: 16px 18px;
    font-size: 13px;
    color: rgba(255,255,255,0.7);
    line-height: 1.7;
    font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
    word-break: break-word;
  }
  .trash-detail-empty {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--t-muted);
    font-size: var(--fs-sm);
  }
  .trash-empty-msg {
    text-align: center;
    padding: 24px 14px;
    color: var(--t-muted);
    font-size: var(--fs-sm);
  }

  /* ── Icon buttons (shared) ── circular action buttons in panels ── */
  .icon-btn {
    width: 28px; height: 28px;
    border-radius: var(--r-circle);
    background: var(--s-subtle);
    border: 1px solid var(--b-subtle);
    color: var(--t-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--ease);
    flex-shrink: 0;
    font-size: var(--fs-lg);
    line-height: 1;
    padding: 0;
  }
  .icon-btn:hover {
    background: var(--s-hover);
    color: var(--t-primary);
    border-color: var(--b-light);
  }
  .icon-btn svg {
    width: 14px; height: 14px;
    stroke: currentColor;
    stroke-width: 1.8;
    fill: none;
    transition: fill var(--ease), stroke var(--ease);
  }
  .icon-btn--danger:hover {
    background: var(--accent-red-bg);
    color: var(--accent-red);
    border-color: rgba(255,82,82,0.2);
  }
  .icon-btn--gold:hover {
    background: var(--accent-gold-bg);
    color: var(--accent-gold);
    border-color: var(--accent-gold-border);
  }
  .icon-btn--gold.active {
    background: var(--accent-gold-bg);
    color: var(--accent-gold);
    border-color: var(--accent-gold-border);
  }
  .icon-btn--gold.active svg.filled { fill: currentColor; }

  /* ── Action buttons (shared) ── solid clickable actions ── */
  .action-btn {
    font-size: var(--fs-md);
    font-weight: 500;
    font-family: inherit;
    padding: 6px 14px;
    border-radius: var(--r-small);
    border: 1px solid var(--b-subtle);
    cursor: pointer;
    transition: all var(--ease);
    white-space: nowrap;
  }
  .action-btn--primary {
    background: var(--s-medium);
    color: var(--t-primary);
  }
  .action-btn--primary:hover {
    background: var(--s-active);
    color: var(--t-bright);
  }
  .action-btn--primary:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  .action-btn--ghost {
    background: var(--s-transparent);
    color: var(--t-muted);
    border-color: transparent;
  }
  .action-btn--ghost:hover {
    background: var(--s-hover);
    color: var(--t-primary);
  }
  .action-btn--danger {
    background: var(--accent-red-bg);
    color: var(--accent-red);
    border-color: rgba(255,82,82,0.12);
  }
  .action-btn--danger:hover {
    background: var(--accent-red-hover);
  }

  /* ── Pill badges (shared) ── small info pills ── */
  .pill-badge {
    font-size: var(--fs-xs);
    font-weight: 500;
    padding: 2px 8px;
    border-radius: var(--r-pill);
    background: var(--s-subtle);
    color: var(--t-muted);
    line-height: 1.5;
  }
  .pill-badge--blue {
    background: var(--accent-blue-bg);
    color: rgba(100,180,255,0.6);
  }

  /* ═══════════════════════════════════════════
     LAYOUTS PANEL
     ═══════════════════════════════════════════ */
  /* layouts-btn and layouts-panel now use shared .toolbar-btn and .dropdown-panel */

  .preset-save-bar {
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
  }
  .preset-save-bar input {
    flex: 1;
    background: var(--s-subtle);
    border: 1px solid var(--b-subtle);
    border-radius: var(--r-small);
    padding: 6px 10px;
    color: var(--t-bright);
    font-size: var(--fs-md);
    font-family: inherit;
    outline: none;
    transition: border-color var(--ease);
  }
  .preset-save-bar input::placeholder {
    color: var(--t-faint);
  }
  .preset-save-bar input:focus {
    border-color: var(--b-hover);
  }
  .preset-save-bar button {
    background: var(--s-medium);
    border: 1px solid var(--b-subtle);
    color: var(--t-secondary);
    font-size: var(--fs-md);
    font-weight: 500;
    font-family: inherit;
    padding: 6px 12px;
    border-radius: var(--r-small);
    cursor: pointer;
    transition: all var(--ease);
    white-space: nowrap;
  }
  .preset-save-bar button:hover {
    background: var(--s-active);
    color: var(--t-bright);
    border-color: var(--b-hover);
  }

  .preset-list {
    max-height: 240px;
    overflow-y: auto;
  }

  .preset-row {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 10px;
    border-radius: var(--r-card);
    cursor: pointer;
    transition: background 0.15s;
    position: relative;
  }
  .preset-row:hover { background: var(--s-hover); }
  .preset-row.active { background: var(--s-medium); }

  .preset-name {
    flex: 1;
    font-size: var(--fs-md);
    color: var(--t-secondary);
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .preset-row:hover .preset-name { color: var(--t-primary); }
  .preset-row.active .preset-name { color: var(--t-bright); }

  .preset-badge {
    font-size: var(--fs-xs);
    font-weight: 500;
    color: var(--t-muted);
    background: var(--s-subtle);
    padding: 2px 8px;
    border-radius: var(--r-pill);
    flex-shrink: 0;
  }

  .preset-date {
    font-size: var(--fs-xs);
    color: var(--t-faint);
    flex-shrink: 0;
  }

  .preset-delete {
    background: none;
    border: none;
    color: var(--t-faint);
    font-size: var(--fs-lg);
    cursor: pointer;
    padding: 0 2px;
    line-height: 1;
    opacity: 0;
    transition: all 0.15s;
    flex-shrink: 0;
  }
  .preset-row:hover .preset-delete { opacity: 1; }
  .preset-delete:hover { color: var(--accent-red); }

  .preset-empty {
    text-align: center;
    padding: 18px 8px;
    font-size: var(--fs-md);
    color: var(--t-faint);
    letter-spacing: 0.02em;
    line-height: 1.7;
  }

  .preset-divider {
    height: 1px;
    background: rgba(255,255,255,0.06);
    margin: 6px 0;
  }
  .preset-row.builtin .preset-name {
    color: rgba(255,255,255,0.5);
    font-style: italic;
  }
  .preset-row.builtin.active .preset-name {
    color: rgba(255,255,255,0.85);
  }
  .preset-row.builtin .preset-badge {
    background: var(--accent-blue-bg);
    color: rgba(100,180,255,0.6);
    font-size: var(--fs-xs);
  }
  .preset-warning {
    font-size: 12px;
    color: rgba(255, 180, 0, 0.6);
    padding: 4px 0 2px;
    text-align: center;
    display: none;
  }
  .preset-warning.visible { display: block; }

  .status-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    background: #555;
    transition: background 0.5s;
  }
  .status-dot.connected { background: #64FFDA; box-shadow: 0 0 8px #64FFDA; }
  .status-dot.error { background: #FF5252; box-shadow: 0 0 8px #FF5252; }

  /* ═══════════════════════════════════════════
     SEARCH BAR (inline in top bar)
     ═══════════════════════════════════════════ */
  #search-container {
    display: contents;
  }

  #search-wrapper {
    position: relative;
    width: 340px;
    max-width: 40vw;
    border-radius: 8px;
    padding: 1px;
    background: rgba(255,255,255,0.06);
    transition: all 0.3s;
  }

  #search-wrapper.focused {
    background: conic-gradient(from var(--search-angle, 0deg),
      rgba(255,255,255,0.2), rgba(255,255,255,0.06), rgba(255,255,255,0.15), rgba(255,255,255,0.04), rgba(255,255,255,0.2));
    animation: rotateGradient 4s linear infinite;
  }

  @property --search-angle {
    syntax: '<angle>';
    initial-value: 0deg;
    inherits: false;
  }

  @keyframes rotateGradient {
    to { --search-angle: 360deg; }
  }

  #search-input {
    width: 100%;
    padding: 6px 36px 6px 12px;
    background: rgba(28, 28, 30, 0.7);
    border: none;
    border-radius: 7px;
    color: rgba(255, 255, 255, 0.9);
    font-size: 12px;
    font-weight: 400;
    outline: none;
    letter-spacing: 0.01em;
  }

  #search-input::placeholder {
    color: rgba(255,255,255,0.2);
    letter-spacing: 0.04em;
    font-weight: 400;
  }

  #search-badge {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: var(--s-medium);
    color: var(--t-primary);
    font-size: 9px;
    font-weight: 600;
    padding: 1px 6px;
    border-radius: var(--r-pill);
    opacity: 0;
    transition: opacity 0.3s;
  }
  #search-badge.visible { opacity: 1; }

  #search-clear {
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--t-muted);
    cursor: pointer;
    font-size: 14px;
    display: none;
    padding: 2px 6px;
    transition: color 0.15s;
  }
  #search-clear:hover { color: var(--t-bright); }

  /* ═══════════════════════════════════════════
     RESIZE HANDLES
     ═══════════════════════════════════════════ */
  .resize-handle {
    position: absolute;
    z-index: 10;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .resizable:hover .resize-handle,
  .resize-handle.active { opacity: 1; }

  .resize-handle-r   { right: 0; top: 0; width: 6px; height: 100%; cursor: ew-resize; }
  .resize-handle-l   { left: 0; top: 0; width: 6px; height: 100%; cursor: ew-resize; }
  .resize-handle-b   { bottom: 0; left: 0; height: 6px; width: 100%; cursor: ns-resize; }
  .resize-handle-t   { top: 0; left: 0; height: 6px; width: 100%; cursor: ns-resize; }
  .resize-handle-br  { right: 0; bottom: 0; width: 14px; height: 14px; cursor: nwse-resize; }
  .resize-handle-bl  { left: 0; bottom: 0; width: 14px; height: 14px; cursor: nesw-resize; }
  .resize-handle-tr  { right: 0; top: 0; width: 14px; height: 14px; cursor: nesw-resize; }
  .resize-handle-tl  { left: 0; top: 0; width: 14px; height: 14px; cursor: nwse-resize; }

  /* Drag handle (top bar of panels) */
  .drag-handle {
    position: relative;
    z-index: 20;
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 22 22'%3E%3Cpath d='M11 2l3 3.5h-2v4.5h4.5V8L20 11l-3.5 3v-2H12v4.5h2L11 20l-3-3.5h2v-4.5H5.5V14L2 11l3.5-3v2H10V5.5H8z' fill='rgba(255,255,255,0.65)' stroke='rgba(0,0,0,0.35)' stroke-width='0.6'/%3E%3C/svg%3E") 11 11, move;
    padding: 6px 0 4px 0;
    margin: -4px 0 6px 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .locked > .drag-handle .drag-grip { pointer-events: none; }
  .locked .drag-handle { cursor: default; }
  .locked .resize-handle { display: none; }
  .drag-handle:active {
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 22 22'%3E%3Cpath d='M11 2l3 3.5h-2v4.5h4.5V8L20 11l-3.5 3v-2H12v4.5h2L11 20l-3-3.5h2v-4.5H5.5V14L2 11l3.5-3v2H10V5.5H8z' fill='%234FC3F7' stroke='rgba(0,0,0,0.35)' stroke-width='0.6'/%3E%3C/svg%3E") 11 11, move;
  }
  .drag-handle .drag-grip {
    width: 32px;
    height: 4px;
    border-radius: 2px;
    background: rgba(255,255,255,0.08);
    transition: background 0.2s;
  }
  .resizable:hover .drag-grip { background: rgba(255,255,255,0.14); }

  .dragging { transition: none !important; }

  /* Offset top resize handles below the drag handle area per panel */
  #category-sidebar > .resize-handle-t,
  #category-sidebar > .resize-handle-tl,
  #category-sidebar > .resize-handle-tr  { top: 56px; }
  #detail-panel > .resize-handle-t,
  #detail-panel > .resize-handle-tl,
  #detail-panel > .resize-handle-tr      { top: 56px; }
  .trash-window > .resize-handle-t,
  .trash-window > .resize-handle-tl,
  .trash-window > .resize-handle-tr      { top: 44px; }
  .settings-panel > .resize-handle-t,
  .settings-panel > .resize-handle-tl,
  .settings-panel > .resize-handle-tr    { top: 40px; }

  /* ═══════════════════════════════════════════
     CATEGORY SIDEBAR (left)
     ═══════════════════════════════════════════ */
  #category-sidebar {
    position: fixed;
    top: 52px;
    left: 20px;
    z-index: 100;
    padding: 0;
    max-height: calc(100vh - 80px);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    width: 220px;
    min-width: 160px;
    min-height: 100px;
  }
  #category-sidebar-body {
    flex: 1;
    overflow-y: auto;
    padding: 0 14px 14px;
    min-height: 0;
  }

  /* ── Sidebar header (matches detail-panel pattern) ── */
  .sidebar-header {
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
  }
  .sidebar-header-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    padding: 8px 4px 0;
  }
  .sidebar-header-title {
    font-size: var(--fs-md);
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--t-primary);
    padding: 8px 8px 10px;
    border-bottom: 1px solid var(--b-subtle);
    margin-bottom: 10px;
    pointer-events: none;
  }
  .sidebar-header .pin-btn {
    position: relative !important;
    top: auto !important;
    right: auto !important;
    opacity: 1 !important;
    width: 26px;
    height: 26px;
  }
  #sidebar-label-controls {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 0 4px;
    margin-bottom: 10px;
  }

  .category-chip {
    display: flex;
    align-items: center;
    gap: 11px;
    padding: 8px 10px;
    border-radius: 8px;
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='22' viewBox='0 0 80 22'%3E%3Cpath d='M11 2l3 3.5h-2v4.5h4.5V8L20 11l-3.5 3v-2H12v4.5h2L11 20l-3-3.5h2v-4.5H5.5V14L2 11l3.5-3v2H10V5.5H8z' fill='rgba(255,255,255,0.65)' stroke='rgba(0,0,0,0.35)' stroke-width='0.6'/%3E%3Ctext x='23' y='15' font-size='11' font-family='system-ui,sans-serif' font-weight='500' fill='rgba(255,255,255,0.55)' stroke='rgba(0,0,0,0.4)' stroke-width='0.3' paint-order='stroke'%3Edrag me%3C/text%3E%3C/svg%3E") 11 11, move;
    transition: all 0.2s ease;
    margin-bottom: 2px;
    user-select: none;
  }
  .category-chip * { cursor: inherit; }
  .category-chip .category-dot,
  .category-chip .category-delete,
  .category-chip .cat-edit-icon { cursor: pointer; }

  .category-chip:hover { background: rgba(255,255,255,0.05); }
  .category-chip.inactive { opacity: 0.25; }
  .category-chip.drag-source {
    opacity: 0 !important;
    pointer-events: none;
    transition: opacity 0.1s ease !important;
  }

  /* ── Drag & Drop: Floating clone ── */
  .cat-drag-clone {
    position: fixed;
    z-index: 99999;
    pointer-events: none;
    border-radius: 8px;
    opacity: 0.97;
    will-change: transform;
    background: rgba(30, 30, 34, 0.98);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    box-shadow:
      0 20px 40px rgba(0,0,0,0.4),
      0 8px 16px rgba(0,0,0,0.25),
      0 0 0 1px rgba(255,255,255,0.06),
      0 0 32px rgba(79, 195, 247, 0.05);
  }

  /* ── Drag & Drop: Animated gap ── */
  #category-list.cat-dragging .category-chip,
  #category-list.cat-dragging .category-cluster-header,
  #category-list.cat-dragging .cluster-empty-hint {
    transition: margin 0.25s cubic-bezier(0.2, 0, 0, 1),
                opacity 0.15s ease;
  }
  #category-list.cat-dragging .drag-source {
    transition: opacity 0.1s ease !important;
  }
  .drag-gap-before {
    margin-top: var(--drag-gap, 36px) !important;
  }
  .drag-gap-after {
    margin-bottom: var(--drag-gap, 36px) !important;
  }

  /* ── Drag & Drop: Settle animation ── */
  @keyframes cat-drop-settle {
    0% { transform: scale(0.96); opacity: 0.5; }
    60% { transform: scale(1.02); }
    100% { transform: scale(1); opacity: 1; }
  }
  .category-chip.just-dropped,
  .category-cluster-header.just-dropped {
    animation: cat-drop-settle 0.25s cubic-bezier(0.22, 1, 0.36, 1);
  }

  .category-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 4px currentColor;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .category-dot:hover {
    transform: scale(1.4);
    box-shadow: 0 0 8px currentColor;
  }

  /* Cluster headers */
  .category-cluster-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 10px 6px 10px;
    margin-top: 16px;
    margin-bottom: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: rgba(255,255,255,0.5);
    border-left-width: 3px;
    border-left-style: solid;
    padding-left: 12px;
  }
  .category-cluster-header:first-child {
    margin-top: 0;
  }
  .category-cluster-header.inactive {
    opacity: 0.25;
  }
  .category-cluster-header {
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='22' viewBox='0 0 80 22'%3E%3Cpath d='M11 2l3 3.5h-2v4.5h4.5V8L20 11l-3.5 3v-2H12v4.5h2L11 20l-3-3.5h2v-4.5H5.5V14L2 11l3.5-3v2H10V5.5H8z' fill='rgba(255,255,255,0.65)' stroke='rgba(0,0,0,0.35)' stroke-width='0.6'/%3E%3Ctext x='23' y='15' font-size='11' font-family='system-ui,sans-serif' font-weight='500' fill='rgba(255,255,255,0.55)' stroke='rgba(0,0,0,0.4)' stroke-width='0.3' paint-order='stroke'%3Edrag me%3C/text%3E%3C/svg%3E") 11 11, move;
  }
  .category-cluster-header * { cursor: inherit; }
  .category-cluster-header .cluster-dot,
  .category-cluster-header .cluster-edit-btn,
  .category-cluster-header .cluster-delete-btn { cursor: pointer; }
  .category-cluster-header.drag-source {
    opacity: 0 !important;
    pointer-events: none;
    transition: opacity 0.1s ease !important;
  }
  .category-cluster-header.drag-over-cluster {
    background: rgba(79, 195, 247, 0.08) !important;
    box-shadow: inset 0 0 0 1.5px rgba(79, 195, 247, 0.25);
    border-radius: 6px;
    transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
  }
  .cluster-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.15s;
  }
  .cluster-dot:hover {
    transform: scale(1.3);
  }
  .cluster-name {
    flex: 1;
  }
  .cluster-actions {
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .category-cluster-header:hover .cluster-actions {
    opacity: 1;
  }
  .cluster-edit-btn,
  .cluster-delete-btn {
    background: rgba(255,255,255,0.1);
    border: none;
    color: rgba(255,255,255,0.6);
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.15s;
  }
  .cluster-edit-btn:hover {
    background: rgba(255,255,255,0.2);
    color: rgba(255,255,255,0.9);
  }
  .cluster-delete-btn:hover {
    background: rgba(220,38,38,0.2);
    color: rgb(239,68,68);
  }
  .cluster-empty-hint {
    margin-left: 20px;
    padding: 6px 12px;
    font-size: 10px;
    color: rgba(255,255,255,0.25);
    font-style: italic;
    border: 1px dashed rgba(255,255,255,0.1);
    border-radius: 4px;
    text-align: center;
    margin-bottom: 4px;
  }
  .drag-over-cluster {
    background: rgba(79, 195, 247, 0.08) !important;
    box-shadow: inset 0 0 0 1.5px rgba(79, 195, 247, 0.25);
    border-radius: 6px;
    transition: all 0.2s cubic-bezier(0.2, 0, 0, 1);
  }

  /* Child categories (indented) */
  .category-chip-child {
    margin-left: 20px;
    opacity: 0.95;
  }

  .color-edit-picker {
    padding: 8px 10px;
    margin: 2px 0 4px;
    background: rgba(30, 30, 34, 0.95);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    animation: colorPickerIn 0.12s ease-out;
  }
  @keyframes colorPickerIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .color-edit-picker .color-swatch-row {
    margin-bottom: 0;
  }
  .color-edit-picker .color-swatch {
    width: 22px; height: 22px;
  }
  .color-edit-reset {
    background: none;
    border: none;
    color: rgba(255,255,255,0.3);
    font-size: 12px;
    cursor: pointer;
    padding: 4px 0 0;
    transition: color 0.15s;
    width: 100%;
    text-align: center;
  }
  .color-edit-reset:hover { color: rgba(255,255,255,0.7); }

  .category-label {
    font-size: 15px;
    font-weight: 500;
    color: rgba(255,255,255,0.7);
    flex: 1;
  }

  .category-count {
    font-size: 14px;
    font-weight: 500;
    color: rgba(255,255,255,0.3);
    min-width: 18px;
    text-align: right;
  }

  .category-chip .category-delete {
    display: none;
    background: none;
    border: none;
    color: var(--t-muted);
    font-size: 15px;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    line-height: 20px;
    text-align: center;
    flex-shrink: 0;
    margin-left: auto;
    transition: color 0.15s;
  }
  .category-chip:hover .category-delete { display: block; }
  .category-chip .category-delete:hover { color: var(--accent-red); }

  .category-desc-editor {
    padding: 6px 10px 8px;
    margin: 2px 0 4px;
    background: rgba(30, 30, 34, 0.95);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    animation: colorPickerIn 0.12s ease-out;
  }
  .category-desc-editor label {
    font-size: 12px;
    color: rgba(255,255,255,0.3);
    display: block;
    margin-bottom: 4px;
  }
  .category-desc-editor textarea {
    width: 100%;
    background: rgba(255,255,255,0.04);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 6px;
    color: rgba(255,255,255,0.8);
    font-size: 15px;
    font-family: inherit;
    padding: 6px 8px;
    resize: vertical;
    min-height: 36px;
    max-height: 80px;
    outline: none;
    transition: border-color 0.15s;
  }
  .category-desc-editor textarea:focus {
    border-color: rgba(255,255,255,0.2);
  }
  .category-desc-actions {
    display: flex;
    gap: 6px;
    margin-top: 6px;
    justify-content: flex-end;
  }
  .category-desc-actions button {
    font-size: var(--fs-sm);
    font-family: inherit;
    font-weight: 500;
    padding: 4px 12px;
    border-radius: var(--r-small);
    border: 1px solid var(--b-subtle);
    cursor: pointer;
    transition: all var(--ease);
  }
  .desc-save-btn {
    background: var(--s-medium);
    color: var(--t-primary);
  }
  .desc-save-btn:hover { background: var(--s-active); color: var(--t-bright); }
  .desc-cancel-btn {
    background: none;
    color: var(--t-muted);
    border-color: transparent;
  }
  .desc-cancel-btn:hover { color: var(--t-secondary); background: var(--s-hover); }

  .category-label {
    cursor: default;
  }
  .category-label .cat-edit-icon {
    display: none;
    font-size: 13px;
    margin-left: 5px;
    opacity: 0.45;
    vertical-align: middle;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .category-chip:hover .category-label .cat-edit-icon {
    display: inline;
  }
  .category-label .cat-edit-icon:hover {
    opacity: 0.8;
  }

  #category-add-btn,
  #category-add-parent-btn {
    border-radius: var(--r-card);
    border: 1px dashed var(--b-light);
    background: var(--s-subtle);
    color: var(--t-muted);
    font-size: var(--fs-sm);
    font-weight: 500;
    font-family: inherit;
    letter-spacing: 0.3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all var(--ease);
    padding: 7px 0;
  }
  #category-add-btn:hover,
  #category-add-parent-btn:hover {
    background: var(--s-hover);
    border-color: var(--b-visible);
    color: var(--t-primary);
    border-style: solid;
  }
  #category-add-btn svg,
  #category-add-parent-btn svg {
    width: 13px; height: 13px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
  }

  #category-create-form {
    display: none;
    padding: 10px;
    margin-top: 8px;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 10px;
  }
  #category-create-form[data-mode="parent"] #cat-parent-select,
  #category-create-form[data-mode="parent"] .styled-select {
    display: none;
  }
  #category-create-form.open { display: block; }

  .category-create-input {
    width: 100%;
    background: var(--s-subtle);
    border: 1px solid var(--b-subtle);
    border-radius: var(--r-small);
    padding: 7px 10px;
    color: var(--t-bright);
    font-size: var(--fs-base);
    outline: none;
    margin-bottom: 6px;
    transition: border-color var(--ease);
    font-family: inherit;
  }
  .category-create-input::placeholder { color: var(--t-faint); }
  .category-create-input:focus { border-color: var(--b-hover); }
  .category-create-input.invalid { border-color: rgba(255,82,82,0.5); }

  .color-swatch-row {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    margin-bottom: 8px;
  }

  .color-swatch {
    width: 24px; height: 24px;
    border-radius: 50%;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.15s;
    padding: 0;
  }
  .color-swatch:hover { transform: scale(1.15); }
  .color-swatch.selected { border-color: rgba(255,255,255,0.8); transform: scale(1.15); }

  .category-form-actions {
    display: flex;
    gap: 6px;
  }
  .category-form-actions button {
    flex: 1;
    padding: 6px 0;
    border-radius: var(--r-small);
    font-size: var(--fs-md);
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    transition: all var(--ease);
    border: 1px solid var(--b-subtle);
  }
  .category-form-btn-create {
    background: var(--s-medium);
    color: var(--t-primary);
  }
  .category-form-btn-create:hover {
    background: var(--s-active);
    color: var(--t-bright);
  }
  .category-form-btn-create:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }
  .category-form-btn-cancel {
    background: var(--s-transparent);
    color: var(--t-muted);
    border-color: transparent;
  }
  .category-form-btn-cancel:hover {
    background: var(--s-hover);
    color: var(--t-primary);
  }

  .category-form-error {
    font-size: 12px;
    color: #FF5252;
    margin-bottom: 6px;
    min-height: 14px;
  }

  .category-reassign-bar {
    padding: 8px;
    margin-top: 4px;
    background: rgba(255,82,82,0.08);
    border: 1px solid rgba(255,82,82,0.15);
    border-radius: 8px;
    font-size: 12px;
    color: rgba(255,255,255,0.6);
  }
  .category-reassign-bar select {
    width: 100%;
    margin: 6px 0;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 6px;
    padding: 5px 8px;
    color: rgba(255,255,255,0.8);
    font-size: 13px;
    outline: none;
  }
  .category-reassign-bar select option {
    background: #1c1c1e;
    color: #e0e0e0;
  }
  .category-reassign-actions {
    display: flex;
    gap: 6px;
    margin-top: 6px;
  }
  .category-reassign-actions button {
    flex: 1;
    padding: 5px 0;
    border-radius: var(--r-small);
    font-size: var(--fs-md);
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    border: 1px solid var(--b-subtle);
    transition: all var(--ease);
  }
  .reassign-confirm {
    background: var(--accent-red-bg);
    color: var(--accent-red);
    border-color: rgba(255,82,82,0.12);
  }
  .reassign-confirm:hover {
    background: var(--accent-red-hover);
  }
  .reassign-cancel-btn {
    background: var(--s-transparent);
    color: var(--t-muted);
    border-color: transparent;
  }
  .reassign-cancel-btn:hover {
    background: var(--s-hover);
    color: var(--t-primary);
  }

  /* ── Category delete flow ── */
  .cat-delete-options {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin: 16px 0 12px;
    text-align: left;
  }
  .cat-delete-option {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 14px;
    border-radius: var(--r-card);
    border: 1px solid var(--b-subtle);
    background: rgba(255,255,255,0.02);
    cursor: pointer;
    transition: all var(--ease);
  }
  .cat-delete-option:hover {
    background: rgba(255,255,255,0.04);
    border-color: rgba(255,255,255,0.10);
  }
  .cat-delete-option-icon {
    flex-shrink: 0;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .cat-delete-option-icon svg {
    width: 18px;
    height: 18px;
    stroke-width: 1.6;
    fill: none;
    opacity: 0.75;
    transition: opacity var(--ease);
  }
  .cat-delete-option:hover .cat-delete-option-icon svg,
  .cat-delete-option.selected .cat-delete-option-icon svg { opacity: 1; }
  .cat-delete-option--delete .cat-delete-option-icon svg { stroke: #E8886F; }
  .cat-delete-option--export .cat-delete-option-icon svg { stroke: var(--accent-blue); }
  .cat-delete-option--migrate .cat-delete-option-icon svg { stroke: var(--accent-gold); }
  .cat-delete-option--delete.selected {
    border-color: rgba(232,136,111,0.35);
    background: rgba(232,136,111,0.06);
  }
  .cat-delete-option--export.selected {
    border-color: rgba(79,195,247,0.3);
    background: rgba(79,195,247,0.05);
  }
  .cat-delete-option--migrate.selected {
    border-color: rgba(255,215,0,0.3);
    background: rgba(255,215,0,0.04);
  }
  .cat-delete-option-text {
    flex: 1;
    min-width: 0;
  }
  .cat-delete-option-label {
    font-size: var(--fs-md);
    font-weight: 600;
    color: var(--t-bright);
    margin-bottom: 2px;
  }
  .cat-delete-option-desc {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    line-height: 1.35;
  }
  .cat-delete-step {
    animation: tagModalFadeIn 0.15s ease-out;
  }
  .cat-delete-step .modal-select {
    margin-top: 8px;
  }
  .cat-delete-progress {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    margin-top: 8px;
    text-align: center;
  }

  /* ═══════════════════════════════════════════
     DETAIL PANEL (right, slide-in)
     ═══════════════════════════════════════════ */
  #detail-panel {
    position: fixed;
    top: 52px;
    right: -520px;
    z-index: 100;
    width: 400px;
    min-width: 280px;
    min-height: 200px;
    max-height: calc(100vh - 80px);
    overflow-y: auto;
    padding: 0;
    transition: right 0.4s cubic-bezier(0.22, 1, 0.36, 1);
    display: flex;
    flex-direction: column;
  }

  #detail-panel.open { right: 20px; }
  #detail-panel.resizing { transition: none; }

  /* ── Panel header — action bar + category ── */
  .detail-header {
    display: flex;
    flex-direction: column;
    flex-shrink: 0;
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 22 22'%3E%3Cpath d='M11 2l3 3.5h-2v4.5h4.5V8L20 11l-3.5 3v-2H12v4.5h2L11 20l-3-3.5h2v-4.5H5.5V14L2 11l3.5-3v2H10V5.5H8z' fill='rgba(255,255,255,0.65)' stroke='rgba(0,0,0,0.35)' stroke-width='0.6'/%3E%3C/svg%3E") 11 11, move;
  }
  .detail-header:active {
    cursor: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 22 22'%3E%3Cpath d='M11 2l3 3.5h-2v4.5h4.5V8L20 11l-3.5 3v-2H12v4.5h2L11 20l-3-3.5h2v-4.5H5.5V14L2 11l3.5-3v2H10V5.5H8z' fill='%234FC3F7' stroke='rgba(0,0,0,0.35)' stroke-width='0.6'/%3E%3C/svg%3E") 11 11, move;
  }
  .detail-header-actions {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 4px;
    padding: 8px 12px 0;
  }
  .detail-header-category {
    display: flex;
    align-items: baseline;
    gap: 8px;
    padding: 8px 16px 12px;
    border-bottom: 1px solid var(--b-subtle);
  }
  .detail-header-dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 6px currentColor;
    position: relative;
    top: -1px;
  }
  .detail-header-name {
    font-size: var(--fs-md);
    font-weight: 600;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--t-primary);
    line-height: 1.4;
    word-break: break-word;
  }
  /* Small icon buttons used in header */
  .detail-action-btn {
    width: 30px; height: 30px;
    border-radius: var(--r-circle);
    background: transparent;
    border: 1px solid transparent;
    color: var(--t-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--ease);
    padding: 0;
    flex-shrink: 0;
    position: relative;
  }
  .detail-action-btn svg {
    width: 15px; height: 15px;
    stroke: currentColor;
    stroke-width: 1.8;
    fill: none;
  }
  .detail-action-btn:hover {
    background: var(--s-hover);
    color: var(--t-primary);
    border-color: var(--b-light);
  }
  .detail-action-btn--gold:hover {
    color: var(--accent-gold);
    border-color: var(--accent-gold-border);
  }
  .detail-action-btn--gold.active {
    color: var(--accent-gold);
  }
  .detail-action-btn--gold.active svg,
  .detail-action-btn--gold.active svg.filled { fill: currentColor; }
  .detail-action-btn--danger:hover {
    color: var(--accent-red);
    border-color: rgba(255,82,82,0.25);
    background: var(--accent-red-bg);
  }
  .detail-action-btn--close {
    font-size: 18px;
    font-weight: 400;
    line-height: 1;
  }
  .detail-action-btn--close:hover {
    color: var(--t-bright);
  }
  /* Custom tooltip (JS-positioned, appended to body) */
  .ui-tooltip {
    display: none;
    position: fixed;
    pointer-events: none;
    z-index: 99999;
    padding: 5px 10px;
    border-radius: 6px;
    background: rgba(10, 12, 18, 0.92);
    border: 1px solid rgba(255,255,255,0.08);
    backdrop-filter: blur(12px);
    color: rgba(255,255,255,0.85);
    font-size: 11px;
    font-family: inherit;
    font-weight: 500;
    letter-spacing: 0.02em;
    white-space: nowrap;
    box-shadow: 0 4px 16px rgba(0,0,0,0.4), 0 0 0 1px rgba(255,255,255,0.04);
    opacity: 0;
    transform: translateY(4px);
    transition: opacity 0.15s ease, transform 0.15s ease;
  }
  .ui-tooltip.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .ui-tooltip-arrow {
    position: absolute;
    width: 10px; height: 10px;
    pointer-events: none;
  }
  .ui-tooltip-arrow::after {
    content: '';
    position: absolute;
    border: 5px solid transparent;
  }
  .ui-tooltip.above .ui-tooltip-arrow {
    bottom: -10px; left: 50%; transform: translateX(-50%);
  }
  .ui-tooltip.above .ui-tooltip-arrow::after {
    border-top-color: rgba(10, 12, 18, 0.92);
  }
  .ui-tooltip.below .ui-tooltip-arrow {
    top: -10px; left: 50%; transform: translateX(-50%);
  }
  .ui-tooltip.below .ui-tooltip-arrow::after {
    border-bottom-color: rgba(10, 12, 18, 0.92);
  }
  /* Separator dot between action groups */
  .detail-action-sep {
    width: 3px; height: 3px;
    border-radius: 50%;
    background: var(--b-light);
    flex-shrink: 0;
  }

  /* ── Panel body ── */
  .detail-body {
    padding: 14px 16px 16px;
    overflow-y: auto;
    flex: 1;
  }

  /* ── Subheader — importance + chips ── */
  .detail-subheader {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  #detail-importance {
    display: flex;
    align-items: center;
    gap: 3px;
  }
  .detail-chip {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border: 1px solid var(--b-subtle);
    border-radius: var(--r-pill);
    background: var(--s-subtle);
    color: var(--t-muted);
    font-size: var(--fs-xs);
    font-weight: 500;
    font-family: inherit;
    cursor: pointer;
    transition: all var(--ease);
    white-space: nowrap;
    letter-spacing: 0.02em;
  }
  .detail-chip:hover {
    color: var(--t-primary);
    background: var(--s-hover);
    border-color: var(--b-hover);
  }
  .detail-chip.active {
    color: var(--accent-blue);
    background: var(--accent-blue-bg);
    border-color: var(--accent-blue-border);
  }
  .detail-chip.active:hover {
    background: rgba(79,195,247,0.18);
  }
  .detail-chip svg {
    width: 10px; height: 10px;
    fill: none;
    stroke: currentColor;
    stroke-width: 2;
    stroke-linecap: round;
  }
  /* ── Category change modal ── */
  .cat-change-modal {
    min-width: 380px;
    max-width: 440px;
    max-height: 480px;
    display: flex;
    flex-direction: column;
  }
  .cat-change-modal-title {
    font-size: var(--fs-md);
    color: var(--t-secondary);
    margin-bottom: 4px;
  }
  .cat-change-modal-current {
    font-size: var(--fs-base);
    font-weight: 600;
    color: var(--t-bright);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .cat-change-modal-current .cat-dot {
    width: 8px; height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 4px currentColor;
  }
  .cat-change-modal-list {
    overflow-y: auto;
    max-height: 300px;
    padding: 2px;
  }
  .cat-modal-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.12s;
    font-size: var(--fs-base);
    color: var(--t-primary);
    text-transform: none;
    letter-spacing: normal;
  }
  .cat-modal-option:hover {
    background: var(--s-hover);
    color: var(--t-bright);
  }
  .cat-modal-option.active {
    background: var(--accent-blue-bg);
    border: 1px solid var(--accent-blue-border);
    color: var(--t-bright);
  }
  .cat-modal-option .cat-opt-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    box-shadow: 0 0 4px currentColor;
  }
  .cat-modal-option .cat-opt-name {
    flex: 1;
    min-width: 0;
  }
  .cat-modal-option .cat-opt-desc {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  #detail-content {
    font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.7;
    color: rgba(255,255,255,0.7);
    margin-bottom: 20px;
    word-break: break-word;
    position: relative;
  }

  /* Paragraphs */
  #detail-content p, .trash-detail-body p {
    margin: 0 0 10px 0;
  }
  #detail-content p:last-child, .trash-detail-body p:last-child { margin-bottom: 0; }

  /* H2 — main section */
  #detail-content .mc-h2, .trash-detail-body .mc-h2 {
    font-size: 16px;
    font-weight: 600;
    color: rgba(255,255,255,0.92);
    margin: 0 0 12px 0;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    letter-spacing: -0.01em;
  }
  #detail-content .mc-h2:first-child, .trash-detail-body .mc-h2:first-child { margin-top: 0; }

  /* H3 — subsection */
  #detail-content .mc-h3, .trash-detail-body .mc-h3 {
    font-size: 14px;
    font-weight: 600;
    color: rgba(255,255,255,0.75);
    margin: 16px 0 6px 0;
    letter-spacing: 0.01em;
  }
  #detail-content .mc-h3:first-child, .trash-detail-body .mc-h3:first-child { margin-top: 0; }

  /* H4+ / plain heading */
  #detail-content .mc-h4, .trash-detail-body .mc-h4 {
    font-size: 13px;
    font-weight: 600;
    color: rgba(255,255,255,0.6);
    margin: 12px 0 4px 0;
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  /* Inline code */
  #detail-content code, .trash-detail-body code {
    font-family: inherit;
    font-size: inherit;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.04);
    border-radius: 5px;
    padding: 2px 7px;
    color: rgba(255,255,255,0.75);
    word-break: break-all;
  }

  /* Code block */
  #detail-content .mc-codeblock, .trash-detail-body .mc-codeblock {
    font-family: inherit;
    font-size: inherit;
    line-height: 1.6;
    background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.04);
    border-radius: 10px;
    padding: 12px 14px;
    margin: 8px 0 12px 0;
    color: rgba(255,255,255,0.6);
    overflow-x: auto;
    white-space: pre;
  }

  /* Bold */
  #detail-content strong, .trash-detail-body strong {
    font-weight: 600;
    color: rgba(255,255,255,0.88);
  }

  /* Lists */
  #detail-content ul, .trash-detail-body ul {
    margin: 4px 0 12px 0;
    padding: 0;
    list-style: none;
  }

  #detail-content li, .trash-detail-body li {
    position: relative;
    padding-left: 16px;
    margin-bottom: 5px;
    color: rgba(255,255,255,0.65);
    font-size: inherit;
    line-height: 1.65;
  }

  #detail-content li::before, .trash-detail-body li::before {
    content: '';
    position: absolute;
    left: 2px;
    top: 8px;
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
  }

  /* Key-value description after em dash or colon in list */
  #detail-content li .kv-desc, .trash-detail-body li .kv-desc {
    color: rgba(255,255,255,0.4);
    font-weight: 400;
  }

  /* Divider */
  #detail-content .mc-divider, .trash-detail-body .mc-divider {
    height: 1px;
    background: rgba(255,255,255,0.05);
    margin: 14px 0;
  }

  /* Key: Value standalone */
  #detail-content .mc-kv, .trash-detail-body .mc-kv {
    margin-bottom: 4px;
    font-size: inherit;
    line-height: 1.65;
  }
  #detail-content .mc-kv-key, .trash-detail-body .mc-kv-key {
    color: rgba(255,255,255,0.4);
    font-weight: 500;
  }
  #detail-content .mc-kv-val, .trash-detail-body .mc-kv-val {
    color: rgba(255,255,255,0.75);
  }

  /* ── Content Edit Button ── */
  .content-edit-wrap {
    position: relative;
  }

  /* ── Markdown Editor ── */
  .md-editor-wrap {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 20px;
  }
  .md-toolbar {
    display: flex;
    gap: 4px;
    padding: 4px;
    background: var(--s-subtle);
    border: 1px solid var(--b-subtle);
    border-radius: var(--r-card);
  }
  .md-toolbar button {
    padding: 5px 10px;
    border: 1px solid transparent;
    border-radius: var(--r-small);
    background: transparent;
    color: var(--t-secondary);
    font-size: var(--fs-md);
    font-weight: 600;
    font-family: inherit;
    cursor: pointer;
    transition: all var(--ease);
    line-height: 1;
  }
  .md-toolbar button:hover {
    background: var(--s-medium);
    color: var(--t-bright);
    border-color: var(--b-light);
  }
  .md-toolbar button.active {
    background: var(--accent-blue-bg);
    color: var(--accent-blue);
    border-color: var(--accent-blue-border);
  }
  .md-textarea {
    width: 100%;
    min-height: 120px;
    max-height: 360px;
    overflow-y: auto;
    padding: 12px 14px;
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--b-light);
    border-radius: var(--r-card);
    color: var(--t-primary);
    font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
    font-size: 13px;
    line-height: 1.6;
    resize: vertical;
    outline: none;
    transition: border-color var(--ease);
  }
  .md-textarea:focus {
    border-color: var(--accent-blue-border);
  }
  .md-editor-actions {
    display: flex;
    gap: 8px;
    justify-content: flex-end;
  }
  .md-editor-actions button {
    padding: 6px 16px;
    border-radius: var(--r-small);
    font-size: var(--fs-md);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--ease);
    border: 1px solid;
  }
  .md-btn-cancel {
    background: transparent;
    border-color: var(--b-light) !important;
    color: var(--t-secondary);
  }
  .md-btn-cancel:hover {
    background: var(--s-hover);
    color: var(--t-primary);
  }
  .md-btn-save {
    background: var(--accent-blue-bg);
    border-color: var(--accent-blue-border) !important;
    color: var(--accent-blue);
  }
  .md-btn-save:hover {
    background: rgba(79,195,247,0.2);
  }

  .detail-section {
    margin-bottom: 16px;
  }

  .detail-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.3);
    margin-bottom: 8px;
  }

  .tag-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
  }

  .tag-chip {
    font-size: var(--fs-sm);
    font-weight: 500;
    padding: 4px 10px;
    border-radius: var(--r-pill);
    background: var(--s-light);
    color: var(--t-secondary);
    border: 1px solid var(--b-subtle);
    display: inline-flex;
    align-items: center;
    gap: 0;
    cursor: default;
    transition: all 0.2s;
    position: relative;
  }
  .tag-chip:hover {
    border-color: var(--b-light);
  }
  .tag-chip .tag-remove {
    display: none;
    margin-left: 6px;
    color: var(--t-muted);
    font-size: 13px;
    line-height: 1;
    cursor: pointer;
    transition: color 0.15s;
  }
  .tag-chip:hover .tag-remove { display: inline; }
  .tag-chip .tag-remove:hover { color: var(--accent-red); }

  /* Confirmation modal overlay + panel */
  .tag-delete-overlay {
    position: fixed;
    inset: 0;
    z-index: 300;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(18px) saturate(0.8);
    -webkit-backdrop-filter: blur(18px) saturate(0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    animation: tagModalFadeIn 0.15s ease-out;
  }
  @keyframes tagModalFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  .tag-delete-modal {
    background: rgba(28, 28, 30, 0.72);
    backdrop-filter: blur(40px) saturate(1.4);
    -webkit-backdrop-filter: blur(40px) saturate(1.4);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 14px;
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.4), inset 0 0.5px 0 rgba(255, 255, 255, 0.05);
    padding: 22px 28px;
    text-align: center;
    min-width: 260px;
    animation: tagModalScaleIn 0.15s ease-out;
  }
  @keyframes tagModalScaleIn {
    from { opacity: 0; transform: scale(0.95); }
    to { opacity: 1; transform: scale(1); }
  }
  .tag-delete-modal-title {
    font-size: var(--fs-md);
    color: var(--t-secondary);
    margin-bottom: 6px;
  }
  .tag-delete-modal-tag {
    font-size: var(--fs-base);
    font-weight: 600;
    color: var(--t-bright);
    margin-bottom: 18px;
  }
  .tag-delete-modal-actions {
    display: flex;
    gap: 8px;
    justify-content: center;
  }
  .tag-delete-modal-actions button {
    font-size: var(--fs-sm);
    font-weight: 500;
    font-family: inherit;
    padding: 7px 22px;
    border-radius: var(--r-card);
    border: 1px solid var(--b-subtle);
    cursor: pointer;
    transition: all var(--ease);
  }
  .modal-select {
    width: 100%;
    margin-bottom: 16px;
    background: #111114;
    border: 1px solid var(--b-light);
    border-radius: var(--r-button);
    padding: 9px 12px;
    color: var(--t-bright);
    font-size: var(--fs-md);
    font-family: inherit;
    outline: none;
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    transition: all var(--ease);
  }
  select.modal-select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='rgba(255,255,255,0.35)' stroke-width='2.5' stroke-linecap='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    background-color: #111114;
    padding-right: 30px;
  }
  .modal-select:focus {
    border-color: var(--b-hover);
    background-color: #151518;
  }
  .modal-select option {
    background: #111114;
    color: #ccc;
    padding: 8px 12px;
  }

  /* ── Custom styled dropdown (replaces native <select>) ── */
  .styled-select {
    position: relative;
    width: 100%;
    margin-bottom: 16px;
  }
  .styled-select-trigger {
    width: 100%;
    display: flex;
    align-items: center;
    gap: 8px;
    background: #111114;
    border: 1px solid var(--b-light);
    border-radius: var(--r-button);
    padding: 9px 32px 9px 12px;
    color: var(--t-bright);
    font-size: var(--fs-md);
    font-family: inherit;
    cursor: pointer;
    transition: all var(--ease);
    position: relative;
    text-align: left;
    outline: none;
  }
  .styled-select-trigger::after {
    content: '';
    position: absolute;
    right: 11px;
    top: 50%;
    transform: translateY(-50%) rotate(0deg);
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 5px solid rgba(255,255,255,0.35);
    transition: transform 0.2s ease;
  }
  .styled-select.open .styled-select-trigger::after {
    transform: translateY(-50%) rotate(180deg);
  }
  .styled-select-trigger:hover,
  .styled-select.open .styled-select-trigger {
    border-color: var(--b-hover);
    background: #151518;
  }
  .styled-select-label {
    flex: 1;
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .styled-select-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .styled-select-menu {
    position: absolute;
    top: calc(100% + 4px);
    left: 0;
    right: 0;
    z-index: 310;
    max-height: 220px;
    overflow-y: auto;
    background: rgba(20, 20, 22, 0.92);
    backdrop-filter: blur(24px) saturate(1.3);
    -webkit-backdrop-filter: blur(24px) saturate(1.3);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5), inset 0 0.5px 0 rgba(255,255,255,0.04);
    padding: 4px;
    display: none;
    animation: styledSelectIn 0.12s ease-out;
  }
  .styled-select.open .styled-select-menu { display: block; }
  @keyframes styledSelectIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .styled-select-menu::-webkit-scrollbar { width: 5px; }
  .styled-select-menu::-webkit-scrollbar-track { background: transparent; }
  .styled-select-menu::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }
  .styled-select-option {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 10px;
    border-radius: 7px;
    cursor: pointer;
    color: var(--t-secondary);
    font-size: var(--fs-md);
    font-family: inherit;
    transition: all 0.1s ease;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .styled-select-option:hover {
    background: rgba(255,255,255,0.06);
    color: var(--t-bright);
  }
  .styled-select-option.active {
    background: rgba(99,102,241,0.12);
    color: var(--t-bright);
  }
  .styled-select-option .styled-select-dot { flex-shrink: 0; }

  /* ── Settings Panel (draggable/pinnable) ── */
  .settings-panel {
    position: fixed;
    z-index: 300;
    width: 620px;
    max-width: 92vw;
    min-width: 380px;
    min-height: 400px;
    animation: tagModalScaleIn 0.15s ease-out;
    display: flex;
    flex-direction: column;
    max-height: 80vh;
    overflow: hidden;
  }
  .settings-panel.dragging { transition: none; }
  .settings-panel-header {
    display: flex;
    align-items: center;
    padding: 10px 16px;
    border-bottom: 1px solid var(--b-subtle);
    gap: 8px;
  }
  .settings-panel-header h3 {
    flex: 1;
    font-size: 13px;
    letter-spacing: 0.25em;
    text-transform: uppercase;
    font-weight: 500;
    color: rgba(255,255,255,0.45);
    margin: 0;
    pointer-events: none;
  }
  .settings-panel-header .pin-btn {
    position: relative;
    top: auto;
    right: auto;
    opacity: 1;
  }
  .settings-panel-close {
    width: 26px; height: 26px;
    display: flex; align-items: center; justify-content: center;
    background: transparent; border: none;
    color: var(--t-muted); cursor: pointer;
    border-radius: var(--r-circle);
    font-size: 18px; line-height: 1;
    transition: all var(--ease);
    padding: 0; flex-shrink: 0;
  }
  .settings-panel-close:hover { color: var(--t-bright); background: var(--s-hover); }
  .settings-panel-body {
    display: flex;
    flex: 1;
    overflow: hidden;
    min-height: 0;
  }
  .settings-nav {
    width: 150px;
    flex-shrink: 0;
    padding: 12px 8px;
    border-right: 1px solid var(--b-subtle);
    display: flex;
    flex-direction: column;
    gap: 2px;
    overflow-y: auto;
  }
  .settings-nav-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 10px;
    font-size: 13px;
    font-weight: 500;
    font-family: inherit;
    color: var(--t-muted);
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all var(--ease);
    text-align: left;
    white-space: nowrap;
  }
  .settings-nav-item svg {
    width: 15px;
    height: 15px;
    flex-shrink: 0;
    stroke: currentColor;
    stroke-width: 1.8;
    fill: none;
    stroke-linecap: round;
    stroke-linejoin: round;
  }
  .settings-nav-item:hover { color: var(--t-primary); background: var(--s-hover); }
  .settings-nav-item.active { color: var(--t-bright); background: var(--s-medium); }
  .settings-content {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    min-width: 0;
  }
  .settings-panel.locked .settings-panel-header {
    cursor: default;
  }
  .settings-panel-backdrop {
    position: fixed;
    inset: 0;
    z-index: 299;
    pointer-events: none;
  }
  .settings-field {
    margin-bottom: 16px;
  }
  .settings-field label {
    display: block;
    font-size: var(--fs-sm);
    font-weight: 500;
    color: var(--t-primary);
    margin-bottom: 5px;
  }
  .settings-hint {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    line-height: 1.4;
  }
  .settings-field .settings-hint {
    margin-top: 3px;
  }
  .settings-field input[type="text"],
  .settings-field input[type="password"] {
    width: 100%;
    box-sizing: border-box;
    font-size: var(--fs-md);
    font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
    padding: 7px 10px;
    border-radius: var(--r-small);
    background: var(--s-subtle);
    color: var(--t-bright);
    border: 1px solid var(--b-light);
    outline: none;
    transition: border-color var(--ease);
  }
  .settings-field input[type="text"]:focus,
  .settings-field input[type="password"]:focus {
    border-color: var(--accent-blue-border);
  }
  .settings-field input::placeholder {
    color: var(--t-muted);
  }
  .settings-key-row {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .settings-key-row input {
    flex: 1;
    font-size: var(--fs-md);
    font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
    padding: 7px 10px;
    border-radius: var(--r-small);
    background: var(--s-subtle);
    color: var(--t-bright);
    border: 1px solid var(--b-light);
    outline: none;
    transition: border-color var(--ease);
  }
  .settings-key-row input:focus {
    border-color: var(--accent-blue-border);
  }
  .settings-key-row input::placeholder {
    color: var(--t-muted);
    font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
  }
  .settings-toggle-vis {
    width: 32px;
    height: 32px;
    border-radius: var(--r-small);
    background: var(--s-subtle);
    border: 1px solid var(--b-light);
    color: var(--t-muted);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    transition: all var(--ease);
  }
  .settings-toggle-vis:hover {
    background: var(--s-hover);
    color: var(--t-primary);
    border-color: var(--b-hover);
  }
  .settings-toggle-vis svg {
    width: 14px;
    height: 14px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
  }
  .settings-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: var(--fs-sm);
    color: var(--t-secondary);
    margin-bottom: 16px;
    padding: 8px 10px;
    background: var(--s-subtle);
    border-radius: var(--r-small);
    border: 1px solid var(--b-subtle);
  }
  .settings-status-dot {
    width: 8px;
    height: 8px;
    border-radius: var(--r-circle);
    flex-shrink: 0;
  }
  .settings-status-dot.connected { background: #4caf50; box-shadow: 0 0 6px rgba(76,175,80,0.5); }
  .settings-status-dot.disconnected { background: var(--accent-red); box-shadow: 0 0 6px rgba(255,82,82,0.4); }
  /* ── Settings tabs ── */
  .settings-tab-body { display: none; }
  .settings-tab-body.active { display: block; }
  /* ── Range sliders ── */
  .gfx-group-title {
    font-size: var(--fs-xs);
    font-weight: 600;
    color: var(--t-muted);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    margin: 14px 0 6px;
    padding-bottom: 4px;
    border-bottom: 1px solid var(--b-subtle);
  }
  .gfx-group-title:first-child { margin-top: 0; }
  .gfx-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  .gfx-label {
    font-size: var(--fs-sm);
    color: var(--t-secondary);
    min-width: 110px;
    flex-shrink: 0;
  }
  .gfx-row input[type="range"] {
    flex: 1;
    height: 4px;
    -webkit-appearance: none;
    appearance: none;
    background: var(--b-light);
    border-radius: 2px;
    outline: none;
    cursor: pointer;
  }
  .gfx-row input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 14px;
    height: 14px;
    border-radius: 50%;
    background: var(--accent-blue);
    border: 2px solid rgba(0,0,0,0.4);
    cursor: pointer;
  }
  .gfx-val {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    min-width: 36px;
    text-align: right;
    font-family: 'JetBrains Mono', 'SF Mono', 'Consolas', monospace;
  }
  .gfx-val-input {
    background: transparent;
    border: 1px solid transparent;
    border-radius: 4px;
    padding: 1px 2px;
    width: 38px;
    -moz-appearance: textfield;
    appearance: textfield;
  }
  .gfx-val-input:hover { border-color: var(--b-subtle); }
  .gfx-val-input:focus { border-color: var(--b-light); outline: none; background: rgba(255,255,255,0.04); }
  .gfx-val-input::-webkit-inner-spin-button,
  .gfx-val-input::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
  .gfx-reset-btn {
    margin-top: 12px;
    width: 100%;
    padding: 6px;
    font-size: var(--fs-sm);
    font-weight: 500;
    font-family: inherit;
    background: var(--accent-red-bg);
    border: 1px solid rgba(255,82,82,0.2);
    color: var(--accent-red);
    border-radius: var(--r-card);
    cursor: pointer;
    transition: all var(--ease);
  }
  .gfx-reset-btn:hover { background: var(--accent-red-hover); }

  /* Graphics presets */
  .gfx-presets {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
    margin-bottom: 16px;
  }
  .gfx-preset-card {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 3px;
    padding: 8px 6px;
    border-radius: 10px;
    border: 1px solid var(--b-subtle);
    background: var(--s-medium);
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
  }
  .gfx-preset-card::before {
    content: '';
    position: absolute;
    inset: 0;
    border-radius: 10px;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }
  .gfx-preset-card:hover {
    border-color: rgba(255,255,255,0.15);
    background: var(--s-hover);
  }
  .gfx-preset-card:hover::before { opacity: 0.5; }
  .gfx-preset-card.active {
    border-color: var(--accent-blue);
    box-shadow: 0 0 12px rgba(79,195,247,0.15);
  }
  .gfx-preset-card.active::before { opacity: 1; }
  .gfx-preset-name {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--t-secondary);
  }
  .gfx-preset-card.active .gfx-preset-name { color: var(--t-bright); }
  .gfx-preset-desc {
    font-size: 9px;
    color: var(--t-muted);
    text-align: center;
    line-height: 1.3;
  }
  /* Per-preset gradient accents */
  .gfx-preset-card[data-preset="low"]::before {
    background: radial-gradient(ellipse at bottom, rgba(100,180,100,0.08) 0%, transparent 70%);
  }
  .gfx-preset-card[data-preset="medium"]::before {
    background: radial-gradient(ellipse at bottom, rgba(79,195,247,0.08) 0%, transparent 70%);
  }
  .gfx-preset-card[data-preset="high"]::before {
    background: radial-gradient(ellipse at bottom, rgba(171,71,188,0.1) 0%, transparent 70%);
  }
  .gfx-preset-card[data-preset="insane"]::before {
    background: radial-gradient(ellipse at bottom, rgba(255,145,0,0.12) 0%, transparent 70%);
  }
  .gfx-preset-card[data-preset="insane"].active {
    border-color: #ff9100;
    box-shadow: 0 0 16px rgba(255,145,0,0.2), 0 0 40px rgba(255,145,0,0.06);
    animation: insane-glow 2s ease-in-out infinite alternate;
  }
  @keyframes insane-glow {
    0% { box-shadow: 0 0 12px rgba(255,145,0,0.2), 0 0 30px rgba(255,145,0,0.05); }
    100% { box-shadow: 0 0 20px rgba(255,145,0,0.3), 0 0 50px rgba(255,145,0,0.1); }
  }

  /* ── Recall presets (Memory tab) ── */
  #recall-presets {
    grid-template-columns: repeat(3, 1fr);
  }
  #recall-presets .gfx-preset-card {
    padding: 10px 8px;
    gap: 2px;
  }
  .gfx-preset-card[data-recall-preset="150"]::before {
    background: radial-gradient(ellipse at bottom, rgba(76,175,80,0.1) 0%, transparent 70%);
  }
  .gfx-preset-card[data-recall-preset="150"].active {
    border-color: rgba(76,175,80,0.6);
    box-shadow: 0 0 12px rgba(76,175,80,0.15);
  }
  .gfx-preset-card[data-recall-preset="500"]::before {
    background: radial-gradient(ellipse at bottom, rgba(79,195,247,0.1) 0%, transparent 70%);
  }
  .gfx-preset-card[data-recall-preset="500"].active {
    border-color: rgba(79,195,247,0.6);
    box-shadow: 0 0 12px rgba(79,195,247,0.15);
  }
  .gfx-preset-card[data-recall-preset="0"]::before {
    background: radial-gradient(ellipse at bottom, rgba(171,71,188,0.1) 0%, transparent 70%);
  }
  .gfx-preset-card[data-recall-preset="0"].active {
    border-color: rgba(171,71,188,0.6);
    box-shadow: 0 0 12px rgba(171,71,188,0.15);
  }
  .recall-preview-box {
    margin-top: 14px;
    padding: 10px 12px;
    background: rgba(0,0,0,0.25);
    border: 1px solid var(--b-subtle);
    border-radius: 6px;
    font-family: 'SF Mono', 'Cascadia Code', 'JetBrains Mono', monospace;
    font-size: 10px;
    line-height: 1.5;
    color: var(--t-muted);
    max-height: 72px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-break: break-word;
  }

  /* ── Memory Sync ── */
  .sync-check-btn {
    background: var(--s-subtle);
    border: 1px solid var(--b-subtle);
    color: var(--t-secondary);
    font-size: var(--fs-sm);
    font-weight: 500;
    font-family: inherit;
    letter-spacing: 0.04em;
    padding: 6px 14px;
    border-radius: var(--r-pill);
    cursor: pointer;
    transition: all var(--ease);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }
  .sync-check-btn:hover {
    background: var(--s-hover);
    color: var(--t-primary);
    border-color: var(--b-light);
  }
  .sync-check-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  .sync-check-btn .spinner {
    width: 12px;
    height: 12px;
    border: 1.5px solid var(--t-muted);
    border-top-color: var(--accent-blue);
    border-radius: 50%;
    animation: syncSpin 0.6s linear infinite;
    display: none;
  }
  .sync-check-btn.loading .spinner { display: inline-block; }
  .sync-check-btn.loading .btn-label { display: none; }

  @keyframes syncSpin {
    to { transform: rotate(360deg); }
  }

  .sync-results {
    margin-top: 12px;
  }
  .sync-summary {
    font-size: var(--fs-sm);
    color: var(--t-secondary);
    margin-bottom: 10px;
  }
  .sync-summary strong {
    color: var(--accent-gold);
    font-weight: 600;
  }
  .sync-summary.clean strong {
    color: #4ade80;
  }
  .sync-card {
    background: rgba(0,0,0,0.2);
    border: 1px solid var(--b-subtle);
    border-radius: var(--r-card);
    padding: 10px 12px;
    margin-bottom: 8px;
    transition: border-color var(--ease), background var(--ease);
    cursor: pointer;
    user-select: none;
  }
  .sync-card:hover {
    border-color: var(--b-hover);
  }
  .sync-card.selected {
    background: rgba(255,255,255,0.05);
    border-color: rgba(255,255,255,0.2);
  }
  .sync-card-check {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    border: 1.5px solid rgba(255,255,255,0.2);
    background: transparent;
    flex-shrink: 0;
    transition: all var(--ease);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .sync-card.selected .sync-card-check {
    background: rgba(255,255,255,0.15);
    border-color: rgba(255,255,255,0.35);
  }
  .sync-card.selected .sync-card-check::after {
    content: '✓';
    font-size: 9px;
    color: var(--t-bright);
    line-height: 1;
  }
  .sync-select-all {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    cursor: pointer;
    background: none;
    border: none;
    font-family: inherit;
    padding: 0;
    margin-bottom: 8px;
    transition: color var(--ease);
  }
  .sync-select-all:hover {
    color: var(--t-primary);
  }
  .sync-card-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 6px;
  }
  .sync-card-category {
    font-size: 9px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 2px 7px;
    border-radius: 10px;
    background: var(--accent-blue-bg);
    color: var(--accent-blue);
    border: 1px solid var(--accent-blue-border);
  }
  .sync-card-importance {
    font-size: 9px;
    font-weight: 600;
    padding: 2px 6px;
    border-radius: 10px;
    background: var(--accent-gold-bg);
    color: var(--accent-gold);
    border: 1px solid var(--accent-gold-border);
  }
  .sync-card-content {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    line-height: 1.4;
    margin-bottom: 6px;
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .sync-card-files {
    font-size: 9px;
    color: var(--t-faint);
    font-family: 'JetBrains Mono', monospace;
    margin-bottom: 8px;
  }
  .sync-card-files span {
    color: var(--accent-gold);
  }
  .sync-copy-btn {
    background: var(--accent-blue-bg);
    border: 1px solid var(--accent-blue-border);
    color: var(--accent-blue);
    font-size: 10px;
    font-weight: 500;
    font-family: inherit;
    padding: 4px 10px;
    border-radius: var(--r-pill);
    cursor: pointer;
    transition: all var(--ease);
    width: 100%;
  }
  .sync-copy-btn:hover {
    background: rgba(79,195,247,0.2);
    border-color: rgba(79,195,247,0.4);
  }
  .sync-copy-btn.copied {
    background: rgba(74,222,128,0.12);
    border-color: rgba(74,222,128,0.3);
    color: #4ade80;
  }

  /* Advanced section collapsible */
  .gfx-advanced-toggle {
    display: flex;
    align-items: center;
    gap: 6px;
    width: 100%;
    padding: 8px 0;
    margin-top: 8px;
    background: none;
    border: none;
    border-top: 1px solid var(--b-subtle);
    color: var(--t-muted);
    font-size: var(--fs-xs);
    font-weight: 600;
    font-family: inherit;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    cursor: pointer;
    transition: color 0.2s;
  }
  .gfx-advanced-toggle:hover { color: var(--t-secondary); }
  .gfx-advanced-toggle .arrow {
    display: inline-block;
    transition: transform 0.2s;
    font-size: 10px;
  }
  .gfx-advanced-toggle.open .arrow { transform: rotate(90deg); }
  .gfx-advanced-body {
    display: none;
    padding-top: 4px;
  }
  .gfx-advanced-body.open { display: block; }
  .gfx-preset-label {
    font-size: var(--fs-xs);
    color: var(--t-muted);
    margin-bottom: 8px;
  }
  .settings-restart-notice {
    margin-top: 12px;
    padding: 10px 12px;
    background: rgba(255,215,0,0.08);
    border: 1px solid rgba(255,215,0,0.2);
    border-radius: var(--r-small);
    font-size: var(--fs-sm);
    color: var(--accent-gold);
    display: none;
  }
  .settings-actions {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 20px;
  }
  .settings-actions button {
    font-family: inherit;
    font-size: var(--fs-md);
    font-weight: 500;
    padding: 7px 18px;
    border-radius: var(--r-card);
    cursor: pointer;
    transition: all var(--ease);
  }
  .settings-btn-cancel {
    background: var(--s-subtle);
    border: 1px solid var(--b-light);
    color: var(--t-secondary);
  }
  .settings-btn-cancel:hover {
    background: var(--s-hover);
    color: var(--t-primary);
  }
  .settings-btn-save {
    background: var(--accent-blue-bg);
    border: 1px solid var(--accent-blue-border);
    color: var(--accent-blue);
  }
  .settings-btn-save:hover {
    background: rgba(79,195,247,0.18);
  }
  #settings-btn {
    border-radius: var(--r-card);
    border: 1px dashed var(--b-light);
    background: var(--s-subtle);
    color: var(--t-muted);
    font-size: var(--fs-sm);
    font-weight: 500;
    font-family: inherit;
    letter-spacing: 0.3px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all var(--ease);
    padding: 7px 0;
  }
  #settings-btn:hover {
    background: var(--s-hover);
    border-color: var(--b-visible);
    color: var(--t-primary);
    border-style: solid;
  }
  #settings-btn svg {
    width: 13px;
    height: 13px;
    stroke: currentColor;
    stroke-width: 2;
    fill: none;
  }

  .tag-add-input {
    font-size: var(--fs-sm);
    font-weight: 500;
    padding: 3px 10px;
    border-radius: var(--r-pill);
    background: var(--s-subtle);
    color: var(--t-secondary);
    border: 1px dashed var(--b-light);
    outline: none;
    width: 90px;
    transition: all var(--ease);
    font-family: inherit;
  }
  .tag-add-input::placeholder {
    color: var(--t-faint);
  }
  .tag-add-input:focus {
    border-color: var(--b-visible);
    background: var(--s-hover);
    width: 120px;
  }

  .detail-meta {
    font-size: 15px;
    color: rgba(255,255,255,0.3);
    line-height: 1.9;
  }

  .detail-meta span { color: rgba(255,255,255,0.55); font-weight: 500; }

  .detail-meta-row {
    display: flex;
    justify-content: space-between;
    padding: 3px 0;
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }

  .detail-meta-row:last-child { border-bottom: none; }

  .meta-copy-btn {
    background: none;
    border: 1px solid transparent;
    color: var(--t-muted);
    cursor: pointer;
    padding: 2px 5px;
    border-radius: var(--r-small);
    font-size: var(--fs-xs);
    margin-left: 6px;
    transition: all var(--ease);
    line-height: 1;
  }
  .meta-copy-btn:hover {
    color: var(--t-primary);
    background: var(--s-hover);
    border-color: var(--b-light);
  }
  .meta-copy-btn.copied {
    color: var(--accent-blue);
  }

  .delete-confirm-no {
    background: var(--s-subtle);
    color: var(--t-muted);
  }
  .delete-confirm-no:hover {
    background: var(--s-hover);
    color: var(--t-primary);
  }

  /* ═══════════════════════════════════════════
     STATS BAR (bottom)
     ═══════════════════════════════════════════ */
  #stats-bar {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    padding: 8px 22px;
    display: flex;
    align-items: center;
    gap: 20px;
    font-size: 13px;
    font-weight: 500;
    color: rgba(255,255,255,0.35);
    letter-spacing: 0.03em;
  }

  .stat-value { color: rgba(255,255,255,0.6); font-weight: 600; }

  .stat-divider {
    width: 1px;
    height: 14px;
    background: rgba(255,255,255,0.08);
  }

  /* ═══════════════════════════════════════════
     LOADING STATE
     ═══════════════════════════════════════════ */
  #loading-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: #000000;
    transition: opacity 0.8s;
  }

  #loading-overlay.hidden {
    opacity: 0;
    pointer-events: none;
  }

  #loading-text {
    font-size: 15px;
    font-weight: 500;
    letter-spacing: 0.4em;
    text-transform: uppercase;
    color: rgba(255, 255, 255, 0.45);
    animation: pulse 2.5s ease-in-out infinite;
  }

  #loading-sub {
    font-size: 15px;
    font-weight: 400;
    color: rgba(255,255,255,0.15);
    margin-top: 12px;
    letter-spacing: 0.1em;
  }

  @keyframes pulse {
    0%, 100% { opacity: 0.4; }
    50% { opacity: 1; }
  }

  /* Docker / Qdrant down state */
  #loading-overlay.error #loading-text { animation: none; opacity: 0.7; }
  #loading-overlay.error #loading-sub { color: rgba(255,255,255,0.3); }
  #loading-action {
    display: none;
    margin-top: 24px;
    text-align: center;
  }
  #loading-overlay.error #loading-action { display: block; }
  #loading-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 24px;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    color: rgba(255,255,255,0.7);
    border-radius: 8px;
    font-size: 13px;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.05em;
  }
  #loading-action-btn:hover {
    background: rgba(255,255,255,0.12);
    border-color: rgba(255,255,255,0.25);
    color: rgba(255,255,255,0.9);
  }
  #loading-action-btn:disabled {
    opacity: 0.4;
    cursor: wait;
  }
  #loading-action-btn svg { width: 16px; height: 16px; fill: none; stroke: currentColor; stroke-width: 2; }
  #loading-action-status {
    margin-top: 10px;
    font-size: 11px;
    color: rgba(255,255,255,0.25);
    letter-spacing: 0.05em;
  }

  /* Server offline — mascot + start command */
  #loading-mascot {
    display: none;
    margin-bottom: 28px;
    position: relative;
    animation: mascot-sleep 4s ease-in-out infinite;
  }
  #loading-overlay.server-offline #loading-mascot { display: block; }
  @keyframes mascot-sleep {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-4px); }
  }
  #loading-zzz {
    position: absolute;
    top: -2px;
    right: -18px;
    font-size: 16px;
    opacity: 0;
    animation: zzz-float 3s ease-in-out infinite;
  }
  @keyframes zzz-float {
    0% { opacity: 0; transform: translate(0, 0) scale(0.7); }
    15% { opacity: 0.35; }
    60% { opacity: 0.2; transform: translate(8px, -18px) scale(1); }
    100% { opacity: 0; transform: translate(14px, -30px) scale(1.1); }
  }
  #loading-server-cmd {
    display: none;
    margin-top: 28px;
    text-align: center;
  }
  #loading-overlay.server-offline #loading-server-cmd { display: block; }
  #loading-server-cmd-hint {
    font-size: 12px;
    color: rgba(255,255,255,0.25);
    letter-spacing: 0.08em;
    margin-bottom: 12px;
  }
  #loading-server-cmd-box {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    padding: 10px 16px;
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.10);
    border-radius: 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 12px;
    color: rgba(255,255,255,0.6);
    user-select: all;
  }
  #loading-cmd-copy {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 6px;
    cursor: pointer;
    color: rgba(255,255,255,0.4);
    transition: all 0.2s;
    flex-shrink: 0;
  }
  #loading-cmd-copy:hover {
    background: rgba(255,255,255,0.12);
    color: rgba(255,255,255,0.8);
    border-color: rgba(255,255,255,0.22);
  }
  #loading-cmd-copy svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; }
  #loading-retry-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 18px;
    padding: 8px 20px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    color: rgba(255,255,255,0.45);
    border-radius: 8px;
    font-size: 12px;
    font-family: inherit;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    letter-spacing: 0.06em;
  }
  #loading-retry-btn:hover {
    background: rgba(255,255,255,0.10);
    border-color: rgba(255,255,255,0.22);
    color: rgba(255,255,255,0.7);
  }
  #loading-retry-btn svg { width: 14px; height: 14px; fill: none; stroke: currentColor; stroke-width: 2; }
  #loading-retry-status {
    margin-top: 8px;
    font-size: 11px;
    color: rgba(255,255,255,0.2);
    letter-spacing: 0.05em;
    min-height: 16px;
  }

  /* ═══════════════════════════════════════════
     TOOLTIP
     ═══════════════════════════════════════════ */
  #tooltip {
    position: fixed;
    z-index: 200;
    padding: 10px 18px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    font-size: 15px;
    max-width: 320px;
  }

  #tooltip.visible { opacity: 1; }
  #tooltip-category { font-size: 13px; letter-spacing: 0.15em; text-transform: uppercase; }
  #tooltip-preview { color: rgba(255,255,255,0.6); margin-top: 5px; font-size: 14px; line-height: 1.45; }
  #tooltip-importance { color: #FFD700; font-size: 14px; margin-top: 4px; }

  /* ═══════════════════════════════════════════
     2D-SPECIFIC STYLES
     ═══════════════════════════════════════════ */

  /* View toggle pill */
  .view-toggle {
    display: flex;
    align-items: center;
    gap: 0;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: var(--r-pill);
    overflow: hidden;
  }
  .view-toggle a {
    padding: 4px 10px;
    font-size: 11px;
    font-weight: 600;
    letter-spacing: 0.06em;
    color: var(--t-muted);
    text-decoration: none;
    transition: all var(--ease);
    border-right: 1px solid rgba(255,255,255,0.05);
  }
  .view-toggle a:last-child { border-right: none; }
  .view-toggle a:hover { color: var(--t-primary); background: var(--s-hover); }
  .view-toggle a.active {
    color: var(--accent-blue);
    background: var(--accent-blue-bg);
  }

  /* Minimap */
  #minimap {
    position: fixed;
    bottom: 52px;
    right: 12px;
    width: 200px;
    height: 140px;
    z-index: 90;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid rgba(255,255,255,0.06);
    background: rgba(28,28,30,0.72);
    backdrop-filter: blur(40px) saturate(1.4);
    -webkit-backdrop-filter: blur(40px) saturate(1.4);
    box-shadow: 0 2px 20px rgba(0,0,0,0.4);
    transition: opacity var(--ease);
  }
  #minimap.hidden { opacity: 0; pointer-events: none; }
  #minimap-canvas { width: 100%; height: 100%; display: block; }
  #minimap-label {
    position: absolute;
    top: 4px;
    left: 8px;
    font-size: 9px;
    font-weight: 600;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: rgba(255,255,255,0.2);
    pointer-events: none;
  }

  /* Context menu */
  #context-menu {
    position: fixed;
    z-index: 500;
    min-width: 180px;
    padding: 4px;
    display: none;
    animation: dropdownFadeIn 0.1s ease-out;
  }
  #context-menu.open { display: block; }
  .ctx-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 7px 12px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 13px;
    color: var(--t-secondary);
    transition: background 0.1s;
  }
  .ctx-item:hover { background: var(--s-hover); color: var(--t-bright); }
  .ctx-item svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 1.8; fill: none; }
  .ctx-item--danger:hover { color: var(--accent-red); background: var(--accent-red-bg); }
  .ctx-sep { height: 1px; background: var(--b-subtle); margin: 3px 4px; }

  /* Lasso selection overlay */
  #lasso-canvas {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 5;
    pointer-events: none;
  }

  /* Multi-select info bar */
  #multi-select-bar {
    position: fixed;
    bottom: 52px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 95;
    padding: 8px 18px;
    display: none;
    gap: 12px;
    align-items: center;
    font-size: 13px;
    color: var(--t-primary);
  }
  #multi-select-bar.open { display: flex; }
  #multi-select-bar button {
    font-size: 12px;
    font-weight: 500;
    font-family: inherit;
    padding: 4px 12px;
    border-radius: var(--r-small);
    border: 1px solid var(--b-subtle);
    background: var(--s-subtle);
    color: var(--t-secondary);
    cursor: pointer;
    transition: all var(--ease);
  }
  #multi-select-bar button:hover {
    background: var(--s-hover);
    color: var(--t-bright);
    border-color: var(--b-hover);
  }
</style>
</head>
<body>

<!-- Loading -->
<div id="loading-overlay">
  <div id="loading-mascot">
    <svg viewBox="0 0 280 140" width="160" height="80" style="overflow:visible">
      <g class="syna-eye"><g class="syna-lid" transform="translate(0,60) scale(1,0.08) translate(0,-60)"><rect x="80" y="24" width="38" height="72" rx="19" fill="#ffffff"/></g></g>
      <g class="syna-eye"><g class="syna-lid" transform="translate(0,60) scale(1,0.08) translate(0,-60)"><rect x="162" y="24" width="38" height="72" rx="19" fill="#ffffff"/></g></g>
      <path d="M125,112 Q140,118 155,112" fill="none" stroke="rgba(255,255,255,0.15)" stroke-width="2.5" stroke-linecap="round"/>
    </svg>
    <span id="loading-zzz">z</span>
  </div>
  <div id="loading-text">Connecting</div>
  <div id="loading-sub">Initializing neural pathways...</div>
  <div id="loading-action">
    <button id="loading-action-btn" type="button">
      <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
      <span id="loading-action-label">Start Docker</span>
    </button>
    <div id="loading-action-status"></div>
  </div>
  <div id="loading-server-cmd">
    <div id="loading-server-cmd-hint">Run this command to start the server:</div>
    <div id="loading-server-cmd-box">
      <code id="loading-cmd-text">node J:\Sites\Apps\Synabun\neural-interface\server.js</code>
      <button id="loading-cmd-copy" title="Copy to clipboard">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
      </button>
    </div>
    <br>
    <button id="loading-retry-btn" type="button">
      <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
      Retry Connection
    </button>
    <div id="loading-retry-status"></div>
    <img src="synabun.png?v=2" alt="SynaBun" style="margin-top:6px;height:32px;width:auto;filter:grayscale(0.5);opacity:0.18;">
  </div>
</div>

<!-- Tooltip -->
<div id="tooltip" class="glass">
  <div id="tooltip-category"></div>
  <div id="tooltip-preview"></div>
  <div id="tooltip-importance"></div>
</div>

<!-- Top Menu Bar -->
<div id="title-bar">
  <div class="bar-left">
    <img src="synabun.png?v=2" alt="SynaBun" style="height:24px;width:auto;opacity:0.7;">
    <div class="bar-sep"></div>
    <!-- View Toggle -->
    <div class="view-toggle">
      <a class="view-toggle-btn active" href="#">2D</a>
      <a class="view-toggle-btn" href="/">3D</a>
    </div>
    <div class="bar-sep"></div>
    <button id="toggle-links-btn" class="bar-pill" data-tooltip="Toggle links: Off / Intra / All">All Links</button>
    <button id="link-type-btn" class="bar-pill" data-tooltip="Filter by connection type">Show: All Types</button>
    <button id="reset-positions-btn" class="bar-pill">Reset Layout</button>
    <div class="bar-sep"></div>
    <button id="hull-toggle-btn" class="bar-pill" data-tooltip="Toggle category hulls (H)">Hulls</button>
    <button id="minimap-toggle-btn" class="bar-pill" data-tooltip="Toggle minimap (M)">Minimap</button>
    <div class="bar-sep"></div>
    <button id="toggle-categories-btn" class="toolbar-btn active"><svg viewBox="0 0 24 24"><circle cx="5" cy="6" r="2"/><circle cx="5" cy="12" r="2"/><circle cx="5" cy="18" r="2"/><line x1="10" y1="6" x2="21" y2="6"/><line x1="10" y1="12" x2="21" y2="12"/><line x1="10" y1="18" x2="21" y2="18"/></svg>Categories</button>
    <div style="position:relative">
      <button id="bookmarks-btn" class="toolbar-btn"><svg viewBox="0 0 24 24"><path d="M5 5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16l-7-4-7 4V5z"/></svg>Bookmarks<span class="count-badge count-badge--gold" id="bookmark-count"></span></button>
      <div id="bookmarks-panel" class="glass dropdown-panel">
        <div id="bookmarks-list"></div>
      </div>
    </div>
    <div style="position:relative">
      <button id="layouts-btn" class="toolbar-btn">Layouts</button>
      <div id="layouts-panel" class="glass dropdown-panel">
        <div class="preset-save-bar">
          <input type="text" id="preset-name-input" placeholder="Layout name..." autocomplete="off" spellcheck="false" maxlength="40">
          <button id="preset-save-btn">Save</button>
        </div>
        <div class="preset-warning" id="preset-warning">No pinned nodes to save</div>
        <div class="preset-list" id="preset-list"></div>
      </div>
    </div>
  </div>

  <div class="bar-center" id="search-container">
    <div id="search-wrapper">
      <input type="text" id="search-input" placeholder="Search memories..." autocomplete="off" spellcheck="false">
      <span id="search-badge"></span>
      <button id="search-clear">&times;</button>
    </div>
  </div>

  <div class="bar-right">
    <button id="help-btn" class="bar-icon" data-tooltip="Shortcuts">?</button>
    <button id="titlebar-trash-btn" class="bar-icon" data-tooltip="Trash"><svg viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><path d="M19 6l-.7 12.1a2 2 0 0 1-2 1.9H7.7a2 2 0 0 1-2-1.9L5 6"/></svg><span class="count-badge count-badge--red" id="titlebar-trash-count"></span></button>
    <button id="titlebar-settings-btn" class="bar-icon" data-tooltip="Settings"><svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg></button>
  </div>
</div>

<!-- Help Modal -->
<div id="help-overlay">
  <div id="help-modal" class="glass" style="position:relative;">
    <button id="help-close">&times;</button>
    <h2>Controls</h2>
    <div class="help-section">
      <div class="help-section-title">Keyboard</div>
      <div class="help-row"><div class="help-keys"><span class="help-key">/</span></div><span class="help-desc">Focus search</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Esc</span></div><span class="help-desc">Close panel / clear search</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">?</span></div><span class="help-desc">Toggle this help</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">F</span></div><span class="help-desc">Toggle focus mode</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">L</span></div><span class="help-desc">Cycle link mode</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">H</span></div><span class="help-desc">Toggle category hulls</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">M</span></div><span class="help-desc">Toggle minimap</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">G</span></div><span class="help-desc">Open layout presets</span></div>
    </div>
    <div class="help-section">
      <div class="help-section-title">Mouse</div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Click</span><span class="help-key">Node</span></div><span class="help-desc">Select &amp; inspect memory</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Drag</span><span class="help-key">Node</span></div><span class="help-desc">Move &amp; pin node in place</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Dbl-click</span><span class="help-key">Node</span></div><span class="help-desc">Unpin node (clear position)</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Right-click</span><span class="help-key">Node</span></div><span class="help-desc">Context menu</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Hover</span><span class="help-key">Node</span></div><span class="help-desc">Show tooltip preview</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Left Drag</span></div><span class="help-desc">Pan canvas</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Scroll</span></div><span class="help-desc">Zoom in / out</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Dbl-click</span><span class="help-key">BG</span></div><span class="help-desc">Zoom to fit all</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Shift+Drag</span></div><span class="help-desc">Lasso select</span></div>
    </div>
    <div class="help-section">
      <div class="help-section-title">Panels</div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Drag</span><span class="help-key">Grip</span></div><span class="help-desc">Move panel</span></div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Drag</span><span class="help-key">Edge</span></div><span class="help-desc">Resize panel</span></div>
    </div>
    <div class="help-section">
      <div class="help-section-title">Sidebar</div>
      <div class="help-row"><div class="help-keys"><span class="help-key">Click</span><span class="help-key">Category</span></div><span class="help-desc">Toggle category visibility</span></div>
    </div>
  </div>
</div>

<!-- Category Sidebar -->
<div id="category-sidebar" class="glass resizable">
  <div class="resize-handle resize-handle-t" data-resize="t"></div>
  <div class="resize-handle resize-handle-b" data-resize="b"></div>
  <div class="resize-handle resize-handle-l" data-resize="l"></div>
  <div class="resize-handle resize-handle-r" data-resize="r"></div>
  <div class="resize-handle resize-handle-tl" data-resize="tl"></div>
  <div class="resize-handle resize-handle-tr" data-resize="tr"></div>
  <div class="resize-handle resize-handle-bl" data-resize="bl"></div>
  <div class="resize-handle resize-handle-br" data-resize="br"></div>
  <div class="sidebar-header drag-handle" data-drag="category-sidebar">
    <div class="sidebar-header-actions">
      <button class="detail-action-btn" id="category-select-all-btn" data-tooltip="Select all"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3"/><polyline points="9 12 11 14 16 9"/></svg></button>
      <button class="detail-action-btn" id="category-clear-btn" data-tooltip="Deselect all"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="3"/><line x1="9" y1="9" x2="15" y2="15"/><line x1="15" y1="9" x2="9" y2="15"/></svg></button>
      <div class="detail-action-sep"></div>
      <button class="detail-action-btn" id="label-toggle-btn" data-tooltip="Toggle labels"><svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg></button>
      <button class="detail-action-btn" id="label-size-btn" data-tooltip="Label size"><svg viewBox="0 0 24 24"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg></button>
      <div class="detail-action-sep"></div>
      <button class="detail-action-btn pin-btn" data-pin="category-sidebar" data-tooltip="Pin"><svg viewBox="0 0 24 24"><path d="M9 4v4.5L7.5 10H6v2h4v7l2 1 2-1v-7h4v-2h-1.5L15 8.5V4H9z" stroke-linejoin="round" stroke-linecap="round"/></svg></button>
      <button class="detail-action-btn detail-action-btn--close" id="sidebar-close" data-tooltip="Close">&times;</button>
    </div>
    <div class="sidebar-header-title">Categories</div>
  </div>
  <div id="category-sidebar-body">
  <div id="sidebar-label-controls">
    <input type="range" id="label-size-slider" min="0.3" max="2.5" step="0.1" value="1.0" style="flex:1;height:3px;accent-color:var(--t-muted);cursor:pointer;opacity:0;transition:opacity 0.2s;pointer-events:none;" data-tooltip="Label size">
  </div>
  <div id="category-list"></div>
  <div style="display:flex;gap:8px;padding:0 12px;margin-bottom:8px;">
    <button id="category-add-btn" style="flex:1;" data-tooltip="Add category"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Category</button>
    <button id="category-add-parent-btn" style="flex:1;" data-tooltip="Add parent"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>Parent</button>
  </div>
  <div style="display:flex;gap:8px;padding:0 12px;margin-bottom:8px;">
    <button id="settings-btn" style="flex:1;" data-tooltip="Settings"><svg viewBox="0 0 24 24"><path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>Settings</button>
  </div>
  <div id="category-create-form" data-mode="child">
    <div id="cat-form-title" style="font-weight:600;padding:8px 12px 4px;color:#aaa;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;">Create Category</div>
    <input class="category-create-input" id="cat-name-input" placeholder="category-name" maxlength="30" spellcheck="false">
    <input class="category-create-input" id="cat-desc-input" placeholder="Short description...">
    <select class="modal-select" id="cat-parent-select">
      <option value="">(None - standalone category)</option>
    </select>
    <div class="color-swatch-row" id="color-swatch-row"></div>
    <div class="category-form-error" id="cat-form-error"></div>
    <div class="category-form-actions">
      <button class="category-form-btn-cancel" id="cat-form-cancel">Cancel</button>
      <button class="category-form-btn-create" id="cat-form-create" disabled>Create</button>
    </div>
  </div>
  </div>
</div>

<!-- Detail Panel -->
<div id="detail-panel" class="glass resizable">
  <div class="resize-handle resize-handle-t" data-resize="t"></div>
  <div class="resize-handle resize-handle-b" data-resize="b"></div>
  <div class="resize-handle resize-handle-l" data-resize="l"></div>
  <div class="resize-handle resize-handle-r" data-resize="r"></div>
  <div class="resize-handle resize-handle-tl" data-resize="tl"></div>
  <div class="resize-handle resize-handle-tr" data-resize="tr"></div>
  <div class="resize-handle resize-handle-bl" data-resize="bl"></div>
  <div class="resize-handle resize-handle-br" data-resize="br"></div>
  <div class="detail-header drag-handle" data-drag="detail-panel">
    <div class="detail-header-actions">
      <button class="detail-action-btn" id="content-edit-btn" data-tooltip="Edit"><svg viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
      <button class="detail-action-btn detail-action-btn--gold" id="detail-bookmark-btn" data-tooltip="Bookmark"><svg viewBox="0 0 24 24"><path d="M5 5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16l-7-4-7 4V5z"/></svg></button>
      <button class="detail-action-btn" id="detail-change-cat-btn" data-tooltip="Move"><svg viewBox="0 0 24 24"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg></button>
      <button class="detail-action-btn" id="detail-export-md-btn" data-tooltip="Export MD"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
      <button class="detail-action-btn detail-action-btn--danger" id="detail-delete-inline-btn" data-tooltip="Delete"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg></button>
      <div class="detail-action-sep"></div>
      <button class="detail-action-btn pin-btn" data-pin="detail-panel" data-tooltip="Pin"><svg viewBox="0 0 24 24"><path d="M9 4v4.5L7.5 10H6v2h4v7l2 1 2-1v-7h4v-2h-1.5L15 8.5V4H9z" stroke-linejoin="round" stroke-linecap="round"/></svg></button>
      <button class="detail-action-btn detail-action-btn--close" id="detail-close" data-tooltip="Close">&times;</button>
    </div>
    <div class="detail-header-category">
      <div class="detail-header-dot" id="detail-header-dot"></div>
      <span class="detail-header-name" id="detail-category-label"></span>
    </div>
  </div>
  <div class="detail-body">
    <div class="detail-subheader">
      <div id="detail-importance"></div>
      <button class="detail-chip" id="detail-focus-btn" data-tooltip="Show only linked memories"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4m0 12v4m-7.07-14.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83"/></svg>Linked</button>
    </div>
    <div class="content-edit-wrap">
      <div id="detail-content"></div>
    </div>
    <div id="detail-tags" class="detail-section">
      <div class="detail-label">Tags</div>
      <div class="tag-chips" id="detail-tag-chips"></div>
    </div>
    <div id="detail-meta" class="detail-section">
      <div class="detail-label">Metadata</div>
      <div class="detail-meta" id="detail-meta-content"></div>
    </div>
    <div id="detail-files" class="detail-section" style="display:none">
      <div class="detail-label">Related Files</div>
      <div class="detail-meta" id="detail-files-content"></div>
    </div>
  </div>
</div>

<!-- Stats Bar -->
<div id="stats-bar" class="glass">
  <div>Memories: <span class="stat-value" id="stat-total">0</span></div>
  <div class="stat-divider"></div>
  <div>Visible: <span class="stat-value" id="stat-visible">0</span></div>
  <div class="stat-divider"></div>
  <div>Links: <span class="stat-value" id="stat-links">0</span></div>
  <div class="stat-divider"></div>
  <div id="stat-search-status"></div>
</div>

<!-- Background Canvas -->
<canvas id="bg-canvas"></canvas>

<!-- Hull Overlay Canvas -->
<canvas id="hull-canvas"></canvas>

<!-- Lasso Selection Canvas -->
<canvas id="lasso-canvas"></canvas>

<!-- Graph Container -->
<div id="graph-container"></div>

<!-- Minimap -->
<div id="minimap" class="glass">
  <canvas id="minimap-canvas" width="200" height="140"></canvas>
</div>

<!-- Context Menu -->
<div id="context-menu" class="glass">
  <div class="ctx-item" data-action="open">Open Memory</div>
  <div class="ctx-item" data-action="edit">Edit Memory</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="move">Move to Category...</div>
  <div class="ctx-item" data-action="pin">Pin / Unpin</div>
  <div class="ctx-item" data-action="focus">Focus: Show Linked</div>
  <div class="ctx-sep"></div>
  <div class="ctx-item" data-action="bookmark">Add to Bookmarks</div>
  <div class="ctx-item ctx-item--danger" data-action="trash">Move to Trash</div>
</div>

<!-- Multi-Select Bar -->
<div id="multi-select-bar" class="glass">
  <span id="multi-select-count">0 selected</span>
  <button id="multi-select-move">Move Category</button>
  <button id="multi-select-export">Export</button>
  <button id="multi-select-trash">Trash</button>
  <button id="multi-select-clear">Clear</button>
</div>

<script type="module">
// ═══════════════════════════════════════════
// IMPORTS
// ═══════════════════════════════════════════
import ForceGraph from 'https://esm.sh/force-graph@1.51.0';

// ═══════════════════════════════════════════
// TOOLTIP SYSTEM (body-appended, overflow-proof)
// ═══════════════════════════════════════════
{
  const tip = document.createElement('div');
  tip.className = 'ui-tooltip';
  tip.innerHTML = '<span class="ui-tooltip-arrow"></span><span class="ui-tooltip-text"></span>';
  document.body.appendChild(tip);

  let showTimer = null;
  let hideTimer = null;
  let currentTarget = null;

  function positionTip(el) {
    const r = el.getBoundingClientRect();
    const tw = tip.offsetWidth;
    const th = tip.offsetHeight;
    const gap = 8;
    let top = r.top - th - gap;
    let placement = 'above';
    if (top < 4) {
      top = r.bottom + gap;
      placement = 'below';
    }
    let left = r.left + r.width / 2 - tw / 2;
    if (left < 4) left = 4;
    if (left + tw > window.innerWidth - 4) left = window.innerWidth - 4 - tw;
    tip.className = 'ui-tooltip ' + placement;
    tip.style.top = top + 'px';
    tip.style.left = left + 'px';
    const arrowLeft = r.left + r.width / 2 - left;
    tip.querySelector('.ui-tooltip-arrow').style.left = arrowLeft + 'px';
    tip.querySelector('.ui-tooltip-arrow').style.transform = 'translateX(-50%)';
  }

  function show(el) {
    const text = el.getAttribute('data-tooltip');
    if (!text) return;
    clearTimeout(hideTimer);
    tip.querySelector('.ui-tooltip-text').textContent = text;
    currentTarget = el;
    tip.style.display = 'block';
    tip.offsetHeight;
    positionTip(el);
    tip.classList.add('visible');
  }

  function hide() {
    clearTimeout(showTimer);
    clearTimeout(hideTimer);
    showTimer = null;
    currentTarget = null;
    tip.classList.remove('visible');
    hideTimer = setTimeout(() => { tip.style.display = 'none'; }, 150);
  }

  document.addEventListener('mouseover', (e) => {
    const el = e.target.closest('[data-tooltip]');
    if (!el) return;
    if (el === currentTarget) { clearTimeout(hideTimer); return; }
    clearTimeout(showTimer);
    clearTimeout(hideTimer);
    if (currentTarget) {
      hide();
      show(el);
    } else {
      showTimer = setTimeout(() => show(el), 300);
    }
  });

  document.addEventListener('mouseout', (e) => {
    const el = e.target.closest('[data-tooltip]');
    if (!el) return;
    const related = e.relatedTarget;
    if (related && el.contains(related)) return;
    hide();
  });

  document.addEventListener('scroll', hide, true);
  document.addEventListener('pointerdown', hide, true);
}

// ═══════════════════════════════════════════
// CONSTANTS
// ═══════════════════════════════════════════
const DEFAULT_COLOR = '#888888';

const COLOR_PALETTE = [
  '#7BA3C4', '#8AAF7A', '#C4A84E', '#C08050', '#6BAABE',
  '#9A9A9A', '#6B8AC4', '#C47A8E', '#C4AA5E', '#A870B8',
  '#5EA898', '#C47A5E', '#7E6AAE', '#5EB0B8', '#B0B85E',
  '#B06A4E', '#6AB898', '#B090C0', '#C4A060', '#60A0B8',
  '#90B060', '#50A8B8', '#9080B0', '#C06868', '#A05050',
  '#60B8A8', '#6A80B8', '#C06080',
];

let allCategoryNames = [];
let categoryDescriptions = {};

function catColor(category) {
  try {
    const overrides = JSON.parse(localStorage.getItem('neural-category-colors') || '{}');
    if (overrides[category]) return overrides[category];
  } catch {}
  if (categoryMetadata[category]?.color) {
    return categoryMetadata[category].color;
  }
  const idx = allCategoryNames.indexOf(category);
  if (idx >= 0) return COLOR_PALETTE[idx % COLOR_PALETTE.length];
  let hash = 0;
  for (let i = 0; i < category.length; i++) hash = ((hash << 5) - hash + category.charCodeAt(i)) | 0;
  return COLOR_PALETTE[Math.abs(hash) % COLOR_PALETTE.length];
}

function upgradeSelect(selectEl) {
  if (!selectEl) return null;
  if (selectEl.dataset.upgraded) {
    const existing = selectEl.closest('.styled-select');
    if (existing && existing._refresh) { existing._refresh(); return existing; }
  }
  selectEl.dataset.upgraded = '1';
  selectEl.style.display = 'none';
  const wrapper = document.createElement('div');
  wrapper.className = 'styled-select';
  const trigger = document.createElement('button');
  trigger.type = 'button';
  trigger.className = 'styled-select-trigger';
  const menu = document.createElement('div');
  menu.className = 'styled-select-menu';

  function updateTrigger() {
    trigger.innerHTML = '';
    const sel = selectEl.options[selectEl.selectedIndex];
    if (sel && sel.value) {
      const dot = document.createElement('span');
      dot.className = 'styled-select-dot';
      dot.style.background = catColor(sel.value);
      trigger.appendChild(dot);
    }
    const lbl = document.createElement('span');
    lbl.className = 'styled-select-label';
    lbl.textContent = sel ? sel.textContent : '';
    trigger.appendChild(lbl);
  }

  function buildOptions() {
    menu.innerHTML = '';
    Array.from(selectEl.options).forEach(opt => {
      const row = document.createElement('div');
      row.className = 'styled-select-option' + (opt.value === selectEl.value ? ' active' : '');
      if (opt.value) {
        const dot = document.createElement('span');
        dot.className = 'styled-select-dot';
        dot.style.background = catColor(opt.value);
        row.appendChild(dot);
      }
      const lbl = document.createElement('span');
      lbl.textContent = opt.textContent;
      row.appendChild(lbl);
      row.addEventListener('click', () => {
        selectEl.value = opt.value;
        selectEl.dispatchEvent(new Event('change', { bubbles: true }));
        updateTrigger();
        buildOptions();
        wrapper.classList.remove('open');
      });
      menu.appendChild(row);
    });
  }

  trigger.addEventListener('click', (e) => {
    e.stopPropagation();
    document.querySelectorAll('.styled-select.open').forEach(s => {
      if (s !== wrapper) s.classList.remove('open');
    });
    const opening = wrapper.classList.toggle('open');
    if (opening) buildOptions();
  });

  document.addEventListener('click', (e) => {
    if (!wrapper.contains(e.target)) wrapper.classList.remove('open');
  });

  selectEl.parentNode.insertBefore(wrapper, selectEl);
  wrapper.appendChild(trigger);
  wrapper.appendChild(menu);
  wrapper.appendChild(selectEl);
  wrapper._refresh = () => { updateTrigger(); buildOptions(); };
  updateTrigger();
  return wrapper;
}

function hexAlpha(hex, alpha) {
  const c = parseInt(hex.replace('#', ''), 16);
  return `rgba(${(c >> 16) & 255},${(c >> 8) & 255},${c & 255},${alpha})`;
}

function importanceToRadius(importance) {
  return 2 + (importance - 1) * 0.5; // 2 to 6.5
}

function truncate(str, len) {
  if (!str) return '';
  return str.length > len ? str.slice(0, len) + '...' : str;
}

// ═══════════════════════════════════════════
// GFX CONFIG (2D-specific, simplified)
// ═══════════════════════════════════════════
const GFX_DEFAULTS_2D = {
  chargeStrength: -80,
  linkDistanceBase: 50,
  alphaDecay: 0.025,
  velocityDecay: 0.35,
  linkOpacity: 0.15,
  nodeSizeMultiplier: 1.0,
  labelThreshold: 7,
  hullOpacity: 0.10,
  bgDotGrid: true,
};

function loadGfxConfig() {
  try {
    const saved = JSON.parse(localStorage.getItem('neural-gfx-config-2d') || '{}');
    return { ...GFX_DEFAULTS_2D, ...saved };
  } catch { return { ...GFX_DEFAULTS_2D }; }
}
function saveGfxConfig(cfg) {
  const diff = {};
  for (const k in cfg) {
    if (cfg[k] !== GFX_DEFAULTS_2D[k]) diff[k] = cfg[k];
  }
  localStorage.setItem('neural-gfx-config-2d', JSON.stringify(diff));
}
const gfx = loadGfxConfig();

// Apply saved UI scale
(function() {
  const s = parseFloat(localStorage.getItem('neural-ui-scale') || '1');
  if (s !== 1) document.documentElement.style.setProperty('--ui-scale', s);
})();

// ═══════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════
const _categoryLogos = new Map();
function preloadCategoryLogos(categories) {
  const names = new Set(categories.map(c => c.name));
  for (const [k] of _categoryLogos) { if (!names.has(k)) _categoryLogos.delete(k); }
  for (const cat of categories) {
    if (!cat.logo) continue;
    const existing = _categoryLogos.get(cat.name);
    if (existing && existing.src === cat.logo) continue;
    const img = new Image();
    const entry = { img, ready: false, src: cat.logo };
    img.onload = () => { entry.ready = true; };
    img.onerror = () => { _categoryLogos.delete(cat.name); };
    img.src = cat.logo;
    _categoryLogos.set(cat.name, entry);
  }
}

let allNodes = [];
let allLinks = [];
let activeCategories = new Set();
let selectedNodeId = null;
let hoveredNodeId = null;
let focusedNodeId = null;
let searchResults = null;
let labelsVisible = true;
let labelSizeMultiplier = 1.0;
let graph = null;
let graphRemovalTimer = null;

// 2D-specific state
let _hullsVisible = true;
let _minimapVisible = true;
let _lassoActive = false;
let _lassoStart = null;
let _lassoEnd = null;
let _multiSelected = new Set();
let _contextMenuNode = null;
let _visualLinks = [];
let _crossCategoryLinks = [];
let _nodeById = new Map();
let _linkMode = 'all'; // 'off' | 'intra' | 'all'
let _linkTypeFilter = 'all'; // 'all' | specific type
let categoryMetadata = {};

// Drag state for rigid-body group movement
const _drag = {
  active: false,
  node: null,
  type: null,        // 'anchor' | 'tag' | 'memory'
  dragSet: new Set(), // Node IDs moving as rigid body
  prevPos: null,
};

function scheduleGraphRemoval(delay = 600) {
  if (graphRemovalTimer) clearTimeout(graphRemovalTimer);
  graphRemovalTimer = setTimeout(() => {
    graphRemovalTimer = null;
    applyGraphData();
    updateStats();
  }, delay);
}
function cancelScheduledRemoval() {
  if (graphRemovalTimer) {
    clearTimeout(graphRemovalTimer);
    graphRemovalTimer = null;
  }
}

// ═══════════════════════════════════════════
// DOM REFS
// ═══════════════════════════════════════════
const $loading = document.getElementById('loading-overlay');
const $searchInput = document.getElementById('search-input');
const $searchWrapper = document.getElementById('search-wrapper');
const $searchBadge = document.getElementById('search-badge');
const $searchClear = document.getElementById('search-clear');
const $categoryList = document.getElementById('category-list');
const $detailPanel = document.getElementById('detail-panel');
const $statTotal = document.getElementById('stat-total');
const $statVisible = document.getElementById('stat-visible');
const $statLinks = document.getElementById('stat-links');
const $statSearch = document.getElementById('stat-search-status');
const $tooltip = document.getElementById('tooltip');
const $bgCanvas = document.getElementById('bg-canvas');
const $hullCanvas = document.getElementById('hull-canvas');
const $lassoCanvas = document.getElementById('lasso-canvas');
const $minimap = document.getElementById('minimap');
const $minimapCanvas = document.getElementById('minimap-canvas');
const $contextMenu = document.getElementById('context-menu');
const $multiSelectBar = document.getElementById('multi-select-bar');

document.getElementById('category-clear-btn').addEventListener('click', () => {
  activeCategories.clear();
  document.querySelectorAll('.category-chip').forEach(c => c.classList.add('inactive'));
  document.querySelectorAll('.category-cluster-header').forEach(c => c.classList.add('inactive'));
  scheduleGraphRemoval();
});

document.getElementById('category-select-all-btn').addEventListener('click', () => {
  const presentCats = new Set(allNodes.map(n => n.payload.category));
  activeCategories = new Set([...presentCats, ...allCategoryNames]);
  document.querySelectorAll('.category-chip').forEach(c => c.classList.remove('inactive'));
  document.querySelectorAll('.category-cluster-header').forEach(c => c.classList.remove('inactive'));
  cancelScheduledRemoval();
  applyGraphData();
  updateStats();
});

// Label controls
const $labelToggle = document.getElementById('label-toggle-btn');
const $labelSlider = document.getElementById('label-size-slider');
const $labelSizeBtn = document.getElementById('label-size-btn');
let sliderOpen = false;

$labelToggle.addEventListener('click', () => {
  labelsVisible = !labelsVisible;
  $labelToggle.style.color = labelsVisible ? 'var(--t-primary)' : 'var(--t-muted)';
  $labelToggle.innerHTML = labelsVisible
    ? '<svg viewBox="0 0 24 24"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>'
    : '<svg viewBox="0 0 24 24"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>';
});

$labelSizeBtn.addEventListener('click', () => {
  sliderOpen = !sliderOpen;
  $labelSlider.style.opacity = sliderOpen ? '1' : '0';
  $labelSlider.style.pointerEvents = sliderOpen ? 'auto' : 'none';
  $labelSizeBtn.style.color = sliderOpen ? 'var(--t-primary)' : 'var(--t-muted)';
});

$labelSlider.addEventListener('input', (e) => {
  labelSizeMultiplier = parseFloat(e.target.value);
});

// ═══════════════════════════════════════════
// LOADING / INIT
// ═══════════════════════════════════════════
function showLoadingError(title, sub, canStart, serverOffline) {
  const $overlay = document.getElementById('loading-overlay');
  $overlay.classList.add('error');
  if (serverOffline) $overlay.classList.add('server-offline');
  else $overlay.classList.remove('server-offline');
  document.getElementById('loading-text').textContent = title;
  document.getElementById('loading-sub').textContent = sub;
  const $action = document.getElementById('loading-action');
  if (canStart) {
    $action.style.display = 'block';
    document.getElementById('loading-action-label').textContent = 'Start';
  } else {
    $action.style.display = 'none';
  }
  document.getElementById('loading-action-status').textContent = '';
}

async function handleStartAction() {
  const btn = document.getElementById('loading-action-btn');
  const $status = document.getElementById('loading-action-status');
  btn.disabled = true;
  document.getElementById('loading-action-label').textContent = 'Starting...';
  $status.textContent = 'This may take a moment...';
  try {
    const res = await fetch('/api/health/start', { method: 'POST' });
    const data = await res.json();
    if (data.ok && data.ready) {
      const $overlay = document.getElementById('loading-overlay');
      $overlay.classList.remove('error');
      document.getElementById('loading-text').textContent = 'Connecting';
      document.getElementById('loading-sub').textContent = 'Initializing neural pathways...';
      document.getElementById('loading-action').style.display = 'none';
      $status.textContent = '';
      init();
    } else {
      $status.textContent = data.error || 'Could not start. Try again.';
      btn.disabled = false;
      document.getElementById('loading-action-label').textContent = 'Retry';
    }
  } catch (err) {
    $status.textContent = 'Something went wrong. Try again.';
    btn.disabled = false;
    document.getElementById('loading-action-label').textContent = 'Retry';
  }
}

document.getElementById('loading-action-btn').addEventListener('click', handleStartAction);

document.getElementById('loading-cmd-copy').addEventListener('click', () => {
  const cmd = document.getElementById('loading-cmd-text').textContent;
  navigator.clipboard.writeText(cmd).then(() => {
    const btn = document.getElementById('loading-cmd-copy');
    btn.innerHTML = '<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
    btn.style.color = 'rgba(100,255,100,0.7)';
    setTimeout(() => {
      btn.innerHTML = '<svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>';
      btn.style.color = '';
    }, 1500);
  });
});

document.getElementById('loading-retry-btn').addEventListener('click', async () => {
  const $status = document.getElementById('loading-retry-status');
  $status.textContent = 'Checking...';
  try {
    const res = await fetch('/api/health', { signal: AbortSignal.timeout(3000) });
    if (res.ok) {
      $status.textContent = 'Connected! Loading...';
      const $overlay = document.getElementById('loading-overlay');
      $overlay.classList.remove('error', 'server-offline');
      document.getElementById('loading-text').textContent = 'Connecting';
      document.getElementById('loading-sub').textContent = 'Initializing neural pathways...';
      init();
    } else {
      $status.textContent = 'Server responded but is not ready yet';
      setTimeout(() => { $status.textContent = ''; }, 3000);
    }
  } catch {
    $status.textContent = 'Still offline — start the server and try again';
    setTimeout(() => { $status.textContent = ''; }, 3000);
  }
});

async function init() {
  try {
    try {
      const healthRes = await fetch('/api/health');
      const health = await healthRes.json();
      if (!health.ok) {
        const messages = {
          docker_not_running: ['Database Offline', 'The memory database needs to be started'],
          container_stopped:  ['Database Stopped', 'The memory database was stopped'],
          qdrant_unreachable: ['Database Unreachable', 'The database engine is not responding'],
          remote_unreachable: ['Connection Failed', health.detail || 'Cannot reach the remote database'],
          auth_error:         ['Authentication Error', health.detail || 'The database rejected the connection'],
        };
        const [title, sub] = messages[health.reason] || ['Connection Error', health.detail || 'Cannot connect to the database'];
        showLoadingError(title, sub, !!health.canAutoStart);
        return;
      }
    } catch {}

    const res = await fetch('/api/memories');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();

    allNodes = data.nodes;
    allLinks = data.links;
    $statTotal.textContent = allNodes.length;

    await fetchCategories();

    const presentCats = new Set(allNodes.map(n => n.payload.category));
    activeCategories = new Set([...presentCats, ...allCategoryNames]);

    buildCategorySidebar(presentCats);
    buildGraph();
    updateStats();
    initBackground();

    // Restore last selected or check view-switch handoff
    const switchNodeId = sessionStorage.getItem('neural-selected-node-switch');
    if (switchNodeId) {
      sessionStorage.removeItem('neural-selected-node-switch');
      const node = allNodes.find(n => n.id === switchNodeId);
      if (node) {
        selectedNodeId = switchNodeId;
        showDetailPanel(node);
        setTimeout(() => {
          if (graph) graph.centerAt(node.x, node.y, 500);
        }, 600);
      }
    } else {
      const savedNodeId = localStorage.getItem('neural-selected-node');
      if (savedNodeId) {
        const savedNode = allNodes.find(n => n.id === savedNodeId);
        if (savedNode) {
          selectedNodeId = savedNodeId;
          showDetailPanel(savedNode);
        }
      }
    }

    try { fetchTrashItems(); } catch {}

    setTimeout(() => $loading.classList.add('hidden'), 400);

  } catch (err) {
    console.error('Init error:', err);
    const isNetworkError = err.message === 'Failed to fetch' || err.name === 'TypeError';
    showLoadingError(
      isNetworkError ? 'Server Offline' : 'Connection Failed',
      isNetworkError ? 'The Neural Interface server is not running' : err.message,
      false,
      isNetworkError
    );
  }
}

// ═══════════════════════════════════════════
// POSITION PERSISTENCE (2D)
// ═══════════════════════════════════════════
const _posStorageKey = 'synabun-node-positions-2d';

function saveNodePositions() {
  if (!graph) return;
  const gd = graph.graphData();
  const positions = {};
  for (const n of gd.nodes) {
    if (n.x != null) {
      positions[n.id] = { x: n.x, y: n.y };
    }
  }
  try { localStorage.setItem(_posStorageKey, JSON.stringify(positions)); } catch (_) {}
}

function restoreNodePositions(nodes) {
  try {
    const saved = JSON.parse(localStorage.getItem(_posStorageKey) || '{}');
    if (!Object.keys(saved).length) return false;
    let restored = 0;
    for (const n of nodes) {
      if (saved[n.id]) {
        const pos = saved[n.id];
        n.x = pos.x; n.y = pos.y;
        n.fx = pos.x; n.fy = pos.y;
        restored++;
      }
    }
    return restored > 0;
  } catch (_) { return false; }
}

let _posSaveTimer = null;
function schedulePositionSave() {
  if (_posSaveTimer) clearTimeout(_posSaveTimer);
  _posSaveTimer = setTimeout(saveNodePositions, 2000);
}

// ═══════════════════════════════════════════
// BACKGROUND CANVAS (dot grid + flow lines)
// ═══════════════════════════════════════════
let _bgAnimId = null;
const _flowLines = [];

function initBackground() {
  const canvas = $bgCanvas;
  const ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // Generate flow lines
  _flowLines.length = 0;
  for (let i = 0; i < 7; i++) {
    _flowLines.push({
      points: [
        { x: Math.random() * canvas.width, y: Math.random() * canvas.height },
        { x: Math.random() * canvas.width, y: Math.random() * canvas.height },
        { x: Math.random() * canvas.width, y: Math.random() * canvas.height },
        { x: Math.random() * canvas.width, y: Math.random() * canvas.height },
      ],
      speed: 0.0002 + Math.random() * 0.0003,
      offset: Math.random() * Math.PI * 2,
    });
  }

  function drawBg(time) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = '#050808';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Dot grid
    if (gfx.bgDotGrid) {
      const spacing = 32;
      ctx.fillStyle = 'rgba(74, 90, 122, 0.07)';
      for (let x = spacing; x < canvas.width; x += spacing) {
        for (let y = spacing; y < canvas.height; y += spacing) {
          ctx.beginPath();
          ctx.arc(x, y, 0.6, 0, Math.PI * 2);
          ctx.fill();
        }
      }
    }

    // Flow lines
    ctx.strokeStyle = 'rgba(74, 90, 122, 0.025)';
    ctx.lineWidth = 1;
    for (const line of _flowLines) {
      const t = time * line.speed + line.offset;
      const pts = line.points;
      ctx.beginPath();
      const sx = pts[0].x + Math.sin(t) * 30;
      const sy = pts[0].y + Math.cos(t * 0.7) * 20;
      ctx.moveTo(sx, sy);
      for (let i = 1; i < pts.length; i++) {
        const px = pts[i].x + Math.sin(t + i) * 25;
        const py = pts[i].y + Math.cos(t * 0.8 + i) * 15;
        ctx.lineTo(px, py);
      }
      ctx.stroke();
    }

    _bgAnimId = requestAnimationFrame(drawBg);
  }

  _bgAnimId = requestAnimationFrame(drawBg);
}

window.addEventListener('resize', () => {
  $bgCanvas.width = window.innerWidth;
  $bgCanvas.height = window.innerHeight;
  $hullCanvas.width = window.innerWidth;
  $hullCanvas.height = window.innerHeight;
  $lassoCanvas.width = window.innerWidth;
  $lassoCanvas.height = window.innerHeight;
  if (graph) graph.width(window.innerWidth).height(window.innerHeight);
});

// ═══════════════════════════════════════════
// BUILD GRAPH (force-graph 2D)
// ═══════════════════════════════════════════
function buildGraph() {
  const container = document.getElementById('graph-container');

  graph = ForceGraph()(container)
    .backgroundColor('rgba(0,0,0,0)')
    .nodeId('id')
    .nodeLabel(() => '')
    .nodeCanvasObject(nodeCanvasObject)
    .nodePointerAreaPaint(nodePointerAreaPaint)
    .linkSource('source')
    .linkTarget('target')
    .linkCanvasObject(linkCanvasObject)
    .linkCanvasObjectMode(() => 'replace')
    .linkVisibility(l => {
      if (_linkMode === 'off') return false;
      if (_linkMode === 'intra' && l._crossCategory) return false;
      if (_linkTypeFilter !== 'all' && l.types && !l.types.includes(_linkTypeFilter)) return false;
      return true;
    })
    .onNodeHover(handleNodeHover)
    .onNodeClick(handleNodeClick)
    .onBackgroundClick(handleBackgroundClick)
    .onNodeDrag(node => {
      const gd = graph.graphData();

      if (!_drag.active) {
        _drag.active = true;
        _drag.node = node;
        const { type, dragSet } = _buildDragSet(node, gd.nodes);
        _drag.type = type;
        _drag.dragSet = dragSet;
        document.body.style.cursor = 'grabbing';
      }

      // Rigid-body translate: move all group members by same delta
      if (_drag.prevPos) {
        const dx = (node.x || 0) - _drag.prevPos.x;
        const dy = (node.y || 0) - _drag.prevPos.y;

        if (dx !== 0 || dy !== 0) {
          for (const n of gd.nodes) {
            if (n === node) continue;
            if (_drag.dragSet.has(n.id)) {
              n.x = (n.x || 0) + dx;
              n.y = (n.y || 0) + dy;
              n.fx = n.x; n.fy = n.y;
            }
          }
        }
      }
      _drag.prevPos = { x: node.x || 0, y: node.y || 0 };
    })
    .onNodeDragEnd(node => {
      if (!_drag.active) {
        node.fx = node.x; node.fy = node.y;
        schedulePositionSave();
        return;
      }

      // Pin the dragged node
      node.fx = node.x; node.fy = node.y;

      document.body.style.cursor = hoveredNodeId ? 'pointer' : '';
      _drag.active = false;
      _drag.node = null;
      _drag.type = null;
      _drag.dragSet = new Set();
      _drag.prevPos = null;
      schedulePositionSave();
    })
    .onBackgroundRightClick(() => {
      hideContextMenu();
    })
    .onRenderFramePost(() => {
      drawHulls();
      drawMinimap();
    })
    .d3AlphaDecay(gfx.alphaDecay)
    .d3VelocityDecay(gfx.velocityDecay)
    .warmupTicks(50)
    .cooldownTicks(200)
    .width(window.innerWidth)
    .height(window.innerHeight);

  // Custom forces
  graph.d3Force('charge').strength(gfx.chargeStrength);
  graph.d3Force('link').distance(l => l._isStructural ? gfx.linkDistanceBase : gfx.linkDistanceBase * 1.5);

  // Add cluster force (same-category attraction)
  graph.d3Force('cluster', clusterForce());

  // Double-click background: zoom to fit
  container.addEventListener('dblclick', (e) => {
    if (e.target.tagName === 'CANVAS' && !hoveredNodeId) {
      graph.zoomToFit(400, 60);
    }
  });

  // Double-click node: unpin
  let lastClickTime = 0;
  let lastClickNode = null;
  const origNodeClick = handleNodeClick;
  graph.onNodeClick((node, event) => {
    const now = Date.now();
    if (lastClickNode === node && now - lastClickTime < 400) {
      // Double-click: unpin
      node.fx = undefined;
      node.fy = undefined;
      graph.d3ReheatSimulation();
      lastClickNode = null;
      return;
    }
    lastClickTime = now;
    lastClickNode = node;
    origNodeClick(node, event);
  });

  // Right-click node: context menu
  container.addEventListener('contextmenu', (e) => {
    e.preventDefault();
  });

  // Apply data
  applyGraphData();
}

// ═══════════════════════════════════════════
// DRAG SET — determines which nodes move rigidly
// ═══════════════════════════════════════════
function _buildDragSet(node, allGraphNodes) {
  const dragSet = new Set();
  dragSet.add(node.id);

  if (node.payload && node.payload._isAnchor) {
    // Anchor drag: move anchor + all child tags + all memories in this category tree
    const anchorCat = node.payload._anchorCategory;
    const childCats = Object.entries(categoryMetadata)
      .filter(([, m]) => m.parent === anchorCat)
      .map(([name]) => name);
    const treeCats = new Set([anchorCat, ...childCats]);
    for (const n of allGraphNodes) {
      if (n === node) continue;
      if (n.payload._isTag && treeCats.has(n.payload._tagCategory)) dragSet.add(n.id);
      if (!n.payload._isAnchor && !n.payload._isTag && treeCats.has(n.payload.category)) dragSet.add(n.id);
    }
    return { type: 'anchor', dragSet };
  }

  if (node.payload && node.payload._isTag) {
    // Tag drag: move tag + all its memories
    const tagCat = node.payload._tagCategory;
    for (const n of allGraphNodes) {
      if (!n.payload._isAnchor && !n.payload._isTag && n.payload.category === tagCat) {
        dragSet.add(n.id);
      }
    }
    return { type: 'tag', dragSet };
  }

  return { type: 'memory', dragSet };
}

// ═══════════════════════════════════════════
// CLUSTER FORCE (same-category attraction)
// ═══════════════════════════════════════════
function clusterForce() {
  let nodes;
  const strength = 0.03;

  function force(alpha) {
    // Compute centroids per category
    const centroids = {};
    const counts = {};
    for (const n of nodes) {
      if (n.payload._isAnchor || n.payload._isTag) continue;
      const cat = n.payload.category;
      if (!centroids[cat]) { centroids[cat] = { x: 0, y: 0 }; counts[cat] = 0; }
      centroids[cat].x += n.x || 0;
      centroids[cat].y += n.y || 0;
      counts[cat]++;
    }
    for (const cat in centroids) {
      centroids[cat].x /= counts[cat];
      centroids[cat].y /= counts[cat];
    }

    // Apply gentle attraction toward centroid
    for (const n of nodes) {
      if (n.fx != null || n.payload._isAnchor || n.payload._isTag) continue;
      const cat = n.payload.category;
      if (!centroids[cat]) continue;
      n.vx += (centroids[cat].x - (n.x || 0)) * strength * alpha;
      n.vy += (centroids[cat].y - (n.y || 0)) * strength * alpha;
    }
  }

  force.initialize = (_nodes) => { nodes = _nodes; };
  return force;
}

// ═══════════════════════════════════════════
// NODE CANVAS OBJECT — 3-Level Semantic Zoom
// ═══════════════════════════════════════════
function nodeCanvasObject(node, ctx, globalScale) {
  const isAnchor = node.payload._isAnchor;
  const isTag = node.payload._isTag;
  const cat = node.payload.category;
  const color = catColor(cat);
  const importance = node.payload.importance || 5;
  const radius = importanceToRadius(importance) * gfx.nodeSizeMultiplier;
  const isSelected = node.id === selectedNodeId;
  const isHovered = node.id === hoveredNodeId;
  const isFocusTarget = node.id === focusedNodeId;
  const isMultiSelected = _multiSelected.has(node.id);

  // Opacity for search/focus dimming
  let opacity = 1;
  if (searchResults && !searchResults.has(node.id)) opacity = 0.12;
  if (focusedNodeId && focusedNodeId !== node.id) {
    // Check if neighbor
    const isNeighbor = _visualLinks.some(l => {
      const s = l.source.id || l.source;
      const t = l.target.id || l.target;
      return (s === focusedNodeId && t === node.id) || (t === focusedNodeId && s === node.id);
    });
    if (!isNeighbor && !isAnchor && !isTag) opacity = 0.15;
    else if (isNeighbor) opacity = 0.7;
  }

  // Skip nearly invisible nodes
  if (opacity < 0.05) return;

  ctx.globalAlpha = opacity;

  // ── LOD 0: Overview (zoom < 0.3) — tiny dots ──
  if (globalScale < 0.3) {
    if (isAnchor) {
      // Anchor: hexagon + category name
      ctx.fillStyle = color;
      drawHexagon(ctx, node.x, node.y, 6);
      ctx.fill();
      ctx.font = `bold ${12 / globalScale}px sans-serif`;
      ctx.fillStyle = color;
      ctx.textAlign = 'center';
      ctx.fillText(cat, node.x, node.y - 10 / globalScale);
    } else {
      // Dot
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(node.x, node.y, isSelected ? 4 : 2.5, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;
    return;
  }

  // ── LOD 1: Navigation (0.3 - 1.5) — circles + selective labels ──
  if (globalScale < 1.5) {
    if (isAnchor) {
      // Anchor hexagon
      const size = 22;
      ctx.fillStyle = hexAlpha(color, 0.3);
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      drawHexagon(ctx, node.x, node.y, size);
      ctx.fill();
      ctx.stroke();

      // Logo or name
      const logoEntry = _categoryLogos.get(cat);
      if (logoEntry && logoEntry.ready) {
        const imgSize = size * 1.2;
        ctx.drawImage(logoEntry.img, node.x - imgSize / 2, node.y - imgSize / 2, imgSize, imgSize);
      }

      // Label
      ctx.font = `bold ${14 / globalScale}px sans-serif`;
      ctx.fillStyle = color;
      ctx.textAlign = 'center';
      ctx.fillText(cat, node.x, node.y + size + 14 / globalScale);

      // Child count badge
      const childCount = allNodes.filter(n => n.payload.category === cat || (categoryMetadata[n.payload.category]?.parent === cat)).length;
      if (childCount) {
        ctx.font = `${10 / globalScale}px sans-serif`;
        ctx.fillStyle = hexAlpha(color, 0.6);
        ctx.fillText(`${childCount}`, node.x, node.y + size + 26 / globalScale);
      }
    } else if (isTag) {
      // Tag diamond
      const size = 8;
      ctx.fillStyle = hexAlpha(color, 0.4);
      ctx.strokeStyle = color;
      ctx.lineWidth = 1.5;
      drawDiamond(ctx, node.x, node.y, size);
      ctx.fill();
      ctx.stroke();
      ctx.font = `${11 / globalScale}px sans-serif`;
      ctx.fillStyle = color;
      ctx.textAlign = 'center';
      const tagName = node.payload._tagCategory || cat;
      ctx.fillText(tagName, node.x, node.y + size + 10 / globalScale);
    } else {
      // Memory circle
      const r = radius;

      // Outer glow ring
      if (isSelected || isHovered || isMultiSelected) {
        ctx.beginPath();
        ctx.arc(node.x, node.y, r + 4, 0, Math.PI * 2);
        ctx.fillStyle = hexAlpha(color, isSelected ? 0.3 : 0.2);
        ctx.fill();
      }

      // Main circle
      ctx.beginPath();
      ctx.arc(node.x, node.y, r, 0, Math.PI * 2);
      ctx.fillStyle = hexAlpha(color, 0.7);
      ctx.fill();
      ctx.strokeStyle = color;
      ctx.lineWidth = isSelected ? 2 : 1;
      ctx.stroke();

      // Pin indicator
      if (node.fx != null) {
        ctx.beginPath();
        ctx.arc(node.x + r, node.y - r, 2, 0, Math.PI * 2);
        ctx.fillStyle = '#fff';
        ctx.fill();
      }

      // Label for high-importance or hovered/selected nodes
      if (labelsVisible && (importance >= gfx.labelThreshold || isSelected || isHovered)) {
        const label = truncate(node.payload.content, 40);
        const fontSize = Math.max(3, 10 / globalScale * labelSizeMultiplier);
        ctx.font = `${fontSize}px sans-serif`;
        ctx.fillStyle = isSelected ? '#fff' : hexAlpha('#ffffff', 0.7);
        ctx.textAlign = 'center';
        ctx.fillText(label, node.x, node.y + r + fontSize + 2);
      }
    }
    ctx.globalAlpha = 1;
    return;
  }

  // ── LOD 2: Detail (zoom > 1.5) — full card rendering ──
  if (isAnchor) {
    const size = 30;
    ctx.fillStyle = hexAlpha(color, 0.25);
    ctx.strokeStyle = color;
    ctx.lineWidth = 2.5;
    drawHexagon(ctx, node.x, node.y, size);
    ctx.fill();
    ctx.stroke();

    // Glow ring
    ctx.beginPath();
    ctx.arc(node.x, node.y, size + 8, 0, Math.PI * 2);
    ctx.strokeStyle = hexAlpha(color, 0.15);
    ctx.lineWidth = 3;
    ctx.stroke();

    const logoEntry = _categoryLogos.get(cat);
    if (logoEntry && logoEntry.ready) {
      const imgSize = size * 1.2;
      ctx.drawImage(logoEntry.img, node.x - imgSize / 2, node.y - imgSize / 2, imgSize, imgSize);
    }

    ctx.font = `bold 14px sans-serif`;
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.fillText(cat, node.x, node.y + size + 18);
    ctx.globalAlpha = 1;
    return;
  }

  if (isTag) {
    const size = 12;
    ctx.fillStyle = hexAlpha(color, 0.35);
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    drawDiamond(ctx, node.x, node.y, size);
    ctx.fill();
    ctx.stroke();
    ctx.font = `bold 12px sans-serif`;
    ctx.fillStyle = color;
    ctx.textAlign = 'center';
    ctx.fillText(node.payload._tagCategory || cat, node.x, node.y + size + 14);
    ctx.globalAlpha = 1;
    return;
  }

  // Memory card
  const cardW = 180;
  const cardH = 80;
  const cardX = node.x - cardW / 2;
  const cardY = node.y - cardH / 2;
  const cardR = 8;

  // Card background
  ctx.fillStyle = isSelected ? hexAlpha(color, 0.15) : 'rgba(15, 18, 25, 0.85)';
  ctx.strokeStyle = isSelected ? color : hexAlpha(color, 0.4);
  ctx.lineWidth = isSelected ? 2 : 1;
  roundRect(ctx, cardX, cardY, cardW, cardH, cardR);
  ctx.fill();
  ctx.stroke();

  // Color bar on left
  ctx.fillStyle = color;
  ctx.fillRect(cardX, cardY + cardR, 3, cardH - cardR * 2);

  // Category label
  ctx.font = 'bold 8px sans-serif';
  ctx.fillStyle = color;
  ctx.textAlign = 'left';
  ctx.fillText(cat.toUpperCase(), cardX + 10, cardY + 14);

  // Content text (up to 3 lines)
  ctx.font = '10px sans-serif';
  ctx.fillStyle = '#c8ccd4';
  const content = node.payload.content || '';
  const lines = wrapText(ctx, content, cardW - 20, 3);
  lines.forEach((line, i) => {
    ctx.fillText(line, cardX + 10, cardY + 28 + i * 13);
  });

  // Importance stars
  const starY = cardY + cardH - 12;
  ctx.font = '9px sans-serif';
  ctx.fillStyle = '#c9a84c';
  ctx.textAlign = 'right';
  const stars = '\u2605'.repeat(Math.min(importance, 10));
  ctx.fillText(stars, cardX + cardW - 8, starY);

  // Pin indicator
  if (node.fx != null) {
    ctx.font = '9px sans-serif';
    ctx.fillStyle = '#888';
    ctx.textAlign = 'left';
    ctx.fillText('\uD83D\uDCCC', cardX + 10, starY);
  }

  ctx.globalAlpha = 1;
}

// Node pointer area paint (for hit detection)
function nodePointerAreaPaint(node, color, ctx, globalScale) {
  const isAnchor = node.payload._isAnchor;
  const isTag = node.payload._isTag;
  ctx.fillStyle = color;

  if (globalScale > 1.5 && !isAnchor && !isTag) {
    // Card mode hit area
    const cardW = 180;
    const cardH = 80;
    ctx.fillRect(node.x - cardW / 2, node.y - cardH / 2, cardW, cardH);
  } else {
    // Scale hit area inversely with zoom so anchors/tags stay easy to click when zoomed out
    const zoomBoost = Math.max(1, 2.5 / globalScale);
    const baseR = isAnchor ? 30 : isTag ? 16 : importanceToRadius(node.payload.importance || 5) * gfx.nodeSizeMultiplier + 4;
    const r = baseR * zoomBoost;
    ctx.beginPath();
    ctx.arc(node.x, node.y, r, 0, Math.PI * 2);
    ctx.fill();
  }
}

// ═══════════════════════════════════════════
// LINK CANVAS OBJECT
// ═══════════════════════════════════════════
function linkCanvasObject(link, ctx, globalScale) {
  if (globalScale < 0.3) return; // Hide links at overview zoom

  const src = link.source;
  const tgt = link.target;
  if (!src || !tgt || src.x == null || tgt.x == null) return;

  const srcColor = catColor((src.payload || {}).category || '');
  const tgtColor = catColor((tgt.payload || {}).category || '');
  const strength = link.strength || 0.3;
  const width = 0.5 + strength * 1.5;

  let linkOpacity = gfx.linkOpacity;
  // Highlight links for selected node
  if (selectedNodeId) {
    const srcId = src.id || src;
    const tgtId = tgt.id || tgt;
    if (srcId === selectedNodeId || tgtId === selectedNodeId) {
      linkOpacity = 0.7;
    } else {
      linkOpacity = 0.03;
    }
  }

  ctx.strokeStyle = hexAlpha(srcColor, linkOpacity);
  ctx.lineWidth = width / globalScale;
  ctx.beginPath();
  ctx.moveTo(src.x, src.y);
  ctx.lineTo(tgt.x, tgt.y);
  ctx.stroke();
}

// ═══════════════════════════════════════════
// DRAWING HELPERS
// ═══════════════════════════════════════════
function drawHexagon(ctx, cx, cy, r) {
  ctx.beginPath();
  for (let i = 0; i < 6; i++) {
    const angle = Math.PI / 3 * i - Math.PI / 6;
    const x = cx + r * Math.cos(angle);
    const y = cy + r * Math.sin(angle);
    if (i === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.closePath();
}

function drawDiamond(ctx, cx, cy, r) {
  ctx.beginPath();
  ctx.moveTo(cx, cy - r);
  ctx.lineTo(cx + r, cy);
  ctx.lineTo(cx, cy + r);
  ctx.lineTo(cx - r, cy);
  ctx.closePath();
}

function roundRect(ctx, x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

function wrapText(ctx, text, maxWidth, maxLines) {
  const words = text.replace(/\n/g, ' ').split(' ');
  const lines = [];
  let line = '';
  for (const word of words) {
    const test = line + (line ? ' ' : '') + word;
    if (ctx.measureText(test).width > maxWidth && line) {
      lines.push(line);
      if (lines.length >= maxLines) {
        lines[lines.length - 1] = lines[lines.length - 1].replace(/...$/, '') + '...';
        return lines;
      }
      line = word;
    } else {
      line = test;
    }
  }
  if (line) {
    if (lines.length >= maxLines) {
      lines[lines.length - 1] = lines[lines.length - 1] + '...';
    } else {
      lines.push(line);
    }
  }
  return lines;
}

// ═══════════════════════════════════════════
// NODE INTERACTION HANDLERS
// ═══════════════════════════════════════════
function handleNodeHover(node) {
  hoveredNodeId = node ? node.id : null;

  // Graph tooltip
  if (node && !node.payload._isAnchor) {
    const cat = node.payload.category;
    const content = truncate(node.payload.content || '', 120);
    const imp = node.payload.importance || 5;
    $tooltip.querySelector('#tooltip-category').textContent = cat;
    $tooltip.querySelector('#tooltip-category').style.color = catColor(cat);
    $tooltip.querySelector('#tooltip-preview').textContent = content;
    $tooltip.querySelector('#tooltip-importance').textContent = '\u2605'.repeat(imp);
    $tooltip.classList.add('visible');
  } else {
    $tooltip.classList.remove('visible');
  }

  document.body.style.cursor = node ? 'pointer' : '';
}

function handleNodeClick(node, event) {
  if (!node) return;

  // Right-click is handled separately
  if (event && event.button === 2) {
    showContextMenu(node, event);
    return;
  }

  if (node.payload._isAnchor || node.payload._isTag) {
    const cat = node.payload._anchorCategory || node.payload._tagCategory;
    if (!cat) return;

    // Ensure category is visible
    if (!activeCategories.has(cat)) {
      activeCategories.add(cat);
      const presentCats = new Set(allNodes.map(n => n.payload.category));
      buildCategorySidebar(presentCats);
      applyGraphData();
      updateStats();
    }

    // Gather all nodes in this category tree
    const gd = graph.graphData();
    let treeCats;
    if (node.payload._isAnchor) {
      const childCats = Object.entries(categoryMetadata)
        .filter(([, m]) => m.parent === cat)
        .map(([name]) => name);
      treeCats = new Set([cat, ...childCats]);
    } else {
      treeCats = new Set([cat]);
    }

    const treeNodes = gd.nodes.filter(n =>
      n.payload && (treeCats.has(n.payload.category) ||
        n.payload._anchorCategory === cat ||
        (n.payload._tagCategory && treeCats.has(n.payload._tagCategory)))
    );

    if (treeNodes.length === 0) return;

    // Compute bounding box and zoom to fit
    let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
    for (const n of treeNodes) {
      const x = n.x || 0, y = n.y || 0;
      if (x < minX) minX = x; if (x > maxX) maxX = x;
      if (y < minY) minY = y; if (y > maxY) maxY = y;
    }
    const cx = (minX + maxX) / 2;
    const cy = (minY + maxY) / 2;
    const spanX = (maxX - minX) || 60;
    const spanY = (maxY - minY) || 60;
    const pad = 80;
    const zoomX = window.innerWidth / (spanX + pad);
    const zoomY = window.innerHeight / (spanY + pad);
    const targetZoom = Math.min(zoomX, zoomY, 3);

    graph.centerAt(cx, cy, 800);
    graph.zoom(targetZoom, 800);
    return;
  }

  selectedNodeId = node.id;
  localStorage.setItem('neural-selected-node', node.id);
  showDetailPanel(node);
  graph.centerAt(node.x, node.y, 500);
}

function handleBackgroundClick() {
  selectedNodeId = null;
  focusedNodeId = null;
  localStorage.removeItem('neural-selected-node');
  $detailPanel.classList.remove('visible');
  $tooltip.classList.remove('visible');
  hideContextMenu();
  if (_multiSelected.size) {
    _multiSelected.clear();
    $multiSelectBar.classList.remove('visible');
  }
}

// ═══════════════════════════════════════════
// CONTEXT MENU
// ═══════════════════════════════════════════
function showContextMenu(node, event) {
  if (node.payload._isAnchor || node.payload._isTag) return;
  _contextMenuNode = node;
  $contextMenu.style.left = event.clientX + 'px';
  $contextMenu.style.top = event.clientY + 'px';
  $contextMenu.classList.add('visible');

  // Update pin text
  const pinItem = $contextMenu.querySelector('[data-action="pin"]');
  if (pinItem) pinItem.textContent = node.fx != null ? 'Unpin' : 'Pin';
}

function hideContextMenu() {
  $contextMenu.classList.remove('visible');
  _contextMenuNode = null;
}

$contextMenu.addEventListener('click', (e) => {
  const action = e.target.closest('.ctx-item')?.dataset.action;
  if (!action || !_contextMenuNode) return;
  const node = _contextMenuNode;
  hideContextMenu();

  switch (action) {
    case 'open':
      selectedNodeId = node.id;
      showDetailPanel(node);
      break;
    case 'edit':
      selectedNodeId = node.id;
      showDetailPanel(node);
      setTimeout(() => enterEditMode(node), 100);
      break;
    case 'move':
      openCategoryChangeModal(node);
      break;
    case 'pin':
      if (node.fx != null) {
        node.fx = undefined; node.fy = undefined;
        graph.d3ReheatSimulation();
      } else {
        node.fx = node.x; node.fy = node.y;
      }
      schedulePositionSave();
      break;
    case 'focus':
      focusedNodeId = focusedNodeId === node.id ? null : node.id;
      applyGraphData();
      break;
    case 'bookmark':
      toggleBookmark(node.id);
      break;
    case 'trash':
      deleteMemoryToTrash(node);
      break;
  }
});

// Close context menu on outside click
document.addEventListener('click', (e) => {
  if (!$contextMenu.contains(e.target)) hideContextMenu();
});

// ═══════════════════════════════════════════
// APPLY GRAPH DATA
// ═══════════════════════════════════════════
function applyGraphData() {
  if (!graph) return;

  let visibleNodes = allNodes.filter(n => activeCategories.has(n.payload.category));
  let visibleIds = new Set(visibleNodes.map(n => n.id));
  const nodeCatMap = {};
  for (const n of visibleNodes) nodeCatMap[n.id] = n.payload.category;

  // Separate same-category links from cross-category
  const sameCatLinks = [];
  _crossCategoryLinks = [];
  for (const l of allLinks) {
    const srcId = l.source.id || l.source;
    const tgtId = l.target.id || l.target;
    if (!visibleIds.has(srcId) || !visibleIds.has(tgtId)) continue;
    if (nodeCatMap[srcId] === nodeCatMap[tgtId]) {
      sameCatLinks.push(l);
    } else {
      _crossCategoryLinks.push({ ...l, _crossCategory: true });
    }
  }

  _visualLinks = _linkMode === 'all'
    ? [...sameCatLinks, ..._crossCategoryLinks]
    : [...sameCatLinks];
  let visibleLinks = [];

  // Anchor / Tag hierarchy injection
  const injectedNodes = [];
  const injectedLinks = [];
  const parentCats = Object.entries(categoryMetadata).filter(([, meta]) => meta.is_parent);

  const nodesByCat = new Map();
  for (const n of visibleNodes) {
    const cat = n.payload.category;
    let arr = nodesByCat.get(cat);
    if (!arr) { arr = []; nodesByCat.set(cat, arr); }
    arr.push(n);
  }

  for (const [parentName] of parentCats) {
    const childCats = Object.entries(categoryMetadata)
      .filter(([, m]) => m.parent === parentName)
      .map(([name]) => name);

    const parentMems = nodesByCat.get(parentName) || [];
    let hasTreeMemories = parentMems.length > 0;
    if (!hasTreeMemories) {
      for (const c of childCats) { if (nodesByCat.has(c)) { hasTreeMemories = true; break; } }
    }
    if (!hasTreeMemories) continue;

    const anchorId = `_anchor_${parentName}`;
    injectedNodes.push({
      id: anchorId,
      payload: { category: parentName, _isAnchor: true, _anchorCategory: parentName, importance: 10, content: parentName }
    });

    for (const childName of childCats) {
      const childMemories = nodesByCat.get(childName) || [];
      if (childMemories.length === 0) continue;

      const tagId = `_tag_${childName}`;
      injectedNodes.push({
        id: tagId,
        payload: { category: childName, _isTag: true, _tagCategory: childName, _parentAnchor: parentName, importance: 8, content: childName }
      });

      injectedLinks.push({ source: anchorId, target: tagId, strength: 0.3, _isStructural: true });
      for (const mem of childMemories) {
        injectedLinks.push({ source: tagId, target: mem.id, strength: 0.5, _isStructural: true });
      }
    }

    for (const mem of parentMems) {
      injectedLinks.push({ source: anchorId, target: mem.id, strength: 0.4, _isStructural: true });
    }
  }

  visibleNodes = [...injectedNodes, ...visibleNodes];
  visibleIds = new Set(visibleNodes.map(n => n.id));
  visibleLinks = injectedLinks;

  _nodeById = new Map();
  for (const n of visibleNodes) _nodeById.set(n.id, n);

  // Focus mode
  if (focusedNodeId && visibleIds.has(focusedNodeId)) {
    const neighborIds = new Set([focusedNodeId]);
    const allLinksForFocus = [...visibleLinks, ..._visualLinks];
    allLinksForFocus.forEach(l => {
      const srcId = l.source.id || l.source;
      const tgtId = l.target.id || l.target;
      if (srcId === focusedNodeId) neighborIds.add(tgtId);
      if (tgtId === focusedNodeId) neighborIds.add(srcId);
    });
    visibleNodes = visibleNodes.filter(n => neighborIds.has(n.id));
    visibleIds = neighborIds;
    visibleLinks = visibleLinks.filter(l => {
      const srcId = l.source.id || l.source;
      const tgtId = l.target.id || l.target;
      return neighborIds.has(srcId) && neighborIds.has(tgtId);
    });
    _visualLinks = _visualLinks.filter(l => {
      const srcId = l.source.id || l.source;
      const tgtId = l.target.id || l.target;
      return neighborIds.has(srcId) && neighborIds.has(tgtId);
    });
    _nodeById = new Map();
    for (const n of visibleNodes) _nodeById.set(n.id, n);
  }

  // Restore or let force simulation handle layout
  const hasSaved = restoreNodePositions(visibleNodes);

  graph.graphData({ nodes: visibleNodes, links: visibleLinks });

  // Pin restored positions
  if (hasSaved) {
    for (const n of visibleNodes) {
      if (n.fx == null && n.x != null) { n.fx = n.x; n.fy = n.y; }
    }
  }

  schedulePositionSave();
}

function updateStats() {
  const gd = graph ? graph.graphData() : { nodes: [], links: [] };
  const memoryNodes = gd.nodes.filter(n => n.payload && !n.payload._isAnchor && !n.payload._isTag);
  $statVisible.textContent = memoryNodes.length;
  $statLinks.textContent = _visualLinks.length;
}

// ═══════════════════════════════════════════
// CATEGORY MANAGEMENT
// ═══════════════════════════════════════════
async function fetchCategories() {
  try {
    const res = await fetch('/api/categories');
    if (!res.ok) return;
    const data = await res.json();
    allCategoryNames = data.categories.map(c => c.name);
    categoryDescriptions = {};
    categoryMetadata = {};
    data.categories.forEach(c => {
      categoryDescriptions[c.name] = c.description;
      categoryMetadata[c.name] = {
        parent: c.parent,
        color: c.color,
        description: c.description,
        is_parent: c.is_parent,
        _ephemeral: c._ephemeral,
        logo: c.logo,
      };
    });
    preloadCategoryLogos(data.categories);
  } catch (e) {
    console.error('fetchCategories error:', e);
  }
}

function closeColorPicker() {
  const existing = document.querySelector('.color-edit-picker');
  if (existing) existing.remove();
}

function openColorPicker(cat, chipEl) {
  closeColorPicker();
  const picker = document.createElement('div');
  picker.className = 'color-edit-picker';
  const row = document.createElement('div');
  row.className = 'color-swatch-row';
  const currentColor = catColor(cat);

  COLOR_PALETTE.forEach(color => {
    const swatch = document.createElement('button');
    swatch.className = 'color-swatch' + (color === currentColor ? ' selected' : '');
    swatch.style.background = color;
    swatch.addEventListener('click', (e) => {
      e.stopPropagation();
      applyCategoryColor(cat, color);
      closeColorPicker();
    });
    row.appendChild(swatch);
  });
  picker.appendChild(row);

  const overrides = JSON.parse(localStorage.getItem('neural-category-colors') || '{}');
  if (overrides[cat]) {
    const resetBtn = document.createElement('button');
    resetBtn.className = 'color-edit-reset';
    resetBtn.textContent = 'Reset to default';
    resetBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      applyCategoryColor(cat, null);
      closeColorPicker();
    });
    picker.appendChild(resetBtn);
  }

  chipEl.after(picker);
  setTimeout(() => {
    function onOutsideClick(e) {
      if (!picker.contains(e.target)) {
        closeColorPicker();
        document.removeEventListener('click', onOutsideClick);
      }
    }
    document.addEventListener('click', onOutsideClick);
  }, 0);
}

function applyCategoryColor(cat, color) {
  const overrides = JSON.parse(localStorage.getItem('neural-category-colors') || '{}');
  if (color === null) delete overrides[cat];
  else overrides[cat] = color;
  localStorage.setItem('neural-category-colors', JSON.stringify(overrides));
  const presentCats = new Set(allNodes.map(n => n.payload.category));
  buildCategorySidebar(presentCats);
}

function closeDescEditor() {
  const existing = document.querySelector('.category-desc-editor');
  if (existing) existing.remove();
}

function openDescEditor(cat, chipEl) {
  closeDescEditor();
  closeColorPicker();
  const editor = document.createElement('div');
  editor.className = 'category-desc-editor';
  const currentDesc = categoryDescriptions[cat] || '';
  editor.innerHTML = `
    <label>Description for "${cat}"</label>
    <textarea class="desc-textarea">${currentDesc}</textarea>
    <div class="category-desc-actions">
      <button class="desc-cancel-btn">Cancel</button>
      <button class="desc-save-btn">Save</button>
    </div>
  `;
  const textarea = editor.querySelector('.desc-textarea');
  editor.querySelector('.desc-cancel-btn').addEventListener('click', () => closeDescEditor());
  editor.querySelector('.desc-save-btn').addEventListener('click', async () => {
    const newDesc = textarea.value.trim();
    try {
      const res = await fetch('/api/categories/' + encodeURIComponent(cat), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ description: newDesc }),
      });
      if (res.ok) {
        categoryDescriptions[cat] = newDesc;
        closeDescEditor();
      }
    } catch (err) {
      console.error('Error saving description:', err);
    }
  });
  chipEl.after(editor);
}

// Helper to apply API response (refresh categories + graph)
function applyApiResponse(data) {
  if (data.categories) {
    allCategoryNames = data.categories.map(c => c.name);
    categoryDescriptions = {};
    categoryMetadata = {};
    data.categories.forEach(c => {
      categoryDescriptions[c.name] = c.description;
      categoryMetadata[c.name] = {
        parent: c.parent,
        color: c.color,
        description: c.description,
        is_parent: c.is_parent,
        _ephemeral: c._ephemeral,
        logo: c.logo,
      };
    });
    const presentCats = new Set(allNodes.map(n => n.payload.category));
    activeCategories = new Set([...presentCats, ...allCategoryNames]);
    buildCategorySidebar(presentCats);
    applyGraphData();
  }
}

// ═══════════════════════════════════════════
// FORMAT MEMORY CONTENT (markdown → HTML)
// ═══════════════════════════════════════════
function formatMemoryContent(text) {
  if (!text) return '';
  const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  function inlineFmt(s) {
    let out = esc(s);
    out = out.replace(/`([^`]+)`/g, '<code>$1</code>');
    out = out.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
    out = out.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
    out = out.replace(/ — (.+)$/, ' <span class="kv-desc">\u2014 $1</span>');
    return out;
  }
  const lines = text.split('\n');
  let html = '';
  let inList = false;
  let inCode = false;
  function closeList() { if (inList) { html += '</ul>'; inList = false; } }
  for (let i = 0; i < lines.length; i++) {
    const raw = lines[i];
    const trimmed = raw.trim();
    if (!trimmed) { if (inCode) { html += '\n'; continue; } closeList(); continue; }
    if (trimmed.startsWith('```')) {
      if (inCode) { html += '</div>'; inCode = false; }
      else { closeList(); inCode = true; html += '<div class="mc-codeblock">'; }
      continue;
    }
    if (inCode) { html += esc(raw) + '\n'; continue; }
    const headingMatch = trimmed.match(/^(#{1,4})\s+(.+)$/);
    if (headingMatch) { closeList(); const level = headingMatch[1].length; const cls = level <= 2 ? 'mc-h2' : level === 3 ? 'mc-h3' : 'mc-h4'; html += `<div class="${cls}">${inlineFmt(headingMatch[2])}</div>`; continue; }
    if (/^[-=_]{3,}$/.test(trimmed)) { closeList(); html += '<div class="mc-divider"></div>'; continue; }
    if (trimmed.startsWith('`') && trimmed.endsWith('`') && !trimmed.includes(' ')) { closeList(); html += `<p>${inlineFmt(trimmed)}</p>`; continue; }
    if (/^`[^`]+`\s+—\s+/.test(trimmed)) { closeList(); html += `<p>${inlineFmt(trimmed)}</p>`; continue; }
    if (/^[-*\u2022]\s/.test(trimmed) || /^\d+[.)]\s/.test(trimmed)) {
      if (!inList) { html += '<ul>'; inList = true; }
      const content = trimmed.replace(/^[-*\u2022]\s+/, '').replace(/^\d+[.)]\s+/, '');
      html += `<li>${inlineFmt(content)}</li>`; continue;
    }
    if (trimmed.endsWith(':') && trimmed.length < 50 && !trimmed.includes('`') && !/\s{2,}/.test(trimmed)) { closeList(); html += `<div class="mc-h3">${inlineFmt(trimmed.slice(0, -1))}</div>`; continue; }
    const kvMatch = trimmed.match(/^([A-Za-z][\w\s/().,-]{0,24}?)\s{2,}(.+)$/);
    if (kvMatch) { closeList(); html += `<div class="mc-kv"><span class="mc-kv-key">${esc(kvMatch[1])}</span> <span class="mc-kv-val">${inlineFmt(kvMatch[2])}</span></div>`; continue; }
    closeList();
    html += `<p>${inlineFmt(trimmed)}</p>`;
  }
  closeList();
  if (inCode) html += '</div>';
  return html;
}

function exportMemoryAsMarkdown(node) {
  const p = node.payload;
  const lines = [];
  const firstLine = (p.content || '').split('\n').find(l => l.trim()) || p.category || 'Memory';
  const title = firstLine.length > 80 ? firstLine.slice(0, 80) + '...' : firstLine;
  lines.push(`# ${title}`, '');
  lines.push('| Field | Value |', '|-------|-------|');
  lines.push(`| Category | ${p.category}${p.subcategory ? ' / ' + p.subcategory : ''} |`);
  lines.push(`| Importance | ${p.importance || 5}/10 |`);
  if (p.project) lines.push(`| Project | ${p.project} |`);
  if (p.source) lines.push(`| Source | ${p.source} |`);
  if (p.created_at) lines.push(`| Created | ${new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} |`);
  if (p.updated_at) lines.push(`| Updated | ${new Date(p.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} |`);
  lines.push(`| ID | \`${node.id}\` |`, '');
  const tags = (p.tags && Array.isArray(p.tags) && p.tags.length) ? p.tags : null;
  if (tags) { lines.push(`**Tags:** ${tags.map(t => '`' + t + '`').join(' ')}`, ''); }
  lines.push('## Content', '', p.content || '*(empty)*', '');
  if (p.related_files && p.related_files.length) { lines.push('## Related Files', ''); p.related_files.forEach(f => lines.push(`- \`${f}\``)); lines.push(''); }
  const md = lines.join('\n');
  const slug = (p.category + (p.subcategory ? '-' + p.subcategory : '')).replace(/[^a-zA-Z0-9-]/g, '-').toLowerCase();
  const contentSlug = (p.content || 'memory').split('\n')[0].trim().slice(0, 40).replace(/[^a-zA-Z0-9 ]/g, '').trim().replace(/\s+/g, '-').toLowerCase();
  const filename = `${slug}--${contentSlug || 'memory'}.md`;
  const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ═══════════════════════════════════════════
// DETAIL PANEL
// ═══════════════════════════════════════════
let _editingNode = null;

function showDetailPanel(node) {
  const p = node.payload;
  const color = catColor(p.category);

  document.getElementById('detail-header-dot').style.color = color;
  document.getElementById('detail-header-dot').style.background = color;
  const catLabel = document.getElementById('detail-category-label');
  catLabel.textContent = p.category + (p.subcategory ? ' / ' + p.subcategory : '');
  catLabel.style.color = color;

  const isOC = !!p._isOpenClaw;
  document.getElementById('detail-change-cat-btn').style.display = isOC ? 'none' : '';
  document.getElementById('detail-delete-inline-btn').style.display = isOC ? 'none' : '';
  document.getElementById('content-edit-btn').style.display = isOC ? 'none' : '';

  document.getElementById('detail-change-cat-btn').onclick = () => openCategoryChangeModal(node);

  // Delete button
  document.getElementById('detail-delete-inline-btn').onclick = () => {
    const overlay = document.createElement('div');
    overlay.className = 'tag-delete-overlay';
    overlay.innerHTML = `
      <div class="tag-delete-modal" style="max-width:380px">
        <div class="tag-delete-modal-title">Move to Trash</div>
        <p style="font-size:var(--fs-sm);color:var(--t-secondary);margin-bottom:6px">Move this memory to trash?</p>
        <p style="font-size:var(--fs-xs);color:var(--t-muted);margin-bottom:18px">You can restore it from the trash panel.</p>
        <div class="tag-delete-modal-actions">
          <button class="action-btn action-btn--ghost" id="del-cancel">Cancel</button>
          <button class="action-btn action-btn--danger" id="del-confirm">Move to Trash</button>
        </div>
      </div>
    `;
    document.body.appendChild(overlay);
    overlay.querySelector('#del-cancel').onclick = () => overlay.remove();
    overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
    overlay.querySelector('#del-confirm').onclick = () => {
      overlay.remove();
      deleteMemoryToTrash(node);
    };
  };

  // Bookmark
  updateDetailBookmarkBtn(node.id);
  document.getElementById('detail-export-md-btn').onclick = () => exportMemoryAsMarkdown(node);

  // Focus button
  const focusBtn = document.getElementById('detail-focus-btn');
  focusBtn.classList.toggle('active', focusedNodeId === node.id);
  focusBtn.onclick = () => {
    if (focusedNodeId === node.id) {
      focusedNodeId = null;
      focusBtn.classList.remove('active');
    } else {
      focusedNodeId = node.id;
      focusBtn.classList.add('active');
    }
    applyGraphData();
    updateStats();
  };

  // Importance dots
  const imp = p.importance || 5;
  const impEl = document.getElementById('detail-importance');
  impEl.innerHTML = '';
  for (let i = 1; i <= 10; i++) {
    const dot = document.createElement('span');
    dot.style.cssText = `display:inline-block;width:6px;height:6px;border-radius:50%;margin-right:4px;background:${i <= imp ? '#FFD700' : 'rgba(255,255,255,0.08)'};box-shadow:${i <= imp ? '0 0 4px rgba(255,215,0,0.4)' : 'none'}`;
    impEl.appendChild(dot);
  }

  // Content
  if (_editingNode) exitEditMode(_editingNode, false);
  const contentEl = document.getElementById('detail-content');
  contentEl.style.display = '';
  contentEl.innerHTML = formatMemoryContent(p.content);
  document.getElementById('content-edit-btn').onclick = () => enterEditMode(node);

  // Tags
  const tagContainer = document.getElementById('detail-tag-chips');
  tagContainer.innerHTML = '';
  const currentTags = (p.tags && Array.isArray(p.tags)) ? [...p.tags] : [];

  function renderEditableTags() {
    tagContainer.innerHTML = '';
    currentTags.forEach(tag => {
      const chip = document.createElement('span');
      chip.className = 'tag-chip';
      const text = document.createElement('span');
      text.className = 'tag-text';
      text.textContent = tag;
      chip.appendChild(text);
      if (!isOC) {
        const rm = document.createElement('span');
        rm.className = 'tag-remove';
        rm.textContent = '\u00d7';
        rm.addEventListener('click', (e) => {
          e.stopPropagation();
          showTagDeleteModal(tag, async () => {
            const idx = currentTags.indexOf(tag);
            if (idx !== -1) currentTags.splice(idx, 1);
            try {
              await fetch(`/api/memory/${node.id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tags: currentTags }) });
              node.payload.tags = [...currentTags];
            } catch (e) { console.error('Tag remove failed:', e); }
            renderEditableTags();
          });
        });
        chip.appendChild(rm);
      }
      tagContainer.appendChild(chip);
    });
    if (!isOC) {
      const input = document.createElement('input');
      input.className = 'tag-add-input';
      input.placeholder = '+ add tag';
      input.maxLength = 40;
      input.addEventListener('keydown', async (e) => {
        if (e.key === 'Enter' && input.value.trim()) {
          const newTag = input.value.trim().toLowerCase();
          if (currentTags.includes(newTag)) { input.value = ''; return; }
          currentTags.push(newTag);
          try {
            await fetch(`/api/memory/${node.id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ tags: currentTags }) });
            node.payload.tags = [...currentTags];
          } catch (e) { console.error('Tag add failed:', e); }
          renderEditableTags();
        }
      });
      tagContainer.appendChild(input);
    }
  }
  renderEditableTags();
  document.getElementById('detail-tags').style.display = '';

  // Metadata
  const meta = document.getElementById('detail-meta-content');
  meta.innerHTML = '';
  const addMeta = (label, value) => {
    if (!value) return;
    const row = document.createElement('div');
    row.className = 'detail-meta-row';
    row.innerHTML = `<span style="color:rgba(255,255,255,0.3)">${label}</span><span>${value}</span>`;
    meta.appendChild(row);
  };
  addMeta('Project', p.project);
  addMeta('Source', p.source);
  addMeta('Created', p.created_at ? new Date(p.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : null);
  addMeta('Updated', p.updated_at ? new Date(p.updated_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : null);
  addMeta('Accessed', p.access_count ? `${p.access_count} times` : null);
  {
    const idRow = document.createElement('div');
    idRow.className = 'detail-meta-row';
    idRow.innerHTML = `<span style="color:rgba(255,255,255,0.3)">ID</span><span>${truncate(node.id, 20)}<button class="meta-copy-btn" data-tooltip="Copy full ID">Copy</button></span>`;
    idRow.querySelector('.meta-copy-btn').addEventListener('click', () => {
      navigator.clipboard.writeText(node.id).then(() => {
        const btn = idRow.querySelector('.meta-copy-btn');
        btn.textContent = 'Copied!'; btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'Copy'; btn.classList.remove('copied'); }, 1500);
      });
    });
    meta.appendChild(idRow);
  }

  // Related files
  const filesDiv = document.getElementById('detail-files');
  const filesContent = document.getElementById('detail-files-content');
  if (p.related_files && p.related_files.length) {
    filesContent.innerHTML = p.related_files.map(f =>
      `<div style="font-family:'JetBrains Mono','SF Mono',Consolas,monospace;font-size:12px;color:rgba(255,255,255,0.45);padding:2px 0">${f}</div>`
    ).join('');
    filesDiv.style.display = '';
  } else {
    filesDiv.style.display = 'none';
  }

  // Restore panel position
  const savedDetail = localStorage.getItem('neural-panel-detail-panel');
  if (savedDetail) {
    try {
      const d = JSON.parse(savedDetail);
      if (d.left && d.left !== 'auto') {
        $detailPanel.style.left = d.left;
        $detailPanel.style.top = d.top || '20px';
        $detailPanel.style.right = 'auto';
      }
    } catch {}
  }
  $detailPanel.classList.add('open');
}

function showTagDeleteModal(tagName, onConfirm) {
  const overlay = document.createElement('div');
  overlay.className = 'tag-delete-overlay';
  overlay.innerHTML = `
    <div class="tag-delete-modal">
      <div class="tag-delete-modal-title">Remove tag</div>
      <div class="tag-delete-modal-tag">${tagName}</div>
      <div class="tag-delete-modal-actions">
        <button class="action-btn action-btn--ghost tag-modal-cancel">Cancel</button>
        <button class="action-btn action-btn--danger tag-modal-confirm">Delete</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  overlay.querySelector('.tag-modal-cancel').addEventListener('click', () => overlay.remove());
  overlay.querySelector('.tag-modal-confirm').addEventListener('click', () => { overlay.remove(); onConfirm(); });
  overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.remove(); });
}

function closeDetailPanel() {
  const wasFocused = focusedNodeId !== null;
  selectedNodeId = null;
  focusedNodeId = null;
  localStorage.removeItem('neural-selected-node');
  $detailPanel.classList.remove('open');
  document.getElementById('detail-focus-btn').classList.remove('active');
  $detailPanel.style.left = '';
  $detailPanel.style.top = '';
  $detailPanel.style.right = '';
  if (wasFocused) { applyGraphData(); updateStats(); }
}

document.getElementById('detail-close').addEventListener('click', closeDetailPanel);

// ═══════════════════════════════════════════
// EDIT MODE
// ═══════════════════════════════════════════
function enterEditMode(node) {
  _editingNode = node;
  const contentEl = document.getElementById('detail-content');
  const wrap = contentEl.parentElement;
  contentEl.style.display = 'none';
  const prev = wrap.querySelector('.md-editor-wrap');
  if (prev) prev.remove();

  const editor = document.createElement('div');
  editor.className = 'md-editor-wrap';
  const toolbar = document.createElement('div');
  toolbar.className = 'md-toolbar';
  const btnBold = document.createElement('button');
  btnBold.textContent = 'B'; btnBold.title = 'Bold'; btnBold.style.fontWeight = '700';
  const btnList = document.createElement('button');
  btnList.textContent = '\u2022 List'; btnList.title = 'Toggle list';
  const btnHeading = document.createElement('button');
  btnHeading.textContent = 'H'; btnHeading.title = 'Cycle heading';
  toolbar.append(btnBold, btnList, btnHeading);

  const textarea = document.createElement('textarea');
  textarea.className = 'md-textarea';
  textarea.value = node.payload.content || '';
  textarea.spellcheck = false;
  function autoResize() { textarea.style.height = 'auto'; textarea.style.height = Math.min(360, Math.max(120, textarea.scrollHeight)) + 'px'; }
  textarea.addEventListener('input', autoResize);

  const actions = document.createElement('div');
  actions.className = 'md-editor-actions';
  const btnCancel = document.createElement('button'); btnCancel.className = 'md-btn-cancel'; btnCancel.textContent = 'Cancel';
  const btnSave = document.createElement('button'); btnSave.className = 'md-btn-save'; btnSave.textContent = 'Save';
  actions.append(btnCancel, btnSave);
  editor.append(toolbar, textarea, actions);
  wrap.appendChild(editor);
  requestAnimationFrame(() => { textarea.focus(); autoResize(); });

  btnBold.addEventListener('click', () => {
    const start = textarea.selectionStart, end = textarea.selectionEnd, val = textarea.value, sel = val.substring(start, end);
    if (sel.startsWith('**') && sel.endsWith('**') && sel.length > 4) { textarea.value = val.substring(0, start) + sel.slice(2, -2) + val.substring(end); textarea.selectionStart = start; textarea.selectionEnd = end - 4; }
    else { textarea.value = val.substring(0, start) + '**' + sel + '**' + val.substring(end); textarea.selectionStart = start + 2; textarea.selectionEnd = end + 2; }
    textarea.focus();
  });

  btnList.addEventListener('click', () => {
    const start = textarea.selectionStart, end = textarea.selectionEnd, val = textarea.value;
    const lineStart = val.lastIndexOf('\n', start - 1) + 1;
    const lineEnd = val.indexOf('\n', end); const blockEnd = lineEnd === -1 ? val.length : lineEnd;
    const block = val.substring(lineStart, blockEnd); const lines = block.split('\n');
    const allList = lines.every(l => /^- /.test(l));
    const newLines = allList ? lines.map(l => l.replace(/^- /, '')) : lines.map(l => '- ' + l);
    const newBlock = newLines.join('\n');
    textarea.value = val.substring(0, lineStart) + newBlock + val.substring(blockEnd);
    textarea.selectionStart = lineStart; textarea.selectionEnd = lineStart + newBlock.length;
    textarea.focus();
  });

  btnHeading.addEventListener('click', () => {
    const start = textarea.selectionStart, end = textarea.selectionEnd, val = textarea.value;
    const lineStart = val.lastIndexOf('\n', start - 1) + 1;
    const lineEnd = val.indexOf('\n', end); const blockEnd = lineEnd === -1 ? val.length : lineEnd;
    const block = val.substring(lineStart, blockEnd); const lines = block.split('\n');
    const newLines = lines.map(l => { if (l.startsWith('### ')) return l.slice(4); if (l.startsWith('## ')) return '### ' + l.slice(3); return '## ' + l; });
    const newBlock = newLines.join('\n');
    textarea.value = val.substring(0, lineStart) + newBlock + val.substring(blockEnd);
    textarea.selectionStart = lineStart; textarea.selectionEnd = lineStart + newBlock.length;
    textarea.focus();
  });

  btnCancel.addEventListener('click', () => exitEditMode(node, false));
  btnSave.addEventListener('click', () => exitEditMode(node, true));
  textarea.addEventListener('keydown', (e) => { if (e.key === 'Escape') { e.preventDefault(); exitEditMode(node, false); } });
}

async function exitEditMode(node, save) {
  const contentEl = document.getElementById('detail-content');
  const wrap = contentEl.parentElement;
  const editor = wrap.querySelector('.md-editor-wrap');
  if (save && editor) {
    const textarea = editor.querySelector('.md-textarea');
    const newContent = textarea.value;
    try {
      const res = await fetch(`/api/memory/${node.id}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: newContent }) });
      if (!res.ok) throw new Error('Save failed');
      node.payload.content = newContent;
    } catch (err) { console.error('Content save failed:', err); }
  }
  if (editor) editor.remove();
  contentEl.style.display = '';
  contentEl.innerHTML = formatMemoryContent(node.payload.content);
  _editingNode = null;
}

// ═══════════════════════════════════════════
// SEARCH
// ═══════════════════════════════════════════
let searchTimeout = null;

$searchInput.addEventListener('focus', () => $searchWrapper.classList.add('focused'));
$searchInput.addEventListener('blur', () => $searchWrapper.classList.remove('focused'));

$searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  const query = $searchInput.value.trim();
  if (!query) { clearSearch(); return; }
  $searchClear.style.display = 'block';
  $searchBadge.classList.remove('visible');
  $statSearch.textContent = 'Searching...';
  searchTimeout = setTimeout(() => performSearch(query), 400);
});

async function performSearch(query) {
  try {
    const res = await fetch('/api/search', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ query, limit: 50 }),
    });
    if (!res.ok) throw new Error('Search failed');
    const data = await res.json();
    const ids = new Set(data.results.map(r => r.id));
    searchResults = ids;
    $searchBadge.textContent = ids.size;
    $searchBadge.classList.add('visible');
    $statSearch.textContent = `${ids.size} results`;

    // Center on results centroid
    if (ids.size && graph) {
      const gd = graph.graphData();
      const matched = gd.nodes.filter(n => ids.has(n.id));
      if (matched.length) {
        let cx = 0, cy = 0;
        matched.forEach(n => { cx += n.x || 0; cy += n.y || 0; });
        cx /= matched.length; cy /= matched.length;
        graph.centerAt(cx, cy, 500);
      }
    }
  } catch (e) {
    console.error('Search error:', e);
    $statSearch.textContent = 'Search error';
  }
}

function clearSearch() {
  searchResults = null;
  $searchInput.value = '';
  $searchClear.style.display = 'none';
  $searchBadge.classList.remove('visible');
  $statSearch.textContent = '';
}

$searchClear.addEventListener('click', clearSearch);

// ═══════════════════════════════════════════
// CATEGORY SIDEBAR
// ═══════════════════════════════════════════
function saveCategoryOrder(order) {
  localStorage.setItem('neural-category-order', JSON.stringify(order));
}

function buildCategorySidebar(presentCats) {
  if (!presentCats) presentCats = new Set(allNodes.map(n => n.payload.category));
  $categoryList.innerHTML = '';

  // Group categories by parent
  const parentGroups = {};
  const standalone = [];

  allCategoryNames.forEach(cat => {
    const meta = categoryMetadata[cat] || {};
    if (meta.is_parent) {
      if (!parentGroups[cat]) parentGroups[cat] = { children: [], count: 0 };
    } else if (meta.parent) {
      if (!parentGroups[meta.parent]) parentGroups[meta.parent] = { children: [], count: 0 };
      parentGroups[meta.parent].children.push(cat);
    } else {
      standalone.push(cat);
    }
  });

  // Count memories per category
  const catCounts = {};
  allNodes.forEach(n => {
    const c = n.payload.category;
    catCounts[c] = (catCounts[c] || 0) + 1;
  });

  function createChip(cat) {
    const chip = document.createElement('div');
    chip.className = 'category-chip' + (activeCategories.has(cat) ? '' : ' inactive');
    chip.dataset.cat = cat;
    const color = catColor(cat);
    const count = catCounts[cat] || 0;

    chip.innerHTML = `
      <span class="category-dot" style="background:${color}"></span>
      <span class="category-name">${cat}</span>
      <span class="category-count">${count}</span>
    `;

    chip.addEventListener('click', (e) => {
      if (e.target.closest('.category-dot')) {
        openColorPicker(cat, chip);
        return;
      }
      if (activeCategories.has(cat)) {
        activeCategories.delete(cat);
        chip.classList.add('inactive');
      } else {
        activeCategories.add(cat);
        chip.classList.remove('inactive');
      }
      scheduleGraphRemoval();
    });

    chip.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      openDescEditor(cat, chip);
    });

    return chip;
  }

  // Render parent groups
  for (const [parentName, group] of Object.entries(parentGroups)) {
    const cluster = document.createElement('div');
    cluster.className = 'category-cluster';

    const header = document.createElement('div');
    header.className = 'category-cluster-header' + (activeCategories.has(parentName) ? '' : ' inactive');
    header.dataset.cat = parentName;
    const pColor = catColor(parentName);
    const pCount = catCounts[parentName] || 0;
    const totalCount = pCount + group.children.reduce((s, c) => s + (catCounts[c] || 0), 0);

    header.innerHTML = `
      <span class="category-dot" style="background:${pColor}"></span>
      <span class="category-name">${parentName}</span>
      <span class="category-count">${totalCount}</span>
    `;

    header.addEventListener('click', (e) => {
      if (e.target.closest('.category-dot')) {
        openColorPicker(parentName, header);
        return;
      }
      // Toggle parent + all children
      const allCats = [parentName, ...group.children];
      const allActive = allCats.every(c => activeCategories.has(c));
      allCats.forEach(c => {
        if (allActive) activeCategories.delete(c);
        else activeCategories.add(c);
      });
      // Update chip styles
      cluster.querySelectorAll('.category-chip').forEach(ch => {
        ch.classList.toggle('inactive', !activeCategories.has(ch.dataset.cat));
      });
      header.classList.toggle('inactive', !activeCategories.has(parentName));
      scheduleGraphRemoval();
    });

    cluster.appendChild(header);

    // Child chips
    group.children.forEach(childCat => {
      cluster.appendChild(createChip(childCat));
    });

    // Direct parent memories chip (if any)
    if (pCount > 0 && !group.children.includes(parentName)) {
      // Already counted in parent header
    }

    $categoryList.appendChild(cluster);
  }

  // Standalone categories
  standalone.forEach(cat => {
    $categoryList.appendChild(createChip(cat));
  });

  initCategoryDrag();
}

function initCategoryDrag() {
  // Simplified drag-to-reorder for 2D (same concept as 3D)
  const el = document.getElementById('category-sidebar-body');
  if (!el) return;

  let dragEl = null;
  let clone = null;
  let dragTimeout = null;

  el.addEventListener('pointerdown', (e) => {
    const chip = e.target.closest('.category-chip');
    if (!chip) return;
    dragTimeout = setTimeout(() => {
      dragEl = chip;
      clone = chip.cloneNode(true);
      clone.className = 'category-chip dragging-clone';
      clone.style.cssText = `position:fixed;z-index:9999;pointer-events:none;opacity:0.8;left:${e.clientX-20}px;top:${e.clientY-10}px;`;
      document.body.appendChild(clone);
      chip.style.opacity = '0.3';
    }, 300);
  });

  el.addEventListener('pointermove', (e) => {
    if (!clone) return;
    clone.style.left = (e.clientX - 20) + 'px';
    clone.style.top = (e.clientY - 10) + 'px';
  });

  const cleanup = () => {
    clearTimeout(dragTimeout);
    if (clone) { clone.remove(); clone = null; }
    if (dragEl) { dragEl.style.opacity = ''; dragEl = null; }
  };

  el.addEventListener('pointerup', (e) => {
    if (dragEl) {
      // Find drop target
      const target = document.elementFromPoint(e.clientX, e.clientY);
      const targetChip = target?.closest('.category-chip');
      const targetHeader = target?.closest('.category-cluster-header');

      if (targetHeader && dragEl.dataset.cat) {
        // Reparent to this parent category
        const newParent = targetHeader.dataset.cat;
        const draggedCat = dragEl.dataset.cat;
        if (newParent !== draggedCat) {
          fetch('/api/categories/' + encodeURIComponent(draggedCat), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ parent: newParent }),
          }).then(r => r.json()).then(data => { if (data.categories) applyApiResponse(data); });
        }
      } else if (targetChip && targetChip !== dragEl) {
        // Reorder
        const chips = [...$categoryList.querySelectorAll('.category-chip')];
        const idx = chips.indexOf(targetChip);
        if (idx >= 0) {
          targetChip.before(dragEl);
          const newOrder = [...$categoryList.querySelectorAll('.category-chip')].map(c => c.dataset.cat);
          saveCategoryOrder(newOrder);
        }
      }
    }
    cleanup();
  });

  el.addEventListener('pointercancel', cleanup);
}

// ═══════════════════════════════════════════
// CATEGORY CHANGE MODAL
// ═══════════════════════════════════════════
function openCategoryChangeModal(node) {
  const overlay = document.createElement('div');
  overlay.className = 'tag-delete-overlay';
  overlay.innerHTML = `
    <div class="tag-delete-modal" style="max-width:380px">
      <div class="tag-delete-modal-title">Move to Category</div>
      <select class="modal-select" id="move-cat-select">
        ${allCategoryNames.map(c => `<option value="${c}" ${c === node.payload.category ? 'selected' : ''}>${c}</option>`).join('')}
      </select>
      <div class="tag-delete-modal-actions" style="margin-top:16px">
        <button class="action-btn action-btn--ghost" id="move-cancel">Cancel</button>
        <button class="action-btn action-btn--primary" id="move-confirm">Move</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);

  const select = overlay.querySelector('#move-cat-select');
  upgradeSelect(select);

  overlay.querySelector('#move-cancel').onclick = () => overlay.remove();
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  overlay.querySelector('#move-confirm').onclick = async () => {
    const newCat = select.value;
    if (newCat === node.payload.category) { overlay.remove(); return; }
    try {
      const res = await fetch(`/api/memory/${node.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ category: newCat }),
      });
      if (!res.ok) throw new Error('Move failed');
      node.payload.category = newCat;
      overlay.remove();
      showDetailPanel(node);
      const presentCats = new Set(allNodes.map(n => n.payload.category));
      buildCategorySidebar(presentCats);
      applyGraphData();
      updateStats();
    } catch (err) { console.error('Category change failed:', err); }
  };
}

// ═══════════════════════════════════════════
// CATEGORY CRUD
// ═══════════════════════════════════════════
// Create category form wiring
const $catForm = document.getElementById('category-create-form');
const $catNameInput = document.getElementById('cat-name-input');
const $catDescInput = document.getElementById('cat-desc-input');
const $catParentSelect = document.getElementById('cat-parent-select');
const $catFormError = document.getElementById('cat-form-error');
const $catFormCreate = document.getElementById('cat-form-create');

document.getElementById('category-add-btn').addEventListener('click', () => {
  $catForm.dataset.mode = 'child';
  document.getElementById('cat-form-title').textContent = 'Create Category';
  $catForm.classList.toggle('open');
  if ($catForm.classList.contains('open')) {
    $catParentSelect.innerHTML = '<option value="">(None - standalone category)</option>';
    Object.entries(categoryMetadata).filter(([, m]) => m.is_parent).forEach(([name]) => {
      $catParentSelect.innerHTML += `<option value="${name}">${name}</option>`;
    });
    upgradeSelect($catParentSelect);
    $catNameInput.focus();
  }
});

document.getElementById('category-add-parent-btn').addEventListener('click', () => {
  $catForm.dataset.mode = 'parent';
  document.getElementById('cat-form-title').textContent = 'Create Parent Category';
  $catForm.classList.toggle('open');
  if ($catForm.classList.contains('open')) {
    $catParentSelect.innerHTML = '<option value="">(Top-level parent)</option>';
    upgradeSelect($catParentSelect);
    $catNameInput.focus();
  }
});

document.getElementById('cat-form-cancel').addEventListener('click', () => {
  $catForm.classList.remove('open');
  $catNameInput.value = ''; $catDescInput.value = ''; $catFormError.textContent = '';
});

$catNameInput.addEventListener('input', () => {
  const valid = /^[a-z][a-z0-9-]{1,29}$/.test($catNameInput.value);
  $catFormCreate.disabled = !valid;
  $catFormError.textContent = $catNameInput.value && !valid ? 'lowercase, starts with letter, only a-z, 0-9, hyphens' : '';
});

$catFormCreate.addEventListener('click', async () => {
  const name = $catNameInput.value.trim();
  const desc = $catDescInput.value.trim();
  const isParent = $catForm.dataset.mode === 'parent';
  const parent = isParent ? undefined : ($catParentSelect.value || undefined);

  try {
    const res = await fetch('/api/categories', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, description: desc, parent, is_parent: isParent }),
    });
    const data = await res.json();
    if (!res.ok) { $catFormError.textContent = data.error || 'Error'; return; }
    $catForm.classList.remove('open');
    $catNameInput.value = ''; $catDescInput.value = ''; $catFormError.textContent = '';
    await fetchCategories();
    const presentCats = new Set(allNodes.map(n => n.payload.category));
    activeCategories = new Set([...presentCats, ...allCategoryNames]);
    buildCategorySidebar(presentCats);
  } catch (err) { $catFormError.textContent = err.message; }
});

// Color swatch row for create form
const $colorRow = document.getElementById('color-swatch-row');
COLOR_PALETTE.slice(0, 14).forEach(color => {
  const swatch = document.createElement('button');
  swatch.className = 'color-swatch';
  swatch.style.background = color;
  swatch.type = 'button';
  $colorRow.appendChild(swatch);
});

// ═══════════════════════════════════════════
// BOOKMARKS
// ═══════════════════════════════════════════
function getBookmarks() {
  try { return JSON.parse(localStorage.getItem('neural-bookmarks') || '[]'); } catch { return []; }
}

function saveBookmarks(list) {
  localStorage.setItem('neural-bookmarks', JSON.stringify(list));
  const badge = document.getElementById('bookmark-count');
  if (badge) badge.textContent = list.length || '';
}

function toggleBookmark(nodeId) {
  let bm = getBookmarks();
  const idx = bm.indexOf(nodeId);
  if (idx >= 0) bm.splice(idx, 1);
  else bm.push(nodeId);
  saveBookmarks(bm);
  updateDetailBookmarkBtn(nodeId);
  renderBookmarksList();
}

function updateDetailBookmarkBtn(nodeId) {
  const btn = document.getElementById('detail-bookmark-btn');
  if (!btn) return;
  const isBookmarked = getBookmarks().includes(nodeId);
  btn.classList.toggle('bookmarked', isBookmarked);
  btn.onclick = () => toggleBookmark(nodeId);
}

function renderBookmarksList() {
  const list = document.getElementById('bookmarks-list');
  if (!list) return;
  const bm = getBookmarks();
  if (!bm.length) { list.innerHTML = '<div style="padding:12px;color:var(--t-muted);font-size:12px">No bookmarks yet</div>'; return; }
  list.innerHTML = '';
  bm.forEach(id => {
    const node = allNodes.find(n => n.id === id);
    if (!node) return;
    const row = document.createElement('div');
    row.className = 'bookmark-row';
    row.innerHTML = `<span class="category-dot" style="background:${catColor(node.payload.category)}"></span><span>${truncate(node.payload.content, 50)}</span>`;
    row.addEventListener('click', () => {
      selectedNodeId = id;
      showDetailPanel(node);
      if (graph) graph.centerAt(node.x, node.y, 500);
    });
    list.appendChild(row);
  });
}

document.getElementById('bookmarks-btn').addEventListener('click', () => {
  const panel = document.getElementById('bookmarks-panel');
  panel.classList.toggle('visible');
  if (panel.classList.contains('visible')) renderBookmarksList();
});

// Init bookmark badge
saveBookmarks(getBookmarks());

// ═══════════════════════════════════════════
// DELETE / TRASH
// ═══════════════════════════════════════════
async function deleteMemoryToTrash(node) {
  try {
    const res = await fetch('/api/memory/' + encodeURIComponent(node.id), { method: 'DELETE' });
    if (!res.ok) { console.error('Delete failed'); return; }
    allNodes = allNodes.filter(n => n.id !== node.id);
    allLinks = allLinks.filter(l => l.source !== node.id && l.target !== node.id && l.source?.id !== node.id && l.target?.id !== node.id);
    closeDetailPanel();
    const presentCats = new Set(allNodes.map(n => n.payload.category));
    buildCategorySidebar(presentCats);
    applyGraphData();
    updateStats();
    try { fetchTrashItems(); } catch {}
  } catch (e) { console.error('Delete error:', e); }
}

let _trashItems = [];

async function fetchTrashItems() {
  try {
    const res = await fetch('/api/trash');
    if (!res.ok) return;
    const data = await res.json();
    _trashItems = data.items || [];
    const badge = document.getElementById('titlebar-trash-count');
    if (badge) badge.textContent = _trashItems.length || '';
  } catch {}
}

function openTrashPanel() {
  // Remove existing
  const existing = document.getElementById('trash-window');
  if (existing) { existing.remove(); return; }

  const win = document.createElement('div');
  win.id = 'trash-window';
  win.className = 'glass';
  win.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:420px;max-height:70vh;z-index:500;padding:16px;overflow-y:auto;border-radius:12px;';
  win.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h3 style="margin:0;color:var(--t-primary)">Trash</h3>
      <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:var(--t-muted);font-size:18px;cursor:pointer">&times;</button>
    </div>
    <div id="trash-list"></div>
  `;
  document.body.appendChild(win);
  renderTrashList();
}

function renderTrashList() {
  const list = document.getElementById('trash-list');
  if (!list) return;
  if (!_trashItems.length) {
    list.innerHTML = '<div style="color:var(--t-muted);padding:16px;text-align:center">Trash is empty</div>';
    return;
  }
  list.innerHTML = '';
  _trashItems.forEach(item => {
    const row = document.createElement('div');
    row.style.cssText = 'padding:8px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;justify-content:space-between;align-items:center;';
    row.innerHTML = `
      <div style="flex:1;min-width:0">
        <div style="font-size:12px;color:${catColor(item.payload?.category || '')}">${item.payload?.category || 'unknown'}</div>
        <div style="font-size:11px;color:var(--t-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${truncate(item.payload?.content || '', 60)}</div>
      </div>
      <div style="display:flex;gap:6px;margin-left:8px">
        <button class="trash-restore" data-id="${item.id}" style="font-size:11px;padding:3px 8px;border-radius:4px;border:1px solid var(--b-dim);background:none;color:var(--t-secondary);cursor:pointer">Restore</button>
        <button class="trash-delete" data-id="${item.id}" style="font-size:11px;padding:3px 8px;border-radius:4px;border:1px solid var(--accent-red);background:none;color:var(--accent-red);cursor:pointer">Delete</button>
      </div>
    `;
    list.appendChild(row);
  });

  list.querySelectorAll('.trash-restore').forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/trash/' + encodeURIComponent(btn.dataset.id) + '/restore', { method: 'POST' });
        if (res.ok) {
          // Reload memories
          const memRes = await fetch('/api/memories');
          if (memRes.ok) {
            const data = await memRes.json();
            allNodes = data.nodes;
            allLinks = data.links;
            const presentCats = new Set(allNodes.map(n => n.payload.category));
            activeCategories = new Set([...presentCats, ...allCategoryNames]);
            buildCategorySidebar(presentCats);
            applyGraphData();
            updateStats();
          }
          await fetchTrashItems();
          renderTrashList();
        }
      } catch (e) { console.error('Restore error:', e); }
    });
  });

  list.querySelectorAll('.trash-delete').forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        const res = await fetch('/api/trash/' + encodeURIComponent(btn.dataset.id), { method: 'DELETE' });
        if (res.ok) {
          await fetchTrashItems();
          renderTrashList();
        }
      } catch (e) { console.error('Permanent delete error:', e); }
    });
  });
}

document.getElementById('titlebar-trash-btn').addEventListener('click', openTrashPanel);

// ═══════════════════════════════════════════
// MINIMAP
// ═══════════════════════════════════════════
let _minimapThrottle = 0;

function drawMinimap() {
  if (!_minimapVisible || !graph) return;
  const now = performance.now();
  if (now - _minimapThrottle < 100) return; // Max ~10fps
  _minimapThrottle = now;

  const canvas = $minimapCanvas;
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;
  ctx.clearRect(0, 0, w, h);

  const gd = graph.graphData();
  if (!gd.nodes.length) return;

  // Find bounds
  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  gd.nodes.forEach(n => {
    if (n.x < minX) minX = n.x;
    if (n.x > maxX) maxX = n.x;
    if (n.y < minY) minY = n.y;
    if (n.y > maxY) maxY = n.y;
  });

  const pad = 20;
  const rangeX = (maxX - minX) || 1;
  const rangeY = (maxY - minY) || 1;
  const scale = Math.min((w - pad * 2) / rangeX, (h - pad * 2) / rangeY);

  const offsetX = (w - rangeX * scale) / 2;
  const offsetY = (h - rangeY * scale) / 2;

  // Draw nodes
  gd.nodes.forEach(n => {
    const mx = (n.x - minX) * scale + offsetX;
    const my = (n.y - minY) * scale + offsetY;
    const color = catColor(n.payload.category);
    ctx.fillStyle = n.id === selectedNodeId ? '#fff' : color;
    ctx.beginPath();
    ctx.arc(mx, my, n.payload._isAnchor ? 3 : 1.5, 0, Math.PI * 2);
    ctx.fill();
  });

  // Draw viewport rectangle
  const graphCenter = graph.centerAt();
  const zoom = graph.zoom();
  const vpW = window.innerWidth / zoom;
  const vpH = window.innerHeight / zoom;
  const vpX = (graphCenter.x - vpW / 2 - minX) * scale + offsetX;
  const vpY = (graphCenter.y - vpH / 2 - minY) * scale + offsetY;
  ctx.strokeStyle = 'rgba(255,255,255,0.5)';
  ctx.lineWidth = 1;
  ctx.strokeRect(vpX, vpY, vpW * scale, vpH * scale);

  $minimap.classList.toggle('visible', true);
}

// Minimap click-to-navigate
$minimapCanvas.addEventListener('click', (e) => {
  if (!graph) return;
  const rect = $minimapCanvas.getBoundingClientRect();
  const clickX = e.clientX - rect.left;
  const clickY = e.clientY - rect.top;

  const gd = graph.graphData();
  if (!gd.nodes.length) return;

  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  gd.nodes.forEach(n => {
    if (n.x < minX) minX = n.x;
    if (n.x > maxX) maxX = n.x;
    if (n.y < minY) minY = n.y;
    if (n.y > maxY) maxY = n.y;
  });

  const w = $minimapCanvas.width, h = $minimapCanvas.height;
  const pad = 20;
  const rangeX = (maxX - minX) || 1;
  const rangeY = (maxY - minY) || 1;
  const scale = Math.min((w - pad * 2) / rangeX, (h - pad * 2) / rangeY);
  const offsetX = (w - rangeX * scale) / 2;
  const offsetY = (h - rangeY * scale) / 2;

  const graphX = (clickX - offsetX) / scale + minX;
  const graphY = (clickY - offsetY) / scale + minY;
  graph.centerAt(graphX, graphY, 500);
});

// Minimap toggle
document.getElementById('minimap-toggle-btn').addEventListener('click', () => {
  _minimapVisible = !_minimapVisible;
  $minimap.classList.toggle('visible', _minimapVisible);
  document.getElementById('minimap-toggle-btn').classList.toggle('active', _minimapVisible);
});

// Category sidebar toggle
{
  const catSidebar = document.getElementById('category-sidebar');
  const catToggleBtn = document.getElementById('toggle-categories-btn');
  const catCloseBtn = document.getElementById('sidebar-close');

  function setCategoriesVisible(show) {
    catSidebar.style.display = show ? '' : 'none';
    catToggleBtn.classList.toggle('active', show);
  }

  catToggleBtn.addEventListener('click', () => {
    const isVisible = catSidebar.style.display !== 'none';
    setCategoriesVisible(!isVisible);
  });

  catCloseBtn.addEventListener('click', () => {
    setCategoriesVisible(false);
  });
}

// ═══════════════════════════════════════════
// HULL OVERLAYS
// ═══════════════════════════════════════════
let _hullThrottle = 0;

function drawHulls() {
  if (!_hullsVisible || !graph) {
    const ctx = $hullCanvas.getContext('2d');
    ctx.clearRect(0, 0, $hullCanvas.width, $hullCanvas.height);
    return;
  }
  const now = performance.now();
  if (now - _hullThrottle < 500) return;
  _hullThrottle = now;

  $hullCanvas.width = window.innerWidth;
  $hullCanvas.height = window.innerHeight;
  const ctx = $hullCanvas.getContext('2d');
  ctx.clearRect(0, 0, $hullCanvas.width, $hullCanvas.height);

  const gd = graph.graphData();
  const zoom = graph.zoom();
  const center = graph.centerAt();

  // Group nodes by category
  const catGroups = {};
  gd.nodes.forEach(n => {
    if (n.payload._isAnchor || n.payload._isTag) return;
    const cat = n.payload.category;
    if (!catGroups[cat]) catGroups[cat] = [];
    catGroups[cat].push(n);
  });

  // Convert graph coords to screen coords
  function toScreen(gx, gy) {
    return {
      x: (gx - center.x) * zoom + window.innerWidth / 2,
      y: (gy - center.y) * zoom + window.innerHeight / 2,
    };
  }

  for (const [cat, nodes] of Object.entries(catGroups)) {
    if (nodes.length < 3) continue;
    const color = catColor(cat);

    // Convert to screen points
    const points = nodes.map(n => toScreen(n.x, n.y));

    // Compute convex hull
    const hull = convexHull(points);
    if (hull.length < 3) continue;

    // Draw hull with padding
    ctx.beginPath();
    const pad = 20 * zoom;
    const cx = hull.reduce((s, p) => s + p.x, 0) / hull.length;
    const cy = hull.reduce((s, p) => s + p.y, 0) / hull.length;

    hull.forEach((p, i) => {
      const dx = p.x - cx, dy = p.y - cy;
      const dist = Math.sqrt(dx * dx + dy * dy) || 1;
      const px = p.x + (dx / dist) * pad;
      const py = p.y + (dy / dist) * pad;
      if (i === 0) ctx.moveTo(px, py);
      else ctx.lineTo(px, py);
    });
    ctx.closePath();
    ctx.fillStyle = hexAlpha(color, gfx.hullOpacity);
    ctx.strokeStyle = hexAlpha(color, gfx.hullOpacity * 2.5);
    ctx.lineWidth = 1;
    ctx.fill();
    ctx.stroke();

    // Category label at centroid
    ctx.font = 'bold 11px sans-serif';
    ctx.fillStyle = hexAlpha(color, 0.5);
    ctx.textAlign = 'center';
    ctx.fillText(cat, cx, cy);
  }
}

// Convex hull (Graham scan)
function convexHull(points) {
  if (points.length < 3) return points;
  const pts = [...points].sort((a, b) => a.x - b.x || a.y - b.y);
  const cross = (O, A, B) => (A.x - O.x) * (B.y - O.y) - (A.y - O.y) * (B.x - O.x);
  const lower = [];
  for (const p of pts) { while (lower.length >= 2 && cross(lower[lower.length - 2], lower[lower.length - 1], p) <= 0) lower.pop(); lower.push(p); }
  const upper = [];
  for (let i = pts.length - 1; i >= 0; i--) { const p = pts[i]; while (upper.length >= 2 && cross(upper[upper.length - 2], upper[upper.length - 1], p) <= 0) upper.pop(); upper.push(p); }
  upper.pop(); lower.pop();
  return lower.concat(upper);
}

// Hull toggle
document.getElementById('hull-toggle-btn').addEventListener('click', () => {
  _hullsVisible = !_hullsVisible;
  document.getElementById('hull-toggle-btn').classList.toggle('active', _hullsVisible);
  if (!_hullsVisible) {
    const ctx = $hullCanvas.getContext('2d');
    ctx.clearRect(0, 0, $hullCanvas.width, $hullCanvas.height);
  }
});

// ═══════════════════════════════════════════
// LASSO SELECT
// ═══════════════════════════════════════════
const $lassoCtx = $lassoCanvas.getContext('2d');
$lassoCanvas.width = window.innerWidth;
$lassoCanvas.height = window.innerHeight;

document.addEventListener('pointerdown', (e) => {
  if (!e.shiftKey || e.button !== 0) return;
  if (e.target.closest('#title-bar, #category-sidebar, #detail-panel, #minimap, .glass')) return;
  _lassoActive = true;
  _lassoStart = { x: e.clientX, y: e.clientY };
  _lassoEnd = { x: e.clientX, y: e.clientY };
  e.preventDefault();
});

document.addEventListener('pointermove', (e) => {
  if (!_lassoActive) return;
  _lassoEnd = { x: e.clientX, y: e.clientY };

  // Draw selection rect
  $lassoCtx.clearRect(0, 0, $lassoCanvas.width, $lassoCanvas.height);
  const x = Math.min(_lassoStart.x, _lassoEnd.x);
  const y = Math.min(_lassoStart.y, _lassoEnd.y);
  const w = Math.abs(_lassoEnd.x - _lassoStart.x);
  const h = Math.abs(_lassoEnd.y - _lassoStart.y);
  $lassoCtx.strokeStyle = 'rgba(100, 180, 255, 0.6)';
  $lassoCtx.fillStyle = 'rgba(100, 180, 255, 0.08)';
  $lassoCtx.lineWidth = 1;
  $lassoCtx.fillRect(x, y, w, h);
  $lassoCtx.strokeRect(x, y, w, h);
});

document.addEventListener('pointerup', (e) => {
  if (!_lassoActive) return;
  _lassoActive = false;
  $lassoCtx.clearRect(0, 0, $lassoCanvas.width, $lassoCanvas.height);

  if (!graph) return;
  const x1 = Math.min(_lassoStart.x, _lassoEnd.x);
  const y1 = Math.min(_lassoStart.y, _lassoEnd.y);
  const x2 = Math.max(_lassoStart.x, _lassoEnd.x);
  const y2 = Math.max(_lassoStart.y, _lassoEnd.y);

  // Only select if drag was meaningful
  if (x2 - x1 < 10 && y2 - y1 < 10) return;

  const zoom = graph.zoom();
  const center = graph.centerAt();
  _multiSelected.clear();

  const gd = graph.graphData();
  gd.nodes.forEach(n => {
    if (n.payload._isAnchor || n.payload._isTag) return;
    const sx = (n.x - center.x) * zoom + window.innerWidth / 2;
    const sy = (n.y - center.y) * zoom + window.innerHeight / 2;
    if (sx >= x1 && sx <= x2 && sy >= y1 && sy <= y2) {
      _multiSelected.add(n.id);
    }
  });

  if (_multiSelected.size) {
    document.getElementById('multi-select-count').textContent = _multiSelected.size + ' selected';
    $multiSelectBar.classList.add('visible');
  } else {
    $multiSelectBar.classList.remove('visible');
  }
});

// Multi-select bar actions
document.getElementById('multi-select-clear').addEventListener('click', () => {
  _multiSelected.clear();
  $multiSelectBar.classList.remove('visible');
});

document.getElementById('multi-select-trash').addEventListener('click', async () => {
  for (const id of _multiSelected) {
    try {
      await fetch('/api/memory/' + encodeURIComponent(id), { method: 'DELETE' });
      allNodes = allNodes.filter(n => n.id !== id);
    } catch {}
  }
  _multiSelected.clear();
  $multiSelectBar.classList.remove('visible');
  closeDetailPanel();
  const presentCats = new Set(allNodes.map(n => n.payload.category));
  buildCategorySidebar(presentCats);
  applyGraphData();
  updateStats();
  fetchTrashItems();
});

document.getElementById('multi-select-export').addEventListener('click', () => {
  for (const id of _multiSelected) {
    const node = allNodes.find(n => n.id === id);
    if (node) exportMemoryAsMarkdown(node);
  }
});

// ═══════════════════════════════════════════
// LAYOUT PRESETS
// ═══════════════════════════════════════════
const LAYOUT_PRESETS_2D = {
  'category-rings': {
    label: 'Category Rings',
    apply: () => {
      const gd = graph.graphData();
      const catGroups = {};
      gd.nodes.forEach(n => {
        if (n.payload._isAnchor || n.payload._isTag) return;
        const c = n.payload.category;
        if (!catGroups[c]) catGroups[c] = [];
        catGroups[c].push(n);
      });
      const cats = Object.keys(catGroups);
      const bigR = 200 + cats.length * 40;
      cats.forEach((cat, ci) => {
        const cAngle = (ci / cats.length) * Math.PI * 2;
        const cx = Math.cos(cAngle) * bigR;
        const cy = Math.sin(cAngle) * bigR;
        const nodes = catGroups[cat];
        const smallR = 30 + nodes.length * 5;
        nodes.forEach((n, ni) => {
          const a = (ni / nodes.length) * Math.PI * 2;
          n.fx = cx + Math.cos(a) * smallR;
          n.fy = cy + Math.sin(a) * smallR;
          n.x = n.fx; n.y = n.fy;
        });
      });
      // Pin anchors/tags at category centers
      gd.nodes.forEach(n => {
        if (n.payload._isAnchor) {
          const cat = n.payload._anchorCategory;
          const ci = cats.indexOf(cat);
          if (ci >= 0) {
            const cAngle = (ci / cats.length) * Math.PI * 2;
            n.fx = Math.cos(cAngle) * bigR;
            n.fy = Math.sin(cAngle) * bigR;
            n.x = n.fx; n.y = n.fy;
          }
        }
      });
      graph.graphData(gd);
      schedulePositionSave();
    }
  },
  'importance-grid': {
    label: 'Importance Grid',
    apply: () => {
      const gd = graph.graphData();
      const mems = gd.nodes.filter(n => !n.payload._isAnchor && !n.payload._isTag)
        .sort((a, b) => (b.payload.importance || 5) - (a.payload.importance || 5));
      const cols = Math.ceil(Math.sqrt(mems.length));
      const spacing = 60;
      mems.forEach((n, i) => {
        n.fx = (i % cols) * spacing - (cols * spacing) / 2;
        n.fy = Math.floor(i / cols) * spacing - (Math.ceil(mems.length / cols) * spacing) / 2;
        n.x = n.fx; n.y = n.fy;
      });
      graph.graphData(gd);
      schedulePositionSave();
    }
  },
  'timeline': {
    label: 'Timeline',
    apply: () => {
      const gd = graph.graphData();
      const mems = gd.nodes.filter(n => !n.payload._isAnchor && !n.payload._isTag)
        .sort((a, b) => new Date(a.payload.created_at || 0) - new Date(b.payload.created_at || 0));
      const spacing = 40;
      const catRows = {};
      mems.forEach((n, i) => {
        const cat = n.payload.category;
        if (catRows[cat] === undefined) catRows[cat] = Object.keys(catRows).length;
        n.fx = i * spacing - (mems.length * spacing) / 2;
        n.fy = catRows[cat] * 80;
        n.x = n.fx; n.y = n.fy;
      });
      graph.graphData(gd);
      graph.zoomToFit(400, 60);
      schedulePositionSave();
    }
  },
  'category-columns': {
    label: 'Category Columns',
    apply: () => {
      const gd = graph.graphData();
      const catGroups = {};
      gd.nodes.forEach(n => {
        if (n.payload._isAnchor || n.payload._isTag) return;
        const c = n.payload.category;
        if (!catGroups[c]) catGroups[c] = [];
        catGroups[c].push(n);
      });
      const cats = Object.keys(catGroups);
      const colSpacing = 120;
      const rowSpacing = 50;
      cats.forEach((cat, ci) => {
        const x = ci * colSpacing - (cats.length * colSpacing) / 2;
        catGroups[cat].forEach((n, ni) => {
          n.fx = x;
          n.fy = ni * rowSpacing;
          n.x = n.fx; n.y = n.fy;
        });
      });
      graph.graphData(gd);
      graph.zoomToFit(400, 60);
      schedulePositionSave();
    }
  },
  'force-default': {
    label: 'Force Default',
    apply: () => {
      const gd = graph.graphData();
      gd.nodes.forEach(n => { n.fx = undefined; n.fy = undefined; });
      graph.graphData(gd);
      graph.d3ReheatSimulation();
      localStorage.removeItem(_posStorageKey);
    }
  },
};

function renderPresetList() {
  const list = document.getElementById('preset-list');
  if (!list) return;
  list.innerHTML = '';

  // Built-in presets
  for (const [key, preset] of Object.entries(LAYOUT_PRESETS_2D)) {
    const row = document.createElement('div');
    row.className = 'preset-row';
    row.innerHTML = `<span>${preset.label}</span>`;
    row.addEventListener('click', () => {
      preset.apply();
      document.getElementById('layouts-panel').classList.remove('visible');
    });
    list.appendChild(row);
  }

  // User presets
  const userPresets = JSON.parse(localStorage.getItem('neural-user-presets-2d') || '{}');
  for (const [name, data] of Object.entries(userPresets)) {
    const row = document.createElement('div');
    row.className = 'preset-row';
    row.innerHTML = `
      <span>${name}</span>
      <button class="preset-delete" data-name="${name}" style="background:none;border:none;color:var(--accent-red);cursor:pointer;font-size:14px">&times;</button>
    `;
    row.addEventListener('click', (e) => {
      if (e.target.closest('.preset-delete')) {
        delete userPresets[name];
        localStorage.setItem('neural-user-presets-2d', JSON.stringify(userPresets));
        renderPresetList();
        return;
      }
      // Apply user preset positions
      const gd = graph.graphData();
      gd.nodes.forEach(n => {
        if (data[n.id]) { n.fx = data[n.id].x; n.fy = data[n.id].y; n.x = n.fx; n.y = n.fy; }
      });
      graph.graphData(gd);
      schedulePositionSave();
      document.getElementById('layouts-panel').classList.remove('visible');
    });
    list.appendChild(row);
  }
}

document.getElementById('layouts-btn').addEventListener('click', () => {
  const panel = document.getElementById('layouts-panel');
  panel.classList.toggle('visible');
  if (panel.classList.contains('visible')) renderPresetList();
});

// Save user preset
document.getElementById('preset-save-btn').addEventListener('click', () => {
  const nameInput = document.getElementById('preset-name-input');
  const name = nameInput.value.trim();
  const warn = document.getElementById('preset-warning');
  if (!name) return;
  const gd = graph.graphData();
  const pinned = gd.nodes.filter(n => n.fx != null);
  if (!pinned.length) { warn.style.display = 'block'; setTimeout(() => warn.style.display = 'none', 2000); return; }
  const positions = {};
  pinned.forEach(n => { positions[n.id] = { x: n.fx, y: n.fy }; });
  const userPresets = JSON.parse(localStorage.getItem('neural-user-presets-2d') || '{}');
  userPresets[name] = positions;
  localStorage.setItem('neural-user-presets-2d', JSON.stringify(userPresets));
  nameInput.value = '';
  renderPresetList();
});

// ═══════════════════════════════════════════
// LINK MODE + LINK TYPE TOGGLES
// ═══════════════════════════════════════════
const $linkToggle = document.getElementById('toggle-links-btn');
const $linkTypeBtn = document.getElementById('link-type-btn');
const LINK_MODES = ['off', 'intra', 'all'];
const LINK_MODE_LABELS = { off: 'Links Off', intra: 'Intra Links', all: 'All Links' };

$linkToggle.addEventListener('click', () => {
  const idx = LINK_MODES.indexOf(_linkMode);
  _linkMode = LINK_MODES[(idx + 1) % LINK_MODES.length];
  $linkToggle.textContent = LINK_MODE_LABELS[_linkMode];
  applyGraphData();
  updateStats();
});

const LINK_TYPES = ['all', 'similarity', 'files', 'family', 'tags', 'manual'];
$linkTypeBtn.addEventListener('click', () => {
  const idx = LINK_TYPES.indexOf(_linkTypeFilter);
  _linkTypeFilter = LINK_TYPES[(idx + 1) % LINK_TYPES.length];
  $linkTypeBtn.textContent = 'Show: ' + (_linkTypeFilter === 'all' ? 'All Types' : _linkTypeFilter);
});

// Reset positions
document.getElementById('reset-positions-btn').addEventListener('click', () => {
  const overlay = document.createElement('div');
  overlay.className = 'tag-delete-overlay';
  overlay.innerHTML = `
    <div class="tag-delete-modal">
      <div class="tag-delete-modal-title">Reset Layout</div>
      <p style="font-size:var(--fs-sm);color:var(--t-secondary);margin-bottom:16px">Clear all pinned positions and re-run force simulation?</p>
      <div class="tag-delete-modal-actions">
        <button class="action-btn action-btn--ghost" id="reset-cancel">Cancel</button>
        <button class="action-btn action-btn--danger" id="reset-confirm">Reset</button>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  overlay.querySelector('#reset-cancel').onclick = () => overlay.remove();
  overlay.addEventListener('click', e => { if (e.target === overlay) overlay.remove(); });
  overlay.querySelector('#reset-confirm').onclick = () => {
    overlay.remove();
    localStorage.removeItem(_posStorageKey);
    const gd = graph.graphData();
    gd.nodes.forEach(n => { n.fx = undefined; n.fy = undefined; });
    graph.graphData(gd);
    graph.d3ReheatSimulation();
  };
});

// ═══════════════════════════════════════════
// KEYBOARD SHORTCUTS
// ═══════════════════════════════════════════
document.addEventListener('keydown', (e) => {
  // Ignore when typing in inputs
  if (e.target.matches('input, textarea, select, [contenteditable]')) {
    if (e.key === 'Escape') e.target.blur();
    return;
  }

  switch (e.key) {
    case '/':
      e.preventDefault();
      $searchInput.focus();
      break;
    case 'Escape':
      if (document.querySelector('.tag-delete-overlay')) { document.querySelector('.tag-delete-overlay').remove(); break; }
      if ($detailPanel.classList.contains('open')) { closeDetailPanel(); break; }
      if (searchResults) { clearSearch(); break; }
      if (_multiSelected.size) { _multiSelected.clear(); $multiSelectBar.classList.remove('visible'); break; }
      break;
    case '?':
      document.getElementById('help-overlay').classList.toggle('visible');
      break;
    case 'f':
    case 'F':
      if (selectedNodeId) {
        focusedNodeId = focusedNodeId === selectedNodeId ? null : selectedNodeId;
        const focusBtn = document.getElementById('detail-focus-btn');
        focusBtn.classList.toggle('active', focusedNodeId === selectedNodeId);
        applyGraphData();
        updateStats();
      }
      break;
    case 'l':
    case 'L':
      $linkToggle.click();
      break;
    case 'h':
    case 'H':
      document.getElementById('hull-toggle-btn').click();
      break;
    case 'm':
    case 'M':
      document.getElementById('minimap-toggle-btn').click();
      break;
    case 'g':
    case 'G':
      document.getElementById('layouts-btn').click();
      break;
  }
});

// Help modal
document.getElementById('help-btn').addEventListener('click', () => {
  document.getElementById('help-overlay').classList.toggle('visible');
});
document.getElementById('help-close').addEventListener('click', () => {
  document.getElementById('help-overlay').classList.remove('visible');
});
document.getElementById('help-overlay').addEventListener('click', (e) => {
  if (e.target.id === 'help-overlay') e.target.classList.remove('visible');
});

// ═══════════════════════════════════════════
// VIEW SWITCHING (2D ↔ 3D)
// ═══════════════════════════════════════════
document.querySelector('.view-toggle-btn:not(.active)').addEventListener('click', (e) => {
  e.preventDefault();
  if (selectedNodeId) {
    sessionStorage.setItem('neural-selected-node-switch', selectedNodeId);
  }
  window.location.href = e.target.getAttribute('href');
});

// ═══════════════════════════════════════════
// SETTINGS (minimal 2D variant)
// ═══════════════════════════════════════════
document.getElementById('settings-btn').addEventListener('click', openSettings);
document.getElementById('titlebar-settings-btn').addEventListener('click', openSettings);

function openSettings() {
  const existing = document.getElementById('settings-panel');
  if (existing) { existing.remove(); return; }

  const panel = document.createElement('div');
  panel.id = 'settings-panel';
  panel.className = 'glass';
  panel.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:440px;max-height:75vh;z-index:500;padding:20px;overflow-y:auto;border-radius:12px;';

  panel.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <h3 style="margin:0;color:var(--t-primary)">Settings</h3>
      <button id="settings-close" style="background:none;border:none;color:var(--t-muted);font-size:18px;cursor:pointer">&times;</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap" id="settings-tabs">
      <button class="bar-pill active" data-tab="graphics">Graphics</button>
      <button class="bar-pill" data-tab="connection">Connection</button>
      <button class="bar-pill" data-tab="hooks">Hooks</button>
    </div>
    <div id="settings-content"></div>
  `;

  document.body.appendChild(panel);

  function renderTab(tab) {
    const content = document.getElementById('settings-content');
    panel.querySelectorAll('#settings-tabs .bar-pill').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));

    if (tab === 'graphics') {
      content.innerHTML = `
        <div class="settings-group">
          <label>Link Opacity: <span data-val="linkOpacity">${gfx.linkOpacity.toFixed(2)}</span></label>
          <input type="range" data-key="linkOpacity" min="0" max="1" step="0.01" value="${gfx.linkOpacity}" style="width:100%">
        </div>
        <div class="settings-group">
          <label>Node Size Multiplier: <span data-val="nodeSizeMultiplier">${gfx.nodeSizeMultiplier.toFixed(1)}</span></label>
          <input type="range" data-key="nodeSizeMultiplier" min="0.5" max="3" step="0.1" value="${gfx.nodeSizeMultiplier}" style="width:100%">
        </div>
        <div class="settings-group">
          <label>Label Threshold (importance \u2265): <span data-val="labelThreshold">${gfx.labelThreshold}</span></label>
          <input type="range" data-key="labelThreshold" min="1" max="10" step="1" value="${gfx.labelThreshold}" style="width:100%">
        </div>
        <div class="settings-group">
          <label>Hull Opacity: <span data-val="hullOpacity">${gfx.hullOpacity.toFixed(2)}</span></label>
          <input type="range" data-key="hullOpacity" min="0" max="0.5" step="0.01" value="${gfx.hullOpacity}" style="width:100%">
        </div>
        <div class="settings-group">
          <label><input type="checkbox" data-key="bgDotGrid" ${gfx.bgDotGrid ? 'checked' : ''}> Show background dot grid</label>
        </div>
      `;

      content.querySelectorAll('input[type="range"]').forEach(input => {
        input.addEventListener('input', () => {
          const key = input.dataset.key;
          gfx[key] = parseFloat(input.value);
          const valSpan = content.querySelector(`[data-val="${key}"]`);
          if (valSpan) valSpan.textContent = parseFloat(input.step) < 1 ? gfx[key].toFixed(2) : gfx[key];
          saveGfxConfig(gfx);
        });
      });

      content.querySelectorAll('input[type="checkbox"]').forEach(input => {
        input.addEventListener('change', () => {
          gfx[input.dataset.key] = input.checked;
          saveGfxConfig(gfx);
        });
      });
    } else if (tab === 'connection') {
      content.innerHTML = `
        <div style="color:var(--t-secondary);font-size:13px">
          <p>Server API endpoint: <code style="color:var(--t-primary)">${window.location.origin}/api</code></p>
          <p>Connection settings are managed in the SynaBun server configuration.</p>
        </div>
      `;
    } else if (tab === 'hooks') {
      content.innerHTML = `
        <div style="color:var(--t-secondary);font-size:13px">
          <p>Claude Code hooks are managed via the SynaBun MCP server configuration.</p>
          <p>See the <code>hooks/</code> directory in your SynaBun installation.</p>
        </div>
      `;
    }
  }

  panel.querySelectorAll('#settings-tabs .bar-pill').forEach(btn => {
    btn.addEventListener('click', () => renderTab(btn.dataset.tab));
  });

  panel.querySelector('#settings-close').addEventListener('click', () => panel.remove());
  renderTab('graphics');
}

// ═══════════════════════════════════════════
// PANEL DRAG + RESIZE (from 3D)
// ═══════════════════════════════════════════
(function initPanelDrag() {
  let dragging = null;
  let startX, startY, startLeft, startTop;

  document.addEventListener('pointerdown', (e) => {
    const handle = e.target.closest('[data-drag]');
    if (!handle) return;
    const panelId = handle.dataset.drag;
    const panel = document.getElementById(panelId);
    if (!panel) return;
    e.preventDefault();
    dragging = panel;
    startX = e.clientX;
    startY = e.clientY;
    const rect = panel.getBoundingClientRect();
    startLeft = rect.left;
    startTop = rect.top;
    panel.style.transition = 'none';
  });

  document.addEventListener('pointermove', (e) => {
    if (!dragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    dragging.style.left = (startLeft + dx) + 'px';
    dragging.style.top = (startTop + dy) + 'px';
    dragging.style.right = 'auto';
  });

  document.addEventListener('pointerup', () => {
    if (!dragging) return;
    dragging.style.transition = '';
    // Save position
    const id = dragging.id;
    localStorage.setItem('neural-panel-' + id, JSON.stringify({
      left: dragging.style.left,
      top: dragging.style.top,
    }));
    dragging = null;
  });
})();

// Panel resize
(function initPanelResize() {
  let resizing = null;
  let handle = null;
  let startX, startY, startRect;

  document.addEventListener('pointerdown', (e) => {
    const h = e.target.closest('[data-resize]');
    if (!h) return;
    const panel = h.closest('.resizable');
    if (!panel) return;
    e.preventDefault();
    resizing = panel;
    handle = h.dataset.resize;
    startX = e.clientX;
    startY = e.clientY;
    startRect = panel.getBoundingClientRect();
    panel.style.transition = 'none';
  });

  document.addEventListener('pointermove', (e) => {
    if (!resizing) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    if (handle.includes('r')) resizing.style.width = Math.max(200, startRect.width + dx) + 'px';
    if (handle.includes('l')) { resizing.style.width = Math.max(200, startRect.width - dx) + 'px'; resizing.style.left = (startRect.left + dx) + 'px'; }
    if (handle.includes('b')) resizing.style.height = Math.max(100, startRect.height + dy) + 'px';
    if (handle.includes('t')) { resizing.style.height = Math.max(100, startRect.height - dy) + 'px'; resizing.style.top = (startRect.top + dy) + 'px'; }
  });

  document.addEventListener('pointerup', () => {
    if (!resizing) return;
    resizing.style.transition = '';
    resizing = null;
  });
})();

// Pin toggle
document.querySelectorAll('.pin-btn').forEach(btn => {
  const panelId = btn.dataset.pin;
  const panel = document.getElementById(panelId);
  if (!panel) return;
  btn.addEventListener('click', () => {
    panel.classList.toggle('pinned');
    btn.classList.toggle('active');
  });
});

// Start
init();
</script>
</body>
</html>
